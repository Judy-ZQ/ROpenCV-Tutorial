<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>7 图像处理（imgproc模块-PART2） | ROpenCV — R与OpenCV之间的桥梁</title>
<meta name="author" content="zpy">
<meta name="generator" content="bookdown 0.40 with bs4_book()">
<meta property="og:title" content="7 图像处理（imgproc模块-PART2） | ROpenCV — R与OpenCV之间的桥梁">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="7 图像处理（imgproc模块-PART2） | ROpenCV — R与OpenCV之间的桥梁">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141212623-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="7.1 霍夫直线变换 在下图中，蓝色直线垂直于红色直线（\(y=kx+b\)），依据几何关系可知： \[ \begin{aligned} k \times tan(\theta) &amp;= k \times \frac{sin(\theta)}{cos(\theta)}=-1 \Rightarrow k=-\frac{cos(\theta)}{sin(\theta)} \\...">
<meta property="og:description" content="7.1 霍夫直线变换 在下图中，蓝色直线垂直于红色直线（\(y=kx+b\)），依据几何关系可知： \[ \begin{aligned} k \times tan(\theta) &amp;= k \times \frac{sin(\theta)}{cos(\theta)}=-1 \Rightarrow k=-\frac{cos(\theta)}{sin(\theta)} \\...">
<meta name="twitter:description" content="7.1 霍夫直线变换 在下图中，蓝色直线垂直于红色直线（\(y=kx+b\)），依据几何关系可知： \[ \begin{aligned} k \times tan(\theta) &amp;= k \times \frac{sin(\theta)}{cos(\theta)}=-1 \Rightarrow k=-\frac{cos(\theta)}{sin(\theta)} \\...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">ROpenCV — R与OpenCV之间的桥梁</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">前言</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> 简介</a></li>
<li><a class="" href="RBasis.html"><span class="header-section-number">2</span> R基础</a></li>
<li><a class="" href="imagebasis.html"><span class="header-section-number">3</span> OpenCV中的图像矩阵类（Mat）</a></li>
<li><a class="" href="%E5%9B%BE%E5%83%8F%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html"><span class="header-section-number">4</span> 图像基本操作</a></li>
<li><a class="" href="%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97.html"><span class="header-section-number">5</span> 核心功能（核心模块）</a></li>
<li><a class="" href="%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86imgproc%E6%A8%A1%E5%9D%97-part1.html"><span class="header-section-number">6</span> 图像处理（imgproc模块-PART1）</a></li>
<li><a class="active" href="%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86imgproc%E6%A8%A1%E5%9D%97-part2.html"><span class="header-section-number">7</span> 图像处理（imgproc模块-PART2）</a></li>
<li><a class="" href="%E6%91%84%E5%83%8F%E6%9C%BA%E6%A0%87%E5%AE%9A%E5%92%8C%E4%B8%89%E7%BB%B4%E9%87%8D%E5%BB%BAcalib3d%E6%A8%A1%E5%9D%97.html"><span class="header-section-number">8</span> 摄像机标定和三维重建（calib3d模块）</a></li>
<li><a class="" href="d%E7%89%B9%E5%BE%81%E6%A1%86%E6%9E%B6feature2d%E6%A8%A1%E5%9D%97.html"><span class="header-section-number">9</span> 2D特征框架（feature2d模块）</a></li>
<li><a class="" href="%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91io%E4%BB%A5%E5%8F%8Avideo%E6%A8%A1%E5%9D%97.html"><span class="header-section-number">10</span> 视频处理（视频IO以及Video模块）</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/Judy-ZQ/ROpenCV-Tutorial">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="图像处理imgproc模块-part2" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> 图像处理（imgproc模块-PART2）<a class="anchor" aria-label="anchor" href="#%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86imgproc%E6%A8%A1%E5%9D%97-part2"><i class="fas fa-link"></i></a>
</h1>
<div id="霍夫直线变换" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> 霍夫直线变换<a class="anchor" aria-label="anchor" href="#%E9%9C%8D%E5%A4%AB%E7%9B%B4%E7%BA%BF%E5%8F%98%E6%8D%A2"><i class="fas fa-link"></i></a>
</h2>
<p>在下图中，蓝色直线垂直于红色直线（<span class="math inline">\(y=kx+b\)</span>），依据几何关系可知：</p>
<p><span class="math display">\[
\begin{aligned}
k \times tan(\theta) &amp;= k \times \frac{sin(\theta)}{cos(\theta)}=-1 \Rightarrow k=-\frac{cos(\theta)}{sin(\theta)} \\
b&amp;=\frac{r}{sin(\theta)}
\end{aligned}
\]</span></p>
<div class="inline-figure"><img src="images/tutorial/Hough_Lines_Tutorial_Theory_0.jpg" width="143" style="display: block; margin: auto;"></div>
<p>所以：</p>
<p><span class="math display">\[
\begin{aligned}
y=kx+b &amp;\Rightarrow y=\left( -\frac{cos \theta}{sin \theta} \right)x+\left( \frac{r}{sin \theta} \right) \\
&amp;\Rightarrow r=xcos \theta + y sin \theta
\end{aligned}
\]</span></p>
<p>对于<span class="math inline">\(r=xcos \theta + y sin \theta\)</span>，当固定<span class="math inline">\(x\)</span>和<span class="math inline">\(y\)</span>而不断变化<span class="math inline">\(\theta\)</span>的取值时，会得到相应的<span class="math inline">\(r\)</span>的值。若以<span class="math inline">\(\theta\)</span>为横轴，以<span class="math inline">\(r\)</span>为纵轴建立坐标系（简称<span class="math inline">\(\theta-r\)</span>坐标系），然后绘制每一对<span class="math inline">\(\theta\)</span>与<span class="math inline">\(r\)</span>确定的点，则会形成一条曲线。在几何意义上，这条曲线上的每个点(<span class="math inline">\(\theta,r\)</span>)都对应着笛卡尔坐标系下经过点<span class="math inline">\((x,y)\)</span>的一条直线，所以整个曲线也就对应对笛卡尔坐标系下经过点<span class="math inline">\((x,y)\)</span>的所有直线。</p>
<p>以直线<span class="math inline">\(\displaystyle y = -\frac{3}{4}x+12\)</span>为例，点(8,6)在这条直线上，则在<span class="math inline">\(\theta-r\)</span>坐标系下，<span class="math inline">\(r=8 cos \theta+6 sin \theta\)</span>对应的曲线如下图所示（只考虑满足<span class="math inline">\(r&gt;0\)</span>和<span class="math inline">\(0&lt;\theta&lt;2 \pi\)</span>的点）：</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-3-1.png" width="672"></div>
<p>图中红色小圆标注的点对应于直角坐标系下的点(8,6)。</p>
<p>类似地，我们还可以在直线<span class="math inline">\(\displaystyle y = -\frac{3}{4}x+12\)</span>再找两个点，比如(4,9)和(12,3)，然后在<span class="math inline">\(\theta-r\)</span>坐标系下，绘制<span class="math inline">\(r=4 cos \theta+9 sin \theta\)</span>和<span class="math inline">\(r=12 cos \theta+3 sin \theta\)</span>对应的曲线。</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-4-1.png" width="672"></div>
<p>从图中可以看出，三条曲线有交点<span class="math inline">\(\displaystyle \left( arctan \left( \frac{4}{3} \right),9.6 \right)\)</span>，而该点对应于直角坐标系的点<span class="math inline">\(\displaystyle \left( 9.6 \times cos \left( arctan \left( \frac{4}{3} \right) \right)=5.76,\;9.6 \times sin \left( arctan \left( \frac{4}{3} \right) \right)=7.68 \right)\)</span>也在直线<span class="math inline">\(\displaystyle y = -\frac{3}{4}x+12\)</span>上。</p>
<p>总结而言，这个现象背后的结论是：在笛卡尔坐标系下，经过一点(x,y)的所有直线可以在<span class="math inline">\(\theta-r\)</span>坐标系下用一条曲线<span class="math inline">\(r=xcos \theta + y sin \theta\)</span>表示。而在<span class="math inline">\(\theta-r\)</span>坐标系下，若有<span class="math inline">\(n\)</span>条曲线相交于一点，则表明存在<span class="math inline">\(n\)</span>个点共线，当<span class="math inline">\(n\)</span>越大，表示该交点所代表的直线上有越多的点，则越能相信<span class="math inline">\(n\)</span>点确定的直线“存在”。OpenCV使用该结论形成了霍夫直线变换方法，用来检测图像中存在的直线。它在<span class="math inline">\(\theta-r\)</span>坐标系下每个点的曲线相交情况。如果某点上的交叉曲线的数量高于某个阈值，则它将其确定为由<span class="math inline">\((\theta,r)\)</span>确定的直线。</p>
<p>OpenCV实现了两种霍夫直线变换：</p>
<ul>
<li>标准霍夫直线变换函数<strong>cv.HoughLines</strong>，它会返回一组参数<span class="math inline">\((\theta,r,votes)\)</span><br>
</li>
<li>概率霍夫直线变换函数<strong>cv.HoughLinesP</strong>，它会返回检测到的直线的两个端点坐标<span class="math inline">\((x0,y0,x1,y1)\)</span>
</li>
</ul>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按灰度图模式读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/abox02.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co">#用Canny算子获取边缘，结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">src</span>,<span class="va">dst</span>,<span class="fl">50</span>,<span class="fl">20</span>,<span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对dst进行霍夫直线变换检测直线（设置阈值为100），结果保存在llines中</span></span>
<span><span class="co">#每组的votes表明有多少条曲线交于rho和theta确定的点</span></span>
<span><span class="va">llines</span> <span class="op">=</span> <span class="fu">stdVecOfVec2f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_HoughLines</span><span class="op">(</span><span class="va">dst</span>,<span class="va">llines</span>,<span class="fl">1</span>,<span class="va">pi</span><span class="op">/</span><span class="fl">180</span>,<span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">llines</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 16</code></pre>
<div class="sourceCode" id="cb1109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#基于llines形成数据框，并计算每条曲线上的固定点坐标</span></span>
<span><span class="va">daf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>rho<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">llines</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,theta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">llines</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">daf</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">daf</span><span class="op">$</span><span class="va">rho</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">llines</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span></span>
<span>  <span class="va">daf</span><span class="op">$</span><span class="va">theta</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">llines</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">daf</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="va">daf</span><span class="op">$</span><span class="va">rho</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">daf</span><span class="op">$</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">daf</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="va">daf</span><span class="op">$</span><span class="va">rho</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">daf</span><span class="op">$</span><span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">daf</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">src</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">daf</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">daf</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,<span class="fl">5</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'src'</span>,<span class="va">src</span><span class="op">)</span></span>
<span><span class="co"># 为何找到的点与想象中不一样</span></span>
<span><span class="co"># 找到的点，是确定存在直线经过的点</span></span></code></pre></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#以灰度模式读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/sudoku.png"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co">#用Canny算子获取边缘，结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">src</span>,<span class="va">dst</span>,<span class="fl">50</span>,<span class="fl">20</span>,<span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将dst转变为三通道彩色图，保存在cdst中</span></span>
<span><span class="va">cdst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">dst</span>,<span class="va">cdst</span>,<span class="va">COLOR_GRAY2BGR</span><span class="op">)</span></span>
<span><span class="co">#克隆cdst，形成克隆体cdstP</span></span>
<span><span class="va">cdstP</span> <span class="op">=</span> <span class="va">cdst</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对dst进行霍夫直线变换检测直线（设置阈值为150），结果保存在llines中</span></span>
<span><span class="va">llines</span> <span class="op">=</span> <span class="fu">stdVecOfVec2f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_HoughLines</span><span class="op">(</span><span class="va">dst</span>,<span class="va">llines</span>,<span class="fl">1</span>,<span class="va">pi</span><span class="op">/</span><span class="fl">180</span>,<span class="fl">150</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在cdst中绘制各条直线</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">llines</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#取出一条直线对应的rho和theta</span></span>
<span>  <span class="va">rho</span><span class="op">=</span><span class="va">llines</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span></span>
<span>  <span class="va">theta</span><span class="op">=</span><span class="va">llines</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="co">#计算theta的余弦和正弦值，分别存入a，b中</span></span>
<span>  <span class="va">a</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span>  <span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span>  <span class="co">#计算x0,y0</span></span>
<span>  <span class="va">x0</span><span class="op">=</span><span class="va">rho</span><span class="op">*</span><span class="va">a</span></span>
<span>  <span class="va">y0</span><span class="op">=</span><span class="va">rho</span><span class="op">*</span><span class="va">b</span></span>
<span>  <span class="co">#通过x0,y0计算待绘制直线上的两个点</span></span>
<span>  <span class="va">pt1</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pt2</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pt1</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">x0</span><span class="op">+</span><span class="fl">1000</span><span class="op">*</span><span class="op">(</span><span class="op">-</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pt1</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">y0</span><span class="op">+</span><span class="fl">1000</span><span class="op">*</span><span class="va">a</span><span class="op">)</span></span>
<span>  <span class="va">pt2</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">x0</span><span class="op">-</span><span class="fl">1000</span><span class="op">*</span><span class="op">(</span><span class="op">-</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pt2</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">y0</span><span class="op">-</span><span class="fl">1000</span><span class="op">*</span><span class="va">a</span><span class="op">)</span></span>
<span>  <span class="co">#绘制直线</span></span>
<span>  <span class="fu">cv_line</span><span class="op">(</span><span class="va">cdst</span>,<span class="va">pt1</span>,<span class="va">pt2</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">3</span>,<span class="va">LINE_AA</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#对dst进行霍夫直线概率变换检测直线（设置阈值为150），结果保存在linesP中</span></span>
<span><span class="va">linesP</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_HoughLinesP</span><span class="op">(</span><span class="va">dst</span>,<span class="va">linesP</span>,<span class="fl">1</span>,<span class="va">pi</span><span class="op">/</span><span class="fl">180</span>,<span class="fl">50</span>,<span class="fl">50</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#在cdstP中绘制各条直线</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">linesP</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">l</span> <span class="op">=</span> <span class="va">linesP</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu">cv_line</span><span class="op">(</span><span class="va">cdstP</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">l</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>,<span class="va">l</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">l</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="va">l</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">3</span>,<span class="va">LINE_AA</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#显示结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Source"</span>, <span class="va">src</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Detected Lines (in red) - Standard Hough Line Transform"</span>, <span class="va">cdst</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Detected Lines (in red) - Probabilistic Line Transform"</span>, <span class="va">cdstP</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-8-1.png" width="672"></div>
</div>
<div id="霍夫圆变换" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> 霍夫圆变换<a class="anchor" aria-label="anchor" href="#%E9%9C%8D%E5%A4%AB%E5%9C%86%E5%8F%98%E6%8D%A2"><i class="fas fa-link"></i></a>
</h2>
<p>霍夫圆变换的工作方式大致上类似于霍夫直线变换。二者的一个明显区别在于：在直线检测情况下，只需两个参数<span class="math inline">\(\theta\)</span>和<span class="math inline">\(r\)</span>来确定一条直线. 而在圆检测情况下，需要三个参数<span class="math inline">\(x_{center},y_{center},r\)</span>来定义一个圆（如下图所示），其中<span class="math inline">\((x_{center},y_{center}\)</span>定义了中心位置（绿点），r是半径。</p>
<div class="inline-figure"><img src="images/tutorial/Hough_Circle_Tutorial_Theory_0.jpg" width="100" style="display: block; margin: auto;"></div>
<!-- 为了提高效率，OpenCV实现了一种比标准Hough变换稍微复杂的检测方法：Hough梯度法，它由两个主要阶段组成。第一阶段是边缘检测和寻找可能的圆心，第二阶段是寻找每个候选圆心的最佳半径。 -->
<p>OpenCV将霍夫圆变换封装在了<strong>HoughCircles</strong>函数中。</p>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/smarties.png"</span><span class="op">)</span></span>
<span><span class="co">#将src灰度化，结果保存在gray中</span></span>
<span><span class="va">gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">src</span>,<span class="va">gray</span>,<span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span><span class="co">#对gray进行平滑（使用中位数滤波器），结果保存在blured中</span></span>
<span><span class="va">blured</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_medianBlur</span><span class="op">(</span><span class="va">gray</span>,<span class="va">blured</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#获取blured的基本信息</span></span>
<span><span class="va">blured_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">blured</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对blured进行霍夫圆变换检测圆，</span></span>
<span><span class="co">#检测时两个圆的圆心距离不得低于图像高度的1/16</span></span>
<span><span class="co">#待检测的圆的最小半径为1，最大半径为30，</span></span>
<span><span class="co">#结果保存在circles中，</span></span>
<span><span class="va">circles</span> <span class="op">=</span> <span class="fu">stdVecOfVec3f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_HoughCircles</span><span class="op">(</span><span class="va">blured</span>,<span class="va">circles</span>,<span class="va">HOUGH_GRADIENT</span>,<span class="fl">1</span>,</span>
<span>                <span class="va">blured_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">16</span>,<span class="fl">100</span>,<span class="fl">30</span>,<span class="fl">1</span>,<span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在src上绘制检测出的各个圆</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">circles</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">cir</span> <span class="op">=</span> <span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">center</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="va">cir</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>,<span class="va">cir</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">src</span>,<span class="va">center</span>,<span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span>,<span class="fl">3</span>,<span class="va">LINE_AA</span><span class="op">)</span></span>
<span>  <span class="va">radius</span> <span class="op">=</span> <span class="va">cir</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">src</span>,<span class="va">center</span>,<span class="va">radius</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">3</span>,<span class="va">LINE_AA</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#显示结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"detected circles"</span>,<span class="va">src</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-11-1.png" width="672"></div>
</div>
<div id="重映射" class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> 重映射<a class="anchor" aria-label="anchor" href="#%E9%87%8D%E6%98%A0%E5%B0%84"><i class="fas fa-link"></i></a>
</h2>
<p>重映射指的是依据源图像与目标图像之间的像素位置映射关系，将原图像一个位置上的像素放置到目标图像中的对应位置。像素位置映射关系可以通过两个矩阵来指定：一个矩阵表示原图像像素的横坐标（即列位置），可称之为像素横坐标映射矩阵；另一矩阵表示原图像像素的纵坐标（即行位置），可称之为像素纵坐标映射矩阵。</p>
<p>比如，有一个3行3列的图像矩阵<span class="math inline">\(I\)</span>：</p>
<div class="inline-table"><table class="table table-sm"><tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">4</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">5</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">6</td>
<td align="right">9</td>
</tr>
</tbody></table></div>
<p>像素横坐标映射矩阵（map_x）为：</p>
<div class="inline-table"><table class="table table-sm"><tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody></table></div>
<p>像素纵坐标映射矩阵（map_y）为：</p>
<div class="inline-table"><table class="table table-sm"><tbody>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2</td>
</tr>
</tbody></table></div>
<p>则对<span class="math inline">\(I\)</span>进行重映射时，相应的操作可以理解为：</p>
<ul>
<li>由于map.x的第1行第1列元素为1（即像素横坐标为2），map.y的第1行第1列元素为2（即像素纵坐标为3），所以把<span class="math inline">\(I\)</span>的第3行第2列元素6放置在目标图像的第1行第1列；<br>
</li>
<li>由于map.x的第1行第2列元素为0（即像素横坐标为1），map.y的第1行第2列元素为0（即像素纵坐标为1），所以把<span class="math inline">\(I\)</span>的第1行第1列元素1放置在目标图像的第1行第2列；<br>
</li>
<li>由于map.x的第1行第3列元素为2（即像素横坐标为3），map.y的第1行第3列元素为0（即像素纵坐标为1），所以把<span class="math inline">\(I\)</span>的第1行第3列元素7放置在目标图像的第1行第3列；<br>
</li>
<li>以此类推</li>
</ul>
<p>所以，重映射完成后，结果为：</p>
<div class="inline-table"><table class="table table-sm"><tbody>
<tr class="odd">
<td align="right">6</td>
<td align="right">1</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">8</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">2</td>
<td align="right">3</td>
</tr>
</tbody></table></div>
<p>在重映射过程中，当源图像和目标图像的像素不存在一一对应关系是，可能需要对非整数像素位置进行一些插值。</p>
<p>OpenCV将重映射操作封装在了<strong>remap</strong>函数中。</p>
<p><strong>示例</strong></p>
<p>通过重映射，实现图像左右翻转效果：</p>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成像素横坐标映射矩阵mapx，第i列元素的值都为img_info$width-i</span></span>
<span><span class="va">mapx_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">:</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span>,each<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="va">mapx</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapx</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span></span>
<span><span class="co">#生成像素纵坐标映射矩阵mapy，第i行元素的值都为i-1</span></span>
<span><span class="va">mapy_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span><span class="fl">1</span>,times<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="va">mapy</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapy</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_DEFAULT，</span></span>
<span><span class="co">#结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_DEFAULT</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-17-1.png" width="672"></div>
<p>通过重映射，实现图像上下翻转效果：</p>
<div class="sourceCode" id="cb1113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成像素横坐标映射矩阵mapx，第i列元素的值都为 i-1</span></span>
<span><span class="va">mapx_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span> <span class="op">-</span> <span class="fl">1</span>,each<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="va">mapx</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapx</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span></span>
<span><span class="co">#生成像素纵坐标映射矩阵mapy，第i行元素的值都为 img.info$height-i</span></span>
<span><span class="va">mapy_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">:</span><span class="fl">1</span> <span class="op">-</span><span class="fl">1</span>,times<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="va">mapy</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapy</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_DEFAULT，</span></span>
<span><span class="co">#结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_DEFAULT</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-19-1.png" width="672"></div>
<p>通过重映射，使得目标图像仅取源图像左上角的1/4部分：</p>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成像素横坐标映射矩阵mapx，第i列元素的值都为 i-1</span></span>
<span><span class="va">mapx_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span> <span class="op">-</span> <span class="fl">1</span>,each<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="co">#生成像素纵坐标映射矩阵mapy，第i行元素的值都为 img_info$height-i</span></span>
<span><span class="va">mapy_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span><span class="fl">1</span>,times<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#mapx右半部分的值都加上原图像宽度的1/2，而mapy下半部分的值都加上原图像高度的1/2，</span></span>
<span><span class="co">#如此一来，目标图像中仅有左上角1/4的像素与原图像左上角1/4的像素有对应关系</span></span>
<span><span class="va">mapx_mat</span><span class="op">[</span>,<span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">]</span> <span class="op">=</span> </span>
<span>  <span class="va">mapx_mat</span><span class="op">[</span>,<span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">]</span> <span class="op">+</span> <span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="va">mapx</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapx</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span></span>
<span><span class="va">mapy_mat</span><span class="op">[</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="op">]</span> <span class="op">=</span></span>
<span>  <span class="va">mapy_mat</span><span class="op">[</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="op">]</span> <span class="op">+</span> <span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="va">mapy</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapy</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_CONSTANT，扩展像素值为黑色(0,0,0)</span></span>
<span><span class="co">#结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_CONSTANT</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-21-1.png" width="672"></div>
<p>通过重映射，使得目标图像仅取源图像右上角的1/4部分和左下角的1/4部分：</p>
<div class="sourceCode" id="cb1115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成像素横坐标映射矩阵mapx_mat，第i列元素的值都为 i-1</span></span>
<span><span class="va">mapx_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span> <span class="op">-</span> <span class="fl">1</span>,each<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="co">#生成像素纵坐标映射矩阵mapy_mat，第i行元素的值都为 img_info$height-i</span></span>
<span><span class="va">mapy_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span><span class="fl">1</span>,times<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#mapx_mat左上角1/4的元素都变为-1，mapy_mat右下角1/4的元素也变为-1，</span></span>
<span><span class="va">mapx_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="va">mapx</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapx</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span></span>
<span><span class="va">mapy_mat</span><span class="op">[</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="va">mapy</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapy</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_CONSTANT，扩展像素值为黑色(0,0,0)</span></span>
<span><span class="co">#结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_CONSTANT</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-23-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成像素横坐标映射矩阵mapx_mat，第i列元素的值都为i-1</span></span>
<span><span class="va">mapx_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span> <span class="op">-</span> <span class="fl">1</span>,each<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="co">#生成像素纵坐标映射矩阵mapy_mat，第i行元素的值都为i-1</span></span>
<span><span class="va">mapy_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span><span class="fl">1</span>,times<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,</span>
<span>              nr<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,nc<span class="op">=</span><span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#mapx的所有值加上原图像宽度的1/2，而mapy的所有值都加上原图像高度的1/2，</span></span>
<span><span class="co">#如此一来，目标图像中仅有左上角1/4的像素与原图像右下角1/4的像素有对应关系</span></span>
<span><span class="va">mapx_mat</span> <span class="op">=</span> <span class="va">mapx_mat</span> <span class="op">+</span> <span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="va">mapx</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapx</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapx_mat</span><span class="op">)</span></span>
<span><span class="va">mapy_mat</span> <span class="op">=</span> <span class="va">mapy_mat</span> <span class="op">+</span> <span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="va">mapy</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="va">mapy</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">mapy_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_CONSTANT，扩展像素值都为(128,128,128)，</span></span>
<span><span class="co">#结果保存在dst_constant中</span></span>
<span><span class="va">dst_constant</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst_constant</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_DEFAULT</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">128</span>,<span class="fl">128</span>,<span class="fl">128</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_REPLICATE，</span></span>
<span><span class="co">#结果保存在dst_replicate中</span></span>
<span><span class="va">dst_replicate</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst_replicate</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_REPLICATE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_REFLECT，</span></span>
<span><span class="co">#结果保存在dst_reflect中</span></span>
<span><span class="va">dst_reflect</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst_reflect</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_REFLECT</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_WRAP，</span></span>
<span><span class="co">#结果保存在dst_wrap中</span></span>
<span><span class="va">dst_wrap</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst_wrap</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_WRAP</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行重映射，</span></span>
<span><span class="co">#插值方式为INTER_NEAREST，</span></span>
<span><span class="co">#边缘扩展方式为BORDER_DEFAULT，</span></span>
<span><span class="co">#结果保存在dst_default中</span></span>
<span><span class="va">dst_default</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_remap</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst_default</span>,<span class="va">mapx</span>,<span class="va">mapy</span>,<span class="va">INTER_NEAREST</span>,<span class="va">BORDER_DEFAULT</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-25-1.png" width="672"></div>
</div>
<div id="直方图计算" class="section level2" number="7.4">
<h2>
<span class="header-section-number">7.4</span> 直方图计算<a class="anchor" aria-label="anchor" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E8%AE%A1%E7%AE%97"><i class="fas fa-link"></i></a>
</h2>
<p>对于一个8位单通道图像矩阵，其像素取值范围在0到255之间，这时可以将这个范围划分成<span class="math inline">\(n,1\le n  \le256\)</span>个紧挨但不交叉的区间<span class="math inline">\(b_1,b_2,\dots,b_n\)</span>，然后依据像素值统计位于各个区间的像素个数，形成一个频数统计表，常称这样形成的表为直方图，在图形化展示方面，直方图的常见效果形如下图。</p>
<div class="inline-figure"><img src="images/tutorial/Histogram_Calculation_Theory_Hist1.jpg"></div>
<p>OpenCV在<strong>calcHist</strong>函数中封装了直方图计算操作。</p>
<p><strong>示例</strong></p>
<p>以下代码演示了如何使用该函数计算8位无符号单通道图像矩阵的直方图。</p>
<div class="sourceCode" id="cb1117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#查看矩阵m中各个元素出现的次数</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">m_mat</span><span class="op">)</span></span></code></pre></div>
<pre><code>## m_mat
##  0  1  2  3  4  5  6  7 
## 19 25 21 16  8  6  3  2</code></pre>
<div class="sourceCode" id="cb1119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#将m转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">m_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用calcHist函数（第三个重载形式）计算img的直方图，结果保存在hist中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span> <span class="co">#指定划分区间个数</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="co">#指定划分区间的最大端点值（这种方式表明划分区间是等长度的）</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>, <span class="co">#由于是单通道，所以只能指定为0</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hist</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hist</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   [1] 19 25 21 16  8  6  3  2  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
##  [26]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
##  [51]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
##  [76]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [101]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [126]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [151]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [176]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [201]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [226]  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
## [251]  0  0  0  0  0  0</code></pre>
<p>从结果可以看出，0-7这8个数出现的频数依次为19,25,21,16,8,6,3和2，其余数出现的频数都为0，这与预期一致。</p>
<p>类似地，可以计算三通道图像的每个通道（即蓝色分量矩阵、绿色分量矩阵和红色分量矩阵）的直方图：</p>
<div class="sourceCode" id="cb1121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#形成一个3维全0数组</span></span>
<span><span class="va">arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>,dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#将arr包含的3个10行10列矩阵都更改为m</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span></span>
<span></span>
<span><span class="co">#将arr转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">arr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span> <span class="co">#指定划分区间个数</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="co">#指定划分区间的最大端点值（这种方式表明划分区间是等长度的）</span></span>
<span></span>
<span><span class="co">#使用calcHist函数（第三个重载形式）计算img三个通道的直方图，</span></span>
<span><span class="co">#结果分别保存在hist_blue、hist_green和hist_red中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">hist_blue</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>, <span class="co">#针对第1个通道，即蓝色分量矩阵计算直方图</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hist_blue</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">hist_green</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>, <span class="co">#针对第2个通道，即绿色分量矩阵计算直方图</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hist_green</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">hist_red</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>, <span class="co">#针对第3个通道，即红色分量矩阵计算直方图</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hist_red</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看三个通道的直方图</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hist_blue</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 19 25 21 16  8  6  3  2</code></pre>
<div class="sourceCode" id="cb1123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hist_green</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 19 25 21 16  8  6  3  2</code></pre>
<div class="sourceCode" id="cb1125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hist_red</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 19 25 21 16  8  6  3  2</code></pre>
<p>从结果可以看出，0-7这8个数在三个通道上出现的频数依次都是19,25,21,16,8,6,3和2，这与预期一致。</p>
<p><strong>示例</strong></p>
<p>已知一个手部图像和相应的遮罩图像：</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-29-1.png" width="672"></div>
<p>而遮罩图像中的白色区域大致覆盖了整个手部：</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-30-1.png" width="672"></div>
<p>可以通过如下代码计算遮罩图像白色区域对应的手部图像的色调-饱和度直方图：</p>
<div class="sourceCode" id="cb1127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_0.jpg"</span><span class="op">)</span></span>
<span><span class="co">#读取遮罩图像文件</span></span>
<span><span class="va">mask</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_0_mask.png"</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将img转变为HSV三通道图像矩阵</span></span>
<span><span class="va">img_hsv</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_hsv</span>,<span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在遮罩矩阵作用下计算img.hsv的色调-饱和度直方图，结果保存在hhist中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img_hsv</span><span class="op">)</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">hhist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span> <span class="co">#指定H通道的划分区间个数</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span> <span class="co">#指定S通道的划分区间个数</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定H通道划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span><span class="co">#指定H通道划分区间的最大端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定S通道划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="co">#指定S通道划分区间的最大端点值</span></span>
<span><span class="fu">cv_calcHist03</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对H通道和S通道计算直方图 </span></span>
<span>              <span class="va">mask</span>, <span class="co">#遮罩矩阵</span></span>
<span>              <span class="va">hhist</span>,</span>
<span>              <span class="va">histSize</span>, </span>
<span>              <span class="va">histRange</span> </span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#对hhist进行归一化（最大最小值方式），以便可视化展示</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">hhist</span>,<span class="va">hhist</span>,norm_type <span class="op">=</span> <span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'hist'</span>,<span class="va">hhist</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-32-1.png" width="672"></div>
<p><strong>示例</strong></p>
<p>在实际应用中，OpenCV的<strong>cv::calcHist</strong>函数还可以同时依据两个通道计算直方图，这种直方图可以被称为双通道直方图，而上面只针对一个通道计算的结果是单通道直方图。</p>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#再对x随机排序后,转变为10行10列矩阵m2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#继续对x随机排序后,转变为10行10列矩阵m3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">125</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#形成一个3维全0数组</span></span>
<span><span class="va">arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>,dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#将arr包含的3个10行10列矩阵分别改为m1,m2和m3</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">m1</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">m2</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">m3</span></span>
<span></span>
<span><span class="co">#将m转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">arr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用calcHist函数（第三个重载形式）计算img的双通道直方图，结果保存在hist中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span> <span class="co">#指定1个通道的划分区间个数</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="co">#指定2个通道的划分区间个数</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定1个通道划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="co">#指定1个通道划分区间的最大端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定2个通道划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="co">#指定2个通道划分区间的最大端点值</span></span>
<span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个和第2个通道计算直方图 </span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hist</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">hist</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4]
## [1,]    9    6    2    2
## [2,]   15    7    2    1
## [3,]    7   12    2    0
## [4,]    6    5    4    1
## [5,]    2    4    2    0
## [6,]    3    1    1    1
## [7,]    2    1    0    0
## [8,]    0    1    1    0
## attr(,"depth")
## [1] 5</code></pre>
<p>结果表明：</p>
<ul>
<li>第1行第1列的元素为9，表明图像矩阵img中有9个像素满足：其蓝色分量位于8个划分区间中的第1个，且其绿色分量位于4个划分区间中的第1个；<br>
</li>
<li>第1行第2列的元素为6，表明图像矩阵img中有6个像素满足：其蓝色分量位于8个划分区间中的第1个，且其绿色分量位于4个划分区间中的第2个；<br>
</li>
<li>第1行第3列的元素为2，表明图像矩阵img中有2个像素满足：其蓝色分量位于8个划分区间中的第1个，且其绿色分量位于4个划分区间中的第3个；<br>
</li>
<li>第1行第4列的元素为2，表明图像矩阵img中有2个像素满足：其蓝色分量位于8个划分区间中的第1个，且其绿色分量位于4个划分区间中的第4个；</li>
<li>以此类推。</li>
</ul>
<p>同时也可以看到，当对矩阵按行求和时，结果依次为19,25,21,16,8,6,3和2，这正好是蓝色分量矩阵中0-7这8个数出现的频次数。</p>
<p>这个双通道直方图计算结果，还可以通过如下代码来验证：</p>
<div class="sourceCode" id="cb1130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#再对x随机排序后,转变为10行10列矩阵m2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#继续对x随机排序后,转变为10行10列矩阵m3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">125</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将m1的元素划分为8个区间（左闭右开型区间）</span></span>
<span><span class="va">zone_1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">m1</span>,breaks <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">8</span>,right <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#将m2的元素划分为4个区间（左闭右开型区间）</span></span>
<span><span class="va">zone_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">m2</span>,breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">8</span>,by<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,right <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#统计频数（以m1的划分区间为行，以m2的划分区间为列）</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">zone_1</span>,<span class="va">zone_2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##        zone_2
## zone_1  [0,2) [2,4) [4,6) [6,8)
##   [0,1)     9     6     2     2
##   [1,2)    15     7     2     1
##   [2,3)     7    12     2     0
##   [3,4)     6     5     4     1
##   [4,5)     2     4     2     0
##   [5,6)     3     1     1     1
##   [6,7)     2     1     0     0
##   [7,8)     0     1     1     0</code></pre>
<p><strong>示例</strong></p>
<p>以下代码演示了如何通过R语言的hist函数来绘制图像矩阵的直方图：</p>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#用split函数分离图像矩阵的通道，结果保存在bgr_planes中</span></span>
<span><span class="va">bgr_planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">cv_split</span><span class="op">(</span><span class="va">src</span>, <span class="va">bgr_planes</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将bgr_planes中的三个图像矩阵转变为R语言的矩阵</span></span>
<span><span class="va">b_mat</span> <span class="op">=</span> <span class="va">bgr_planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g_mat</span> <span class="op">=</span> <span class="va">bgr_planes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r_mat</span> <span class="op">=</span> <span class="va">bgr_planes</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#用hist函数绘制三个b.mat、g.mat和r.mat的直方图(划分区间数都为256个)</span></span>
<span><span class="va">op</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">b_mat</span>,breaks<span class="op">=</span><span class="fl">256</span>,col<span class="op">=</span><span class="st">"blue"</span>,main<span class="op">=</span><span class="st">"蓝色分量矩阵直方图"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">g_mat</span>,breaks<span class="op">=</span><span class="fl">256</span>,col<span class="op">=</span><span class="st">"green"</span>,main<span class="op">=</span><span class="st">"绿色分量矩阵直方图"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">r_mat</span>,breaks<span class="op">=</span><span class="fl">256</span>,col<span class="op">=</span><span class="st">"red"</span>,main<span class="op">=</span><span class="st">"红色分量矩阵直方图"</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-35-1.png" width="672"></div>
<div class="sourceCode" id="cb1133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span></span></code></pre></div>
<p>进一步，可以依据直方图绘制图像像素强度的密度曲线图：</p>
<div class="sourceCode" id="cb1134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#用split函数分离图像矩阵的通道，结果保存在bgr_planes中</span></span>
<span><span class="va">bgr_planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">cv_split</span><span class="op">(</span><span class="va">src</span>, <span class="va">bgr_planes</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将bgr_planes中的三个图像矩阵转变为R语言的矩阵</span></span>
<span><span class="va">b_mat</span> <span class="op">=</span> <span class="va">bgr_planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g_mat</span> <span class="op">=</span> <span class="va">bgr_planes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r_mat</span> <span class="op">=</span> <span class="va">bgr_planes</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#用hist函数计算b_mat、g_mat和r_mat的直方图</span></span>
<span><span class="va">b_ht</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">b_mat</span>,breaks<span class="op">=</span><span class="fl">256</span>,plot<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">g_ht</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">g_mat</span>,breaks<span class="op">=</span><span class="fl">256</span>,plot<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">r_ht</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">r_mat</span>,breaks<span class="op">=</span><span class="fl">256</span>,plot<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依据hist计算结果返回的区间中点和密度值绘制图像强度的密度曲线图</span></span>
<span><span class="co">#首先要获取三个直方图的最大密度值，并放大1.1倍作为纵轴的上限</span></span>
<span><span class="va">ymax</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">b_ht</span><span class="op">$</span><span class="va">density</span>,<span class="va">g_ht</span><span class="op">$</span><span class="va">density</span>,<span class="va">r_ht</span><span class="op">$</span><span class="va">density</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">1.1</span> </span>
<span><span class="co">#绘制蓝色分量矩阵像素强度密度曲线</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">b_ht</span><span class="op">$</span><span class="va">mids</span>,<span class="va">b_ht</span><span class="op">$</span><span class="va">density</span>,type<span class="op">=</span><span class="st">'l'</span>,col<span class="op">=</span><span class="st">"blue"</span>,xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">ymax</span><span class="op">)</span>,main <span class="op">=</span> <span class="st">""</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span>,bty<span class="op">=</span><span class="st">"n"</span>,xaxs<span class="op">=</span><span class="st">"i"</span>,yaxs<span class="op">=</span><span class="st">"i"</span><span class="op">)</span></span>
<span><span class="co">#绘制绿色分量矩阵像素强度密度曲线</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">g_ht</span><span class="op">$</span><span class="va">mids</span>,<span class="va">g_ht</span><span class="op">$</span><span class="va">density</span>,col<span class="op">=</span><span class="st">"green"</span><span class="op">)</span></span>
<span><span class="co">#绘制红色分量矩阵像素强度密度曲线</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">r_ht</span><span class="op">$</span><span class="va">mids</span>,<span class="va">r_ht</span><span class="op">$</span><span class="va">density</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-36-1.png" width="672"></div>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算计算图形的双通道直方图并进行可视化展示：</p>
<div class="sourceCode" id="cb1135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_0.jpg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将img转变为HSV三通道图像矩阵，结果保存在img_hsv中</span></span>
<span><span class="va">img_hsv</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_hsv</span>,<span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用calcHist函数（第三个重载形式）计算img_hsv的双通道直方图，结果保存在hhist中</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span><span class="co">#指定H通道和S通道的直方图划分区间数</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="co">#指定S通道和S通道的直方图划分区间数</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定H通道划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span><span class="co">#指定H通道划分区间的最大端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="co">#指定S通道划分区间的最小端点值</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="co">#指定S通道划分区间的最大端点值 </span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img_hsv</span><span class="op">)</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">hhist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对H通道和S通道计算直方图（即色调-饱和度直方图） </span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hhist</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对hist进行归一化（最大最小值方式），以便可视化展示</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">hhist</span>,<span class="va">hhist</span>,norm_type <span class="op">=</span> <span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'hist'</span>,<span class="va">hhist</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-38-1.png" width="672"></div>
</div>
<div id="直方图均衡化" class="section level2" number="7.5">
<h2>
<span class="header-section-number">7.5</span> 直方图均衡化<a class="anchor" aria-label="anchor" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E5%9D%87%E8%A1%A1%E5%8C%96"><i class="fas fa-link"></i></a>
</h2>
<p>先读取pout.tif图像文件，并绘制其直方图：</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-39-1.png" width="672"></div>
<p>可以看到，直方图主要分布在80-160的范围里，且在这个范围内的分布也很不均匀，所以在视觉上，这个图形的对比度偏弱。</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-40-1.png" width="672"></div>
<p>直方图均衡化可以将图像矩阵的直方图映射成为另一个分布范围更宽、分布更均匀的直方图，进而增强图像的对比度。OpenCV封装的<strong>equalizeHist</strong>函数可以针对8位无符号单通道图像进行直方图均衡化，其主要步骤是：</p>
<ul>
<li>计算图像的直方图（划分区间个数为256，像素取值范围为0-255）；<br>
</li>
<li>对直方图归一化（即直方图除以图像的像素量——图像的高度与宽度的乘积）；<br>
</li>
<li>对归一化的直方图进行累计求和，求和所得的结果常被称为累计直方图或者累计分布图，体现的是图像在对应像素取值处的累计分布值；<br>
</li>
<li>生成与遍历图像的每个像素，依据其取值情况在累计直方图中查询相应的累计分布值，并把这个值作为图像该像素新的取值；<br>
</li>
<li>对图像的像素值进行归一化（最大最小值方式），确保像素值范围为[0,255]区间。</li>
</ul>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#查看矩阵m中各个元素出现的次数</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<pre><code>## m
##  0  1  2  3  4  5  6  7 
## 19 25 21 16  8  6  3  2</code></pre>
<div class="sourceCode" id="cb1138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#将m转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用equalizeHist对img进行直方图均衡化</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_equalizeHist</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">dst_mat</span> <span class="op">=</span> <span class="va">dst</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">dst_mat</span><span class="op">)</span></span></code></pre></div>
<pre><code>## dst_mat
##   0  79 145 195 220 239 249 255 
##  19  25  21  16   8   6   3   2</code></pre>
<p>从运行结果可以看到，均衡化之前的像素分布在[0,7]区间，而均衡化后的像素分布在[0,255]区间。这个结果，还可以通过如下代码验证：</p>
<div class="sourceCode" id="cb1140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将m的元素划分为256个区间（左闭右开型区间）</span></span>
<span><span class="va">zone</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">m</span>,breaks<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">256</span>,right<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#统计各区间中的像素数量（即计算直方图）</span></span>
<span><span class="va">dhist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">zone</span><span class="op">)</span></span>
<span><span class="co">#将直方图归一化（除以像素数量）</span></span>
<span><span class="va">dhist</span> <span class="op">=</span> <span class="va">dhist</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="co">#计算归一化直方图的累计分布图</span></span>
<span><span class="va">Dhist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">dhist</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#遍历m中的所有元素</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#获取元素的值（需要加上1，因为图像矩阵的像素可以为0，</span></span>
<span>    <span class="co">#但R语言中的向量是从1开始位置的）</span></span>
<span>    <span class="va">tmp1</span> <span class="op">=</span> <span class="va">m</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span></span>
<span>    <span class="co">#依据元素的取值从累计分布中获取相应的值并乘以255</span></span>
<span>    <span class="va">tmp2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">Dhist</span><span class="op">[</span><span class="va">tmp1</span><span class="op">]</span><span class="op">*</span><span class="fl">255</span>,<span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="co">#将新的值作为i、j处元素的新值</span></span>
<span>    <span class="va">m</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp2</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#定义归一化函数（最大最小值方式）</span></span>
<span><span class="va">myScale</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">m1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#对m进行归一化后乘以255，再取整——这一步可以确保m的元素取值范围为[0,255]区间</span></span>
<span><span class="va">m</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">myScale</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">*</span><span class="fl">255</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#统计m中所有元素的各个取值数量（即计算直方图）</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<pre><code>## m
##   0  36  73 109 146 182 219 255 
##  19  25  21  16   8   6   3   2</code></pre>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件（按灰度图模式）</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/pout.tif"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用equalizeHist对img进行直方图均衡化，结果保存在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_equalizeHist</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示源图像和均衡化后的图像</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span> <span class="st">"Source image"</span>, <span class="va">img</span> <span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span> <span class="st">"Equalized Image"</span>, <span class="va">dst</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-44-1.png" width="672"></div>
<p>进一步，可以将均衡化前后图像的直方图绘制在一起，从中可以看到直方图本身的均衡化效果：</p>
<div class="sourceCode" id="cb1143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#将均衡化前后的图像矩阵都转变为R语言的矩阵</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="va">img</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">dst_mat</span> <span class="op">=</span> <span class="va">dst</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#绘制均衡化前的直方图</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">img_mat</span>,breaks <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">255</span>,col<span class="op">=</span><span class="st">"red"</span>,main<span class="op">=</span><span class="st">""</span>,xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#绘制均衡化后的直方图</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">dst_mat</span>,breaks <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">255</span>,col<span class="op">=</span><span class="st">"green"</span>,add<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-45-1.png" width="672"></div>
</div>
<div id="直方图比较" class="section level2" number="7.6">
<h2>
<span class="header-section-number">7.6</span> 直方图比较<a class="anchor" aria-label="anchor" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E6%AF%94%E8%BE%83"><i class="fas fa-link"></i></a>
</h2>
<p>直方图比较指的是计算两个直方图的匹配程度，OpenCV在<strong>compareHist</strong>函数中封装了直方图比较运算操作，它提供了4种度量直方图匹配程度的方法：</p>
<ul>
<li>
<p>相关性度量</p>
<p><span class="math display">\[
  d(H_1,H_2)=\frac{\sum_I (H_1(I)-\bar {H_1})(H_2(I)-\bar {H_2})}{\sqrt {\sum_I (H_1(I)-\bar {H_1})^2 \sum_I (H_2(I)-\bar {H_2})^2}}
  \]</span></p>
</li>
</ul>
<p>其中：</p>
<p><span class="math display">\[
    \bar {H_k} = \frac{1}{N} \sum_J H_k(J) \quad (k=1,2)
\]</span>
表示图像直方图平均数（这里的<span class="math inline">\(N\)</span>是直方图划分区间数）。</p>
<div class="sourceCode" id="cb1144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1.mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#将img_mat和img1_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="va">img1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img1</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img和img1的直方图，结果分别保存在img_hist和img1_hist中</span></span>
<span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img1</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img1_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#计算直方图匹配程度（按相关性度量）</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_CORREL</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.3456073</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img_mat的直方图（直方图划分区间数为20），结果保存在img_hist中</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img1_mat的直方图（直方图划分区间数为20），结果保存在img1_hist中</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接用R语言的相关性函数cor计算</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.3456073</code></pre>
<div class="sourceCode" id="cb1148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按照相关性度量公式计算</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">img_hist</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">img1_hist</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">img_hist</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">img1_hist</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.3456073</code></pre>
<ul>
<li>卡方度量</li>
</ul>
<p><span class="math display">\[
    d(H_1,H_2) = \sum_{I} \frac{(H_1(I)-H_2(I))^2}{H_1(I)}
\]</span></p>
<div class="sourceCode" id="cb1150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1.mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#将img_mat和img1_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="va">img1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img1</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img和img1的直方图，结果分别保存在img_hist和img1_hist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img1</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img1_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#计算直方图匹配程度（按卡方度量）</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_CHISQR</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 13.79167</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img_mat的直方图（直方图划分区间数为20），结果保存在img_hist中</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img1_mat的直方图（直方图划分区间数为20），结果保存在img1_hist中</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按照卡方度量公式计算</span></span>
<span><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">img_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">-</span> <span class="va">img1_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">img_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 13.79167</code></pre>
<ul>
<li>相交（交集）度量</li>
</ul>
<p><span class="math display">\[
    d(H_1,H_2) = \sum_I min(H_1(I),H_2(I))
\]</span></p>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#将img_mat和img1_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="va">img1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img1</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img和img1的直方图，结果分别保存在img_hist和img1_hist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img1</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img1_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#计算直方图匹配程度（按相交（交集）度量）</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_INTERSECT</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1.mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img_mat的直方图（直方图划分区间数为20），结果保存在img_hist中</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img1.mat的直方图（直方图划分区间数为20），结果保存在img1_hist中</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按照相交（交集）度量公式计算</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span>,</span>
<span>           <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">img1_hist</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<ul>
<li>Bhattacharyya距离度量</li>
</ul>
<p><span class="math display">\[
    d(H_1,H_2) = \sqrt {1-\frac{1}{\sqrt{\bar H_1 \bar H_2 N^2} } \sum_I \sqrt {H_1(I) \cdot H_2(I)}}
\]</span></p>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#将img_mat和img1_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="va">img1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img1</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img和img1的直方图，结果分别保存在img_hist和img1_hist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img1</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img1_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#计算直方图匹配程度（按Bhattacharyya距离度量）</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_BHATTACHARYYA</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.6734496</code></pre>
<div class="sourceCode" id="cb1160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># or</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_HELLINGER</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.6734496</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img_mat的直方图（直方图划分区间数为20），结果保存在img_hist中</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img1_mat的直方图（直方图划分区间数为20），结果保存在img1_hist中</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按照Bhattacharyya距离度量公式计算</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">*</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> </span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">*</span><span class="va">N</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.6734496</code></pre>
<ul>
<li>可选卡方度量</li>
</ul>
<p><span class="math display">\[
    d(H_1,H_2) = 2 \times \sum_{I} \frac{(H_1(I)-H_2(I))^2}{H_1(I)+H_2(I)}
\]</span></p>
<div class="sourceCode" id="cb1164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#将img_mat和img1_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="va">img1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img1</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img和img1的直方图，结果分别保存在img_hist和img1_hist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img1</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img1_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#计算直方图匹配程度（按可选卡方度量）</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_CHISQR_ALT</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 46.67033</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img_mat的直方图（直方图划分区间数为20），结果保存在img_hist中</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img1_mat的直方图（直方图划分区间数为20），结果保存在img1_hist中</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按照可选卡方度量公式计算</span></span>
<span><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">+</span><span class="va">img1_hist</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">img_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">-</span> <span class="va">img1_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> </span>
<span>        <span class="op">(</span><span class="va">img_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">+</span><span class="va">img1_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 46.67033</code></pre>
<ul>
<li>K-L散度度量</li>
</ul>
<p><span class="math display">\[
    d(H_1,H_2) =  \sum_{I} H_1(I) log \left( \frac{H_1(I)}{H_2(I)} \right)
\]</span></p>
<div class="sourceCode" id="cb1168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#将img_mat和img1_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="va">img1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img1</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img和img1的直方图，结果分别保存在img_hist和img1_hist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img1</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">img1_hist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#计算直方图匹配程度（按K-L散度度量）</span></span>
<span><span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">img_hist</span>,<span class="va">img1_hist</span>,<span class="va">HISTCMP_KL_DIV</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 273.4466</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成随机矩阵img_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#生成随机矩阵img1_mat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">img1_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">7</span>,<span class="fl">25</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">5</span>,nc<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img_mat的直方图（直方图划分区间数为20），结果保存在img_hist中</span></span>
<span><span class="va">img_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img1_mat的直方图（直方图划分区间数为20），结果保存在img1_hist中</span></span>
<span><span class="va">img1_hist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">img1_hist</span><span class="op">)</span><span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">img1_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按照K-L散度度量公式计算</span></span>
<span><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">img1_hist</span><span class="op">[</span><span class="va">img1_hist</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1e-10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">img_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">/</span><span class="va">img1_hist</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 273.4466</code></pre>
<p><strong>示例</strong></p>
<p>有如下四个图像：</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-58-1.png" width="672"></div>
<p>设左上角图像编号为pic1，右上角图像编号为pic2（就是pic1的下半部分图像），左下角图像编号为pic3，右下角图像编号为pic4。以下代码演示了pic1在不同度量方式下分别与自己、与pic2、pic3和pic4的直方图匹配程度的计算结果。</p>
<div class="sourceCode" id="cb1172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">pic1</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_0.jpg"</span><span class="op">)</span></span>
<span><span class="va">pic3</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_1.jpg"</span><span class="op">)</span></span>
<span><span class="va">pic4</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_2.jpg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依据pic1生成pic2</span></span>
<span><span class="va">pic1_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">pic1</span><span class="op">)</span></span>
<span><span class="va">pic2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span></span>
<span>  <span class="va">pic1</span>,</span>
<span>  <span class="fu">Range</span><span class="op">(</span><span class="va">pic1_info</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">pic1_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>  <span class="fu">Range</span><span class="op">(</span><span class="fl">0</span>, <span class="va">pic1_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将pic1、pic2、pic3和pic4转变为HSV三通道图像</span></span>
<span><span class="va">hsv_pic1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">pic1</span>, <span class="va">hsv_pic1</span>, <span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span><span class="va">hsv_pic2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">pic2</span>, <span class="va">hsv_pic2</span>, <span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span><span class="va">hsv_pic3</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">pic3</span>, <span class="va">hsv_pic3</span>, <span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span><span class="va">hsv_pic4</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">pic4</span>, <span class="va">hsv_pic4</span>, <span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">60</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算pic1的直方图，结果保存在hist_pic1中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">pic1</span><span class="op">)</span></span>
<span><span class="va">hist_pic1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span></span>
<span>  <span class="va">imgs</span>,</span>
<span>  <span class="va">channels</span>,<span class="co">#依据H通道和S通道进行计算</span></span>
<span>  <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>  <span class="va">hist_pic1</span>,</span>
<span>  <span class="va">histSize</span>,<span class="co">#H通道和S通道的直方图划分区间数分别为50和60</span></span>
<span>  <span class="va">histRange</span><span class="co">#指定H通道和S通道的各自的划分区间的最小和最大端点值</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#将hist_pic1归一化到[0,1]区间</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">hist_pic1</span>, <span class="va">hist_pic1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">NORM_MINMAX</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算pic2的直方图，结果保存在hist_pic2中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">pic2</span><span class="op">)</span></span>
<span><span class="va">hist_pic2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span></span>
<span>  <span class="va">imgs</span>,</span>
<span>  <span class="va">channels</span>,<span class="co">#依据H通道和S通道进行计算</span></span>
<span>  <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>  <span class="va">hist_pic2</span>,</span>
<span>  <span class="va">histSize</span>,<span class="co">#H通道和S通道的直方图划分区间数分别为50和60</span></span>
<span>  <span class="va">histRange</span><span class="co">#指定H通道和S通道的各自的划分区间的最小和最大端点值</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#将hist_pic2归一化到[0,1]区间</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">hist_pic2</span>, <span class="va">hist_pic2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">NORM_MINMAX</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算pic3的直方图，结果保存在hist_pic3中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">pic3</span><span class="op">)</span></span>
<span><span class="va">hist_pic3</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span></span>
<span>  <span class="va">imgs</span>,</span>
<span>  <span class="va">channels</span>,<span class="co">#依据H通道和S通道进行计算</span></span>
<span>  <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>  <span class="va">hist_pic3</span>,</span>
<span>  <span class="va">histSize</span>,<span class="co">#H通道和S通道的直方图划分区间数分别为50和60</span></span>
<span>  <span class="va">histRange</span><span class="co">#指定H通道和S通道的各自的划分区间的最小和最大端点值</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#将hist_pic3归一化到[0,1]区间</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">hist_pic3</span>, <span class="va">hist_pic3</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">NORM_MINMAX</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算pic4的直方图，结果保存在hist_pic4中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">pic4</span><span class="op">)</span></span>
<span><span class="va">hist_pic4</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span></span>
<span>  <span class="va">imgs</span>,</span>
<span>  <span class="va">channels</span>,<span class="co">#依据H通道和S通道进行计算</span></span>
<span>  <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>  <span class="va">hist_pic4</span>,</span>
<span>  <span class="va">histSize</span>,<span class="co">#H通道和S通道的直方图划分区间数分别为50和60</span></span>
<span>  <span class="va">histRange</span><span class="co">#指定H通道和S通道的各自的划分区间的最小和最大端点值</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#将hist_pic4归一化到[0,1]区间</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">hist_pic4</span>, <span class="va">hist_pic4</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">NORM_MINMAX</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依次在相关性度量、卡方度量、相交度量、Bhattacharyya距离度量或者Hellinger距离度量、</span></span>
<span><span class="co">#可选卡方度量和KL散度度量方式计算pic1与自己、与pic2、pic3和pic4的直方图匹配程度</span></span>
<span><span class="va">HistCompMethods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_BHATTACHARYYA</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_CHISQR</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_CHISQR_ALT</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_CORREL</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_HELLINGER</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_INTERSECT</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html">expr</a></span><span class="op">(</span><span class="va">HISTCMP_KL_DIV</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">compare_method</span> <span class="kw">in</span> <span class="va">HistCompMethods</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">pic1_pic1</span> <span class="op">=</span> <span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">hist_pic1</span>, <span class="va">hist_pic1</span>, <span class="va">compare_method</span><span class="op">)</span></span>
<span>  <span class="va">pic1_pic2</span> <span class="op">=</span> <span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">hist_pic1</span>, <span class="va">hist_pic2</span>, <span class="va">compare_method</span><span class="op">)</span></span>
<span>  <span class="va">pic1_pic3</span> <span class="op">=</span> <span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">hist_pic1</span>, <span class="va">hist_pic3</span>, <span class="va">compare_method</span><span class="op">)</span></span>
<span>  <span class="va">pic1_pic4</span> <span class="op">=</span> <span class="fu">cv_compareHist</span><span class="op">(</span><span class="va">hist_pic1</span>, <span class="va">hist_pic4</span>, <span class="va">compare_method</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Method "</span> ,</span>
<span>    <span class="va">compare_method</span>,</span>
<span>    <span class="st">" pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4: "</span></span>
<span>    ,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pic1_pic1</span>,<span class="fl">2</span><span class="op">)</span> ,</span>
<span>    <span class="st">" / "</span> ,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pic1_pic2</span>,<span class="fl">2</span><span class="op">)</span> ,</span>
<span>    <span class="st">" / "</span> ,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pic1_pic3</span>,<span class="fl">2</span><span class="op">)</span> ,</span>
<span>    <span class="st">" / "</span> ,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pic1_pic4</span>,<span class="fl">2</span><span class="op">)</span> ,</span>
<span>    <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## Method  HISTCMP_BHATTACHARYYA  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  0  /  0.32  /  0.56  /  0.98 
## Method  HISTCMP_CHISQR  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  0  /  17.12  /  95.3  /  1551.52 
## Method  HISTCMP_CHISQR_ALT  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  0  /  28.33  /  66.71  /  112.16 
## Method  HISTCMP_CORREL  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  1  /  0.74  /  0.34  /  -0.01 
## Method  HISTCMP_HELLINGER  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  0  /  0.32  /  0.56  /  0.98 
## Method  HISTCMP_INTERSECT  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  47.56  /  28.45  /  12.96  /  0.15 
## Method  HISTCMP_KL_DIV  pic1:pic1, pic1:pic2, pic1:pic3, pic1:pic4:  0  /  45.01  /  184.6  /  1024.29</code></pre>
</div>
<div id="反向投影" class="section level2" number="7.7">
<h2>
<span class="header-section-number">7.7</span> 反向投影<a class="anchor" aria-label="anchor" href="#%E5%8F%8D%E5%90%91%E6%8A%95%E5%BD%B1"><i class="fas fa-link"></i></a>
</h2>
<p>反向投影指的是图像依据一个指定的直方图，判定每个像素位于直方图的哪个划分区间，并将相应区间的直方图数据作为该像素新的取值的整个计算过程。</p>
<div id="单通道图像基于单通道直方图的反向投影" class="section level3" number="7.7.1">
<h3>
<span class="header-section-number">7.7.1</span> 单通道图像基于单通道直方图的反向投影<a class="anchor" aria-label="anchor" href="#%E5%8D%95%E9%80%9A%E9%81%93%E5%9B%BE%E5%83%8F%E5%9F%BA%E4%BA%8E%E5%8D%95%E9%80%9A%E9%81%93%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%8F%8D%E5%90%91%E6%8A%95%E5%BD%B1"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵img_mat</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">11</span>, <span class="fl">8</span>, <span class="fl">9</span>, <span class="fl">14</span>, <span class="fl">15</span><span class="op">)</span>,</span>
<span>                 nr <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                 nc <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                 byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#将img_mat转变为图像矩阵img</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">4</span>,<span class="fl">4</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">16</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img的直方图，结果保存在hhist中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">hhist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个通道计算直方图</span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>,<span class="co">#遮罩矩阵为空</span></span>
<span>              <span class="va">hhist</span>,</span>
<span>              <span class="va">histSize</span>,<span class="co">#直方图划分区间数为4</span></span>
<span>              <span class="va">histRange</span><span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>              <span class="op">)</span></span>
<span></span>
<span><span class="co">#对img依据其自身的直方图hhist进行反向投影，结果保存在backProj中</span></span>
<span><span class="va">backProj</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcBackProject</span><span class="op">(</span><span class="va">imgs</span>, </span>
<span>                     <span class="va">channels</span>, <span class="co">#对第1个通道进行反向投影</span></span>
<span>                     <span class="va">hhist</span>, <span class="co">#指定反向投影参照的直方图</span></span>
<span>                     <span class="va">backProj</span>, </span>
<span>                     <span class="va">histRange</span>,<span class="co">#指定划分区间的最小和最大端点值</span></span>
<span>                     <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">backProj</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4]
## [1,]    4    4    4    4
## [2,]    4    4    4    4
## [3,]    6    6    6    6
## [4,]    6    6    2    2
## attr(,"depth")
## [1] 0</code></pre>
<p>可以通过如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵img_mat</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">11</span>,<span class="fl">8</span>,<span class="fl">9</span>,<span class="fl">14</span>,<span class="fl">15</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">4</span>,nc<span class="op">=</span><span class="fl">4</span>,byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#将img_mat中各元素取值划分为4个区间：[0,4),[4,8),[8,12),[12,16)，</span></span>
<span><span class="co">#结果保存在tcut中。</span></span>
<span><span class="co">#特别留意tcut中的值表明的是img.mat的各个元素所在的划分区间：</span></span>
<span><span class="co">#1-4个数对应于img.mat的第1列，5-8个数对应于第2列，9-12个数对应于第3列，</span></span>
<span><span class="co">#13-16个数对应于第4列。</span></span>
<span><span class="va">tcut</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">img_mat</span>,breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">4</span>,<span class="fl">8</span>,<span class="fl">12</span>,<span class="fl">16</span><span class="op">)</span>,right<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#计算各区间的元素个数，即计算直方图：</span></span>
<span><span class="co">#第1、第2个区间都有4个数，第3个区间有6个数，第4个区间有2个数</span></span>
<span><span class="va">ht</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tcut</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依据img.mat的各个元素取值所对应的直方图划分区间，取出各自对应的</span></span>
<span><span class="co">#直方图数据，结果保存在backProj中</span></span>
<span><span class="va">backProj</span> <span class="op">=</span> <span class="va">ht</span><span class="op">[</span><span class="va">tcut</span><span class="op">]</span></span>
<span><span class="co">#将backProj转变为矩阵模式，获得反向投影结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">backProj</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">backProj</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4]
## [1,]    4    4    4    4
## [2,]    4    4    4    4
## [3,]    6    6    6    6
## [4,]    6    6    2    2</code></pre>
</div>
<div id="三通道图像基于双通道直方图的反向投影" class="section level3" number="7.7.2">
<h3>
<span class="header-section-number">7.7.2</span> 三通道图像基于双通道直方图的反向投影<a class="anchor" aria-label="anchor" href="#%E4%B8%89%E9%80%9A%E9%81%93%E5%9B%BE%E5%83%8F%E5%9F%BA%E4%BA%8E%E5%8F%8C%E9%80%9A%E9%81%93%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%8F%8D%E5%90%91%E6%8A%95%E5%BD%B1"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#再对x随机排序后,转变为10行10列矩阵m2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#继续对x随机排序后,转变为10行10列矩阵m3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">125</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#形成一个3维全0数组</span></span>
<span><span class="va">arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>,dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#将arr包含的3个10行10列矩阵分别改为m1,m2和m3</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">m1</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">m2</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">m3</span></span>
<span></span>
<span><span class="co">#将m转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">arr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算img的双通道直方图，结果保存在hhist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">hhist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span><span class="va">imgs</span>,</span>
<span>              <span class="va">channels</span>,<span class="co">#针对第1个和第2个通道计算直方图 </span></span>
<span>              <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>, <span class="co">#遮罩矩阵参数设置为空矩阵</span></span>
<span>              <span class="va">hhist</span>,</span>
<span>              <span class="va">histSize</span>,</span>
<span>              <span class="va">histRange</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img依据其自身的直方图hhist进行反向投影，结果保存在backProj中</span></span>
<span><span class="va">backProj</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcBackProject</span><span class="op">(</span><span class="va">imgs</span>, </span>
<span>                     <span class="va">channels</span>, <span class="co">#对第1个和第2个通道进行反向投影</span></span>
<span>                     <span class="va">hhist</span>, <span class="co">#指定反向投影参照的直方图</span></span>
<span>                     <span class="va">backProj</span>, </span>
<span>                     <span class="va">histRange</span>,<span class="co">#指定两个通道各自的划分区间的最小和最大端点值</span></span>
<span>                     <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">backProj</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,]    7    3    6    7    9    5    3    9    7     7
##  [2,]    6    5    1   12    9    2    1    7   12     9
##  [3,]    7   12    1    4    6    4    7   15    7    12
##  [4,]    9    9    2    2    9    1    9    6    7    15
##  [5,]    4    5   15    5   15    2   12    2    4     6
##  [6,]   15   15    2   15    6   15    6    3    4     7
##  [7,]   12    6    4    1   12    6   12    2    4     6
##  [8,]    7    1   15   15   12    1   12    9    1    15
##  [9,]    2    4   15    7    2    5    2    2    7    12
## [10,]   15   15    7    6    6   15    2   12    2     2
## attr(,"depth")
## [1] 0</code></pre>
<p>可以通过如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按指定频率重复生成0,1,2,...,7这8个数：</span></span>
<span><span class="co">#0-7这8个数重复的次数分别为19,25,21,16,8,6,3和2，结果保存在x中</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span>,<span class="fl">25</span>,<span class="fl">21</span>,<span class="fl">16</span>,<span class="fl">8</span>,<span class="fl">6</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#对x随机排序后,转变为10行10列矩阵m1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#再对x随机排序后,转变为10行10列矩阵m2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#继续对x随机排序后,转变为10行10列矩阵m3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">125</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#形成一个3维全0数组</span></span>
<span><span class="va">arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>,dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#将arr包含的3个10行10列矩阵分别改为m1,m2和m3</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">m1</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">m2</span></span>
<span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">m3</span></span>
<span></span>
<span><span class="co">#将arr[,,1]中各元素取值划分为8个区间，结果保存在tcut1中。</span></span>
<span><span class="co">#特别留意tcut1中的值表明的是arr[,,1]的各个元素所在的划分区间：</span></span>
<span><span class="co">#1-10个数对应于img_mat的第1列，11-20个数对应于第2列，依次类推。</span></span>
<span><span class="va">tcut1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span>,breaks<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>,right<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将arr[,,2]中各元素取值划分为4个区间，结果保存在tcut1中。</span></span>
<span><span class="co">#特别留意tcut2中的值表明的是arr[,,2]的各个元素所在的划分区间：</span></span>
<span><span class="co">#1-10个数对应于img_mat的第1列，11-20个数对应于第2列，依次类推。</span></span>
<span><span class="va">tcut2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">arr</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span>,breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">8</span>,by<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,right<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#统计频数（以arr[,,1]的划分区间为行，以arr[,,2]的划分区间为列），</span></span>
<span><span class="co">#即计算直方图</span></span>
<span><span class="va">ht</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tcut1</span>,<span class="va">tcut2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依据arr[,,1]和arr[,,2]的各个元素取值所对应的直方图划分区间，</span></span>
<span><span class="co">#取出各自对应的直方图数据，结果保存在backProj中</span></span>
<span><span class="va">backProj</span> <span class="op">=</span> <span class="va">ht</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">tcut1</span>,<span class="va">tcut2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#将backProj转变为矩阵模式，获得反向投影结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">backProj</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">backProj</span></span></code></pre></div>
<pre><code>##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,]    7    3    6    7    9    5    3    9    7     7
##  [2,]    6    5    1   12    9    2    1    7   12     9
##  [3,]    7   12    1    4    6    4    7   15    7    12
##  [4,]    9    9    2    2    9    1    9    6    7    15
##  [5,]    4    5   15    5   15    2   12    2    4     6
##  [6,]   15   15    2   15    6   15    6    3    4     7
##  [7,]   12    6    4    1   12    6   12    2    4     6
##  [8,]    7    1   15   15   12    1   12    9    1    15
##  [9,]    2    4   15    7    2    5    2    2    7    12
## [10,]   15   15    7    6    6   15    2   12    2     2</code></pre>
<p><strong>示例</strong></p>
<p>对于如下手部图像（记为pic1）：</p>
<div class="inline-figure"><img src="images/tutorial/Back_Projection_Theory0.jpg" width="100" style="display: block; margin: auto;"></div>
<p>可以应用如下遮罩，计算相应手部区域的色调-饱和度直方图，作为皮肤特征直方图。</p>
<div class="inline-figure"><img src="images/palm_0_mask.png" width="100" style="display: block; margin: auto;"></div>
<p>现在另一个手部图像（记为pic2）如下：</p>
<div class="inline-figure"><img src="images/tutorial/Back_Projection_Theory2.jpg" width="100" style="display: block; margin: auto;"></div>
<p>以下代码演示了如何利用pic1生成的皮肤特征直方图对pic2进行反向投影，进而寻找到pic2的皮肤区域。</p>
<div class="sourceCode" id="cb1182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">pic1</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_0.jpg"</span><span class="op">)</span></span>
<span><span class="co">#读取遮罩图像文件</span></span>
<span><span class="va">mask</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_0_mask.png"</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将pic1转变为HSV三通道图像矩阵</span></span>
<span><span class="va">pic1_hsv</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">pic1</span>,<span class="va">pic1_hsv</span>,<span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在遮罩矩阵作用下计算pic1_hsv的色调-饱和度直方图(皮肤特征直方图)，</span></span>
<span><span class="co">#结果保存在hhist中</span></span>
<span><span class="va">channels</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">channels</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">histSize</span> <span class="op">=</span> <span class="fu">stdVecOfint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span></span>
<span><span class="va">histSize</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span></span>
<span><span class="va">histRange</span> <span class="op">=</span> <span class="fu">stdVecOffloat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">180</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">histRange</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">pic1_hsv</span><span class="op">)</span></span>
<span><span class="va">hhist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcHist</span><span class="op">(</span></span>
<span>  <span class="va">imgs</span>,</span>
<span>  <span class="va">channels</span>,<span class="co">#针对H通道和S通道计算直方图 </span></span>
<span>  <span class="va">mask</span>, <span class="co">#遮罩矩阵</span></span>
<span>  <span class="va">hhist</span>,</span>
<span>  <span class="va">histSize</span>, <span class="co">#H通道和S通道划分区间数分别为180和256</span></span>
<span>  <span class="va">histRange</span> <span class="co">#H通道和S通道各自的划分区间的最小和最大端点值</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#读取图像文件</span></span>
<span><span class="va">pic2</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm_1.jpg"</span><span class="op">)</span></span>
<span><span class="co">#将pic2转变为HSV三通道图像矩阵</span></span>
<span><span class="va">pic2_hsv</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">pic2</span>,<span class="va">pic2_hsv</span>,<span class="va">COLOR_BGR2HSV</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对pic2.hsv依据hhist进行反向投影，结果保存在backProj中</span></span>
<span><span class="va">imgs</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgs</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">pic2_hsv</span><span class="op">)</span></span>
<span><span class="va">backProj</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_calcBackProject</span><span class="op">(</span></span>
<span>  <span class="va">imgs</span>, </span>
<span>  <span class="va">channels</span>, <span class="co">#对第1个和第2个通道进行反向投影</span></span>
<span>  <span class="va">hhist</span>, <span class="co">#指定反向投影参照的直方图</span></span>
<span>  <span class="va">backProj</span>, </span>
<span>  <span class="va">histRange</span>,<span class="co">#指定两个通道各自的划分区间的最小和最大端点值</span></span>
<span>  <span class="fl">5</span> <span class="co">#放大系数设置为5倍</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对backProj进行归一化（最大最小值方式），以便可视化展示</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">backProj</span>, <span class="va">backProj</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-68-1.png" width="672"></div>
</div>
</div>
<div id="模板匹配" class="section level2" number="7.8">
<h2>
<span class="header-section-number">7.8</span> 模板匹配<a class="anchor" aria-label="anchor" href="#%E6%A8%A1%E6%9D%BF%E5%8C%B9%E9%85%8D"><i class="fas fa-link"></i></a>
</h2>
<p>模板匹配指的是计算图像与指定模板（图像）匹配程度的过程，可以用于在图像中搜索指定内容。主要操作步骤是：</p>
<ul>
<li>确定模板（图像），如果模板中仅有部分区域为待搜索的内容时，可以使用遮罩；<br>
</li>
<li>在待匹配的图像上移动模板，模板左上角顶点元素对准的图像像素称为模板匹配的目标像素，计算模板与模板覆盖住的图像区域的匹配程度值，并将该值作为目标图像对应像素的值。目标图像的宽度等于待匹配图像的宽度减去模板（图像）宽度+1，高度等于待匹配图像的高度减去模板（图像）高度+1</li>
</ul>
<p>OpenCV在<strong>matchTemplate</strong>函数中封装了模板匹配操作，它提供了6种模板匹配程度的计算方法：</p>
<ul>
<li>TM_SQDIFF</li>
</ul>
<p><span class="math display">\[
R(x,y) = \sum_{r,c}(T(r,c)-I(y+r,x+c))^2
\]</span></p>
<p>其中<span class="math inline">\(T(r,c)\)</span>表示模板（图像）中的元素（像素），<span class="math inline">\(I(y+r,x+c)\)</span>表示待匹配图像中以<span class="math inline">\((x,y)\)</span>位置为目标像素的模板覆盖区域中的像素。</p>
<div class="sourceCode" id="cb1183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#将img_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="co">#将templ_mat也转变为图像矩阵</span></span>
<span><span class="va">templ</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">templ</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按TM_SQDIFF匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">templ</span>,<span class="va">res</span>,<span class="va">TM_SQDIFF</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2]     [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]    0   20 53.00000   16   55   30   23   18
## [2,]   15   20 47.00000   21   42   24    8   20
## [3,]   26   22 33.00002   24    9   18   27   27
## [4,]   35   25 29.00000   27   25   43   40   40
## [5,]   26   50 26.00000   33   23   38   14   39
## [6,]   48   51 13.00000   35   31   40   15   34
## [7,]   44   28 18.00000   26   25   25   23   20
## [8,]   16   12 25.00000   19   45   20   14   24
## attr(,"depth")
## [1] 5</code></pre>
<p>从结果可以看到，第1行第1列的匹配值为0，即图像的前3行前3列像素区域与模板完全匹配，这符合预期。也可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#按公式计算匹配程度值，结果保存在res.mat中</span></span>
<span><span class="va">res_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">res_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="va">templ_mat</span> <span class="op">-</span> <span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sum</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">res_mat</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]    0   20   53   16   55   30   23   18
## [2,]   15   20   47   21   42   24    8   20
## [3,]   26   22   33   24    9   18   27   27
## [4,]   35   25   29   27   25   43   40   40
## [5,]   26   50   26   33   23   38   14   39
## [6,]   48   51   13   35   31   40   15   34
## [7,]   44   28   18   26   25   25   23   20
## [8,]   16   12   25   19   45   20   14   24</code></pre>
<p>TM_SQDIFF方法形成的最小值点位置是模板匹配的最佳位置。</p>
<ul>
<li>TM_SQDIFF_NORMED</li>
</ul>
<p><span class="math display">\[
R(x,y) = \frac{\sum_{r,c}(T(r,c)-I(y+r,x+c))^2}{\sqrt {\sum_{r,c}T(r,c)^2 \cdot \sum_{r,c}I(y+r,x+c)^2}}
\]</span></p>
<div class="sourceCode" id="cb1187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#将img_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="co">#将templ_mat也转变为图像矩阵</span></span>
<span><span class="va">templ</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">templ</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按TM_SQDIFF_NORMED匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">templ</span>,<span class="va">res</span>,<span class="va">TM_SQDIFF_NORMED</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,] 0.00 0.28 0.64 0.19 0.51 0.30 0.23 0.20
## [2,] 0.21 0.29 0.51 0.22 0.40 0.26 0.09 0.25
## [3,] 0.35 0.28 0.37 0.25 0.10 0.20 0.30 0.29
## [4,] 0.43 0.29 0.32 0.30 0.33 0.49 0.44 0.38
## [5,] 0.29 0.52 0.28 0.40 0.42 0.45 0.16 0.37
## [6,] 0.50 0.49 0.13 0.45 0.66 0.61 0.20 0.37
## [7,] 0.49 0.29 0.21 0.39 0.41 0.39 0.33 0.26
## [8,] 0.18 0.14 0.29 0.26 0.56 0.29 0.21 0.30
## attr(,"depth")
## [1] 5</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#按公式计算匹配程度值，结果保存在res_mat中</span></span>
<span><span class="va">res_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">numer</span> <span class="op">=</span> <span class="op">(</span><span class="va">templ_mat</span> <span class="op">-</span> <span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sum</span></span>
<span>    <span class="va">denom</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">res_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">numer</span><span class="op">/</span><span class="va">denom</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res_mat</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,] 0.00 0.28 0.64 0.19 0.51 0.30 0.23 0.20
## [2,] 0.21 0.29 0.51 0.22 0.40 0.26 0.09 0.25
## [3,] 0.35 0.28 0.37 0.25 0.10 0.20 0.30 0.29
## [4,] 0.43 0.29 0.32 0.30 0.33 0.49 0.44 0.38
## [5,] 0.29 0.52 0.28 0.40 0.42 0.45 0.16 0.37
## [6,] 0.50 0.49 0.13 0.45 0.66 0.61 0.20 0.37
## [7,] 0.49 0.29 0.21 0.39 0.41 0.39 0.33 0.26
## [8,] 0.18 0.14 0.29 0.26 0.56 0.29 0.21 0.30</code></pre>
<p>TM_SQDIFF_NORMED方法形成的最小值点位置是模板匹配的最佳位置。</p>
<ul>
<li>TM_CCORR</li>
</ul>
<p><span class="math display">\[
R(x,y) = \sum_{r,c}(T(r,c) \times I(y+r,x+c))
\]</span></p>
<div class="sourceCode" id="cb1191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img.mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#将img_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="co">#将templ_mat也转变为图像矩阵</span></span>
<span><span class="va">templ</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">templ</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按TM_CCORR匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">templ</span>,<span class="va">res</span>,<span class="va">TM_CCORR</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2]     [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]   79   61 56.00000   78   85   86   91   83
## [2,]   63   59 69.00000   87   87   82   84   69
## [3,]   61   69 72.99999   85   91   83   76   82
## [4,]   63   74 78.00000   79   64   67   72   90
## [5,]   78   74 80.00000   66   47   66   84   92
## [6,]   75   82 93.00000   60   38   47   66   76
## [7,]   68   83 76.00000   54   50   53   59   68
## [8,]   80   82 74.00000   65   58   59   61   67
## attr(,"depth")
## [1] 5</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img.mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#按公式计算匹配程度值，结果保存在res.mat中</span></span>
<span><span class="va">res_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">res_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="va">templ_mat</span> <span class="op">*</span> <span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sum</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="va">res_mat</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]   79   61   56   78   85   86   91   83
## [2,]   63   59   69   87   87   82   84   69
## [3,]   61   69   73   85   91   83   76   82
## [4,]   63   74   78   79   64   67   72   90
## [5,]   78   74   80   66   47   66   84   92
## [6,]   75   82   93   60   38   47   66   76
## [7,]   68   83   76   54   50   53   59   68
## [8,]   80   82   74   65   58   59   61   67</code></pre>
<ul>
<li>TM_CCORR_NORMED</li>
</ul>
<p><span class="math display">\[
R(x,y) = \frac{\sum_{r,c}(T(r,c) \cdot I(y+r,x+c))}{\sqrt {\sum_{r,c}T(r,c)^2 \cdot \sum_{r,c}I(y+r,x+c)^2}}
\]</span></p>
<div class="sourceCode" id="cb1195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#将img_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="co">#将templ_mat也转变为图像矩阵</span></span>
<span><span class="va">templ</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">templ</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按TM_CCORR_NORMED匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">templ</span>,<span class="va">res</span>,<span class="va">TM_CCORR_NORMED</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,] 1.00 0.86 0.68 0.91 0.79 0.87 0.91 0.91
## [2,] 0.90 0.86 0.75 0.91 0.84 0.88 0.96 0.87
## [3,] 0.83 0.86 0.82 0.89 0.97 0.91 0.86 0.87
## [4,] 0.78 0.86 0.85 0.86 0.84 0.76 0.79 0.85
## [5,] 0.86 0.76 0.87 0.80 0.86 0.78 0.93 0.86
## [6,] 0.77 0.79 0.96 0.77 0.81 0.71 0.90 0.83
## [7,] 0.76 0.87 0.90 0.82 0.83 0.83 0.84 0.87
## [8,] 0.91 0.94 0.86 0.87 0.72 0.86 0.91 0.85
## attr(,"depth")
## [1] 5</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#按公式计算匹配程度值，结果保存在res_mat中</span></span>
<span><span class="va">res_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">numer</span> <span class="op">=</span> <span class="op">(</span><span class="va">templ_mat</span> <span class="op">*</span> <span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sum</span></span>
<span>    <span class="va">denom</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">res_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">numer</span><span class="op">/</span><span class="va">denom</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res_mat</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,] 1.00 0.86 0.68 0.91 0.79 0.87 0.91 0.91
## [2,] 0.90 0.86 0.75 0.91 0.84 0.88 0.96 0.87
## [3,] 0.83 0.86 0.82 0.89 0.97 0.91 0.86 0.87
## [4,] 0.78 0.86 0.85 0.86 0.84 0.76 0.79 0.85
## [5,] 0.86 0.76 0.87 0.80 0.86 0.78 0.93 0.86
## [6,] 0.77 0.79 0.96 0.77 0.81 0.71 0.90 0.83
## [7,] 0.76 0.87 0.90 0.82 0.83 0.83 0.84 0.87
## [8,] 0.91 0.94 0.86 0.87 0.72 0.86 0.91 0.85</code></pre>
<p>TM_CCORR_NORMED方法形成的最大值点位置是模板匹配的最佳位置。</p>
<ul>
<li>TM_CCOEFF</li>
</ul>
<p><span class="math display">\[
R(x,y) = \sum_{r,c}(T'(r,c) \cdot I'(y+r,x+c))
\]</span></p>
<p>其中：</p>
<p><span class="math display">\[
\begin{aligned}
&amp;T'(r,c) = T(r,c)-\frac {1}{w \cdot h} \cdot \sum_{r_1,c_1}T(r_1,c_1) \\
&amp;I'(y+r,x+c)=I(y+r,x+c)-\frac {1}{w \cdot h} \cdot \sum_{r_1,c_1} I(y+r_1,x+c_1)
\end{aligned}
\]</span>
其中，<span class="math inline">\(w\)</span>和<span class="math inline">\(h\)</span>为模板（图像）的宽度和高度，<span class="math inline">\(\displaystyle \frac {1}{w \cdot h} \cdot \sum_{r_1,c_1}T(r_1,c_1)\)</span>表示模板（图像）的元素值（像素值）的平均值。</p>
<div class="sourceCode" id="cb1199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#将img_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="co">#将templ_mat也转变为图像矩阵</span></span>
<span><span class="va">templ</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">templ</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按TM_CCOEFF匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">templ</span>,<span class="va">res</span>,<span class="va">TM_CCOEFF</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       [,1]  [,2]   [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
## [1,]  9.56  2.67 -10.67  8.56 -9.44 -0.11  2.11  2.44
## [2,]  1.89  0.67  -8.78  3.67 -4.67  1.44  9.00 -0.44
## [3,] -2.89 -0.44  -4.78 -1.11  7.67  2.44 -1.78 -1.33
## [4,] -3.67  1.78   0.22  1.22  2.89 -5.22 -3.00 -1.67
## [5,]  3.00 -6.56   5.00 -0.67  2.56 -3.44  9.00 -2.44
## [6,] -5.56 -6.89   9.67 -1.11 -0.89 -5.78  4.89 -4.56
## [7,] -7.00  2.44   6.56  1.22  0.00 -2.56 -2.11 -1.44
## [8,]  5.00  7.00   1.78  3.89 -8.67  0.67  2.67 -2.44
## attr(,"depth")
## [1] 5</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#按公式计算匹配程度值，结果保存在res_mat中</span></span>
<span><span class="va">res_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">res_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">templ_mat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> </span>
<span>                         <span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> </span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       [,1]  [,2]   [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
## [1,]  9.56  2.67 -10.67  8.56 -9.44 -0.11  2.11  2.44
## [2,]  1.89  0.67  -8.78  3.67 -4.67  1.44  9.00 -0.44
## [3,] -2.89 -0.44  -4.78 -1.11  7.67  2.44 -1.78 -1.33
## [4,] -3.67  1.78   0.22  1.22  2.89 -5.22 -3.00 -1.67
## [5,]  3.00 -6.56   5.00 -0.67  2.56 -3.44  9.00 -2.44
## [6,] -5.56 -6.89   9.67 -1.11 -0.89 -5.78  4.89 -4.56
## [7,] -7.00  2.44   6.56  1.22  0.00 -2.56 -2.11 -1.44
## [8,]  5.00  7.00   1.78  3.89 -8.67  0.67  2.67 -2.44
## attr(,"depth")
## [1] 5</code></pre>
<ul>
<li>TM_CCOEFF_NORMED</li>
</ul>
<p><span class="math display">\[
R(x,y) = \frac{\sum_{r,c}(T'(r,c) \cdot I'(y+r,x+c))}{\sqrt {\sum_{r,c}T'(r,c)^2 \cdot \sum_{r,c}I'(y+r,x+c)^2}}
\]</span></p>
<p>其中：</p>
<p><span class="math display">\[
\begin{aligned}
&amp;T'(r,c) = T(r,c)-\frac {1}{w \cdot h} \cdot \sum_{r_1,c_1}T(r_1,c_1) \\
&amp;I'(y+r,x+c)=I(y+r,x+c)-\frac {1}{w \cdot h} \cdot \sum_{r_1,c_1} I(y+r_1,x+c_1)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb1203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#将img_mat转变为图像矩阵</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span></span>
<span><span class="co">#将templ_mat也转变为图像矩阵</span></span>
<span><span class="va">templ</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">templ</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#按TM_CCOEFF_NORMED匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">templ</span>,<span class="va">res</span>,<span class="va">TM_CCOEFF_NORMED</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
## [1,]  1.00  0.23 -0.74  0.57 -0.73 -0.01  0.20  0.23
## [2,]  0.21  0.07 -0.65  0.30 -0.38  0.12  0.73 -0.05
## [3,] -0.29 -0.04 -0.43 -0.13  0.72  0.23 -0.16 -0.12
## [4,] -0.28  0.13  0.02  0.09  0.21 -0.35 -0.20 -0.12
## [5,]  0.21 -0.42  0.32 -0.05  0.27 -0.24  0.62 -0.20
## [6,] -0.36 -0.47  0.70 -0.08 -0.12 -0.48  0.42 -0.40
## [7,] -0.51  0.17  0.46  0.10  0.00 -0.30 -0.24 -0.17
## [8,]  0.40  0.57  0.13  0.31 -0.66  0.07  0.30 -0.26
## attr(,"depth")
## [1] 5</code></pre>
<p>可以用如下代码来验证这个结果：</p>
<div class="sourceCode" id="cb1205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成矩阵</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">img_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">100</span>,replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,nr<span class="op">=</span><span class="fl">10</span>,nc<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#直接以img_mat的前3行前3列元素为模板</span></span>
<span><span class="va">templ_mat</span> <span class="op">=</span> <span class="va">img_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#按公式计算匹配程度值，结果保存在res_mat中</span></span>
<span><span class="va">res_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">res_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">numer</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">templ_mat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> </span>
<span>                  <span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">denom</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">templ_mat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">templ_mat</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">img_mat</span><span class="op">[</span><span class="va">i</span><span class="op">:</span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>,<span class="va">j</span><span class="op">:</span><span class="op">(</span><span class="va">j</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">res_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">numer</span> <span class="op">/</span> <span class="va">denom</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">res_mat</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
## [1,]  1.00  0.23 -0.74  0.57 -0.73 -0.01  0.20  0.23
## [2,]  0.21  0.07 -0.65  0.30 -0.38  0.12  0.73 -0.05
## [3,] -0.29 -0.04 -0.43 -0.13  0.72  0.23 -0.16 -0.12
## [4,] -0.28  0.13  0.02  0.09  0.21 -0.35 -0.20 -0.12
## [5,]  0.21 -0.42  0.32 -0.05  0.27 -0.24  0.62 -0.20
## [6,] -0.36 -0.47  0.70 -0.08 -0.12 -0.48  0.42 -0.40
## [7,] -0.51  0.17  0.46  0.10  0.00 -0.30 -0.24 -0.17
## [8,]  0.40  0.57  0.13  0.31 -0.66  0.07  0.30 -0.26</code></pre>
<p>TM_CCOEFF_NORMED方法形成的最大值点位置是模板匹配的最佳位置。</p>
<p><strong>示例</strong></p>
<p>下图中左边为模板（图像），中间为模板遮罩，右边为待匹配图像：</p>
<p><img src="07-imgproc1_files/figure-html/unnamed-chunk-81-1.png" width="672"><img src="07-imgproc1_files/figure-html/unnamed-chunk-81-2.png" width="672"><img src="07-imgproc1_files/figure-html/unnamed-chunk-81-3.png" width="672"></p>
<p>以下代码演示了使用遮罩对模板匹配准确度的影响：</p>
<div class="sourceCode" id="cb1207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/LinuxLogo1.png"</span><span class="op">)</span></span>
<span><span class="co">#读取模板图像文件</span></span>
<span><span class="va">tmpl</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/xTempl.png"</span><span class="op">)</span></span>
<span><span class="co">#获得模板图像基本信息</span></span>
<span><span class="va">tmpl_info</span><span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">tmpl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#读取遮罩文件</span></span>
<span><span class="va">mask</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/xTemplMask.png"</span><span class="op">)</span></span>
<span><span class="co">#use_mask为FALSE，不使用遮罩，如果为TRUE，则使用遮罩</span></span>
<span><span class="va">use_mask</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="co">#按TM_CCORR_NORMED匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">use_mask</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#使用遮罩进行模板匹配</span></span>
<span>  <span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">tmpl</span>,<span class="va">res</span>,<span class="va">TM_CCORR_NORMED</span>,<span class="va">mask</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>  <span class="co">#不使用遮罩进行模板匹配</span></span>
<span>  <span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">tmpl</span>,<span class="va">res</span>,<span class="va">TM_CCORR_NORMED</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#对res进行归一化（最大最小值方式）</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">res</span>, <span class="va">res</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用minMaxLoc函数，获取图像中最小、最大像素值以及最小、最大像素值出现的位置</span></span>
<span><span class="va">minVal</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">maxVal</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">minLoc</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">maxLoc</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">cv_minMaxLoc</span><span class="op">(</span><span class="va">res</span>,</span>
<span>               <span class="va">minVal</span>,</span>
<span>               <span class="va">maxVal</span>,</span>
<span>               <span class="va">minLoc</span>,</span>
<span>               <span class="va">maxLoc</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#由于使用的是TM_CCORR_NORMED方法，所以最大像素值出现的位置是最佳匹配位置</span></span>
<span><span class="va">matchLoc</span> <span class="op">=</span> <span class="va">maxLoc</span></span>
<span><span class="co">#依据最佳匹配位置和模板的尺寸绘制最佳模板匹配区域</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span></span>
<span>    <span class="va">img</span>,</span>
<span>    <span class="va">matchLoc</span>,</span>
<span>    <span class="fu">Point</span><span class="op">(</span><span class="va">matchLoc</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">width</span> , <span class="va">matchLoc</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>    <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,</span>
<span>    <span class="fl">2</span>,</span>
<span>    <span class="fl">8</span>,</span>
<span>    <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span></span>
<span>    <span class="va">res</span>,</span>
<span>    <span class="va">matchLoc</span>,</span>
<span>    <span class="fu">Point</span><span class="op">(</span><span class="va">matchLoc</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">width</span> , <span class="va">matchLoc</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>    <span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,</span>
<span>    <span class="fl">2</span>,</span>
<span>    <span class="fl">8</span>,</span>
<span>    <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"result"</span>,<span class="va">res</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"matched"</span>, <span class="va">img</span><span class="op">)</span></span></code></pre></div>
<p>当不使用遮罩时，匹配结果不准确</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-83-1.png" width="672"></div>
<p>当把代码中的use_mask设置为TRUE时（即使用遮罩时），匹配结果符合预期。</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-85-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/orangetree.jpg"</span><span class="op">)</span></span>
<span><span class="co">#读取模板图像文件</span></span>
<span><span class="va">tmpl</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/orange_templ.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获得模板图像基本信息</span></span>
<span><span class="va">tmpl_info</span><span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">tmpl</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#按TM_CCORR_NORMED匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">tmpl</span>,<span class="va">res</span>,<span class="va">TM_CCORR_NORMED</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对res进行归一化（最大最小值方式）</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">res</span>, <span class="va">res</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#由于res的尺寸与原图像有差异，不好对比结果</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">res_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="va">res1</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">roi</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">res1</span>,<span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="va">res_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">res_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">roi</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用minMaxLoc函数，获取图像中最小、最大像素值以及最小、最大像素值出现的位置</span></span>
<span><span class="va">minVal</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">maxVal</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">minLoc</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">maxLoc</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">cv_minMaxLoc</span><span class="op">(</span><span class="va">res1</span>,</span>
<span>             <span class="va">minVal</span>,</span>
<span>             <span class="va">maxVal</span>,</span>
<span>             <span class="va">minLoc</span>,</span>
<span>             <span class="va">maxLoc</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#由于使用的是TM_CCORR_NORMED方法，所以最大像素值出现的位置是最佳匹配位置</span></span>
<span><span class="va">matchLoc</span> <span class="op">=</span> <span class="va">maxLoc</span></span>
<span><span class="co">#依据最佳匹配位置和模板的尺寸绘制最佳模板匹配区域</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span></span>
<span>    <span class="va">img</span>,</span>
<span>    <span class="va">matchLoc</span>,</span>
<span>    <span class="fu">Point</span><span class="op">(</span><span class="va">matchLoc</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">width</span> , <span class="va">matchLoc</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>    <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,</span>
<span>    <span class="fl">2</span>,</span>
<span>    <span class="fl">8</span>,</span>
<span>    <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span></span>
<span>    <span class="va">res1</span>,</span>
<span>    <span class="va">matchLoc</span>,</span>
<span>    <span class="fu">Point</span><span class="op">(</span><span class="va">matchLoc</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">width</span> , <span class="va">matchLoc</span><span class="op">$</span><span class="va">y</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>    <span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,</span>
<span>    <span class="fl">2</span>,</span>
<span>    <span class="fl">8</span>,</span>
<span>    <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"result"</span>,<span class="va">res1</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"matched"</span>, <span class="va">img</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-87-1.png" width="672"></div>
<p>可以试着匹配多个结果：</p>
<div class="sourceCode" id="cb1209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#本想匹配多个结果，但失败了</span></span>
<span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/orangetree.jpg"</span><span class="op">)</span></span>
<span><span class="co">#读取模板图像文件</span></span>
<span><span class="va">tmpl</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/orange_templ.jpg"</span><span class="op">)</span></span>
<span><span class="co">#获得模板图像基本信息</span></span>
<span><span class="va">tmpl_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">tmpl</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#按TM_CCORR_NORMED匹配方法依照templ对img进行模板匹配，结果保存在res中</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_matchTemplate</span><span class="op">(</span><span class="va">img</span>,<span class="va">tmpl</span>,<span class="va">res</span>,<span class="va">TM_CCORR_NORMED</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对res进行归一化（最大最小值方式）</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">res</span>, <span class="va">res</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#由于res的尺寸与原图像有差异，不好对比结果</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">res_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="va">res1</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">roi</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">res1</span>,<span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="va">res_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">res_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">roi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res1_mat</span> <span class="op">=</span> <span class="va">res1</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#匹配值为255的</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">res1_mat</span><span class="op">==</span><span class="fl">255</span>,arr.ind<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span></span>
<span>  <span class="va">img</span>,</span>
<span>  <span class="fu">Point</span><span class="op">(</span><span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">Point</span><span class="op">(</span><span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">width</span> , <span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>  <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,</span>
<span>  <span class="fl">2</span>,</span>
<span>  <span class="fl">8</span>,</span>
<span>  <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#匹配值为200的</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">res1_mat</span><span class="op">==</span><span class="fl">200</span>,arr.ind<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span></span>
<span>  <span class="va">img</span>,</span>
<span>  <span class="fu">Point</span><span class="op">(</span><span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">Point</span><span class="op">(</span><span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">width</span> , <span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">tmpl_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>  <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,</span>
<span>  <span class="fl">2</span>,</span>
<span>  <span class="fl">8</span>,</span>
<span>  <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-89-1.png" width="672"></div>
</div>
<div id="查找轮廓" class="section level2" number="7.9">
<h2>
<span class="header-section-number">7.9</span> 查找轮廓<a class="anchor" aria-label="anchor" href="#%E6%9F%A5%E6%89%BE%E8%BD%AE%E5%BB%93"><i class="fas fa-link"></i></a>
</h2>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/contour.png"</span><span class="op">)</span></span>
<span><span class="co">#使用Canny函数提取边缘，结果保存在edges中</span></span>
<span><span class="va">edges</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img</span>,<span class="va">edges</span>,<span class="fl">100</span>,<span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#显示edges，会发现存在6条边缘线</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'edges'</span>,<span class="va">edges</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在edges中查找轮廓，轮廓点保存在contours中，轮廓的层次结构保存在hierarchy中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#轮廓查找模式为RETR_EXTERNAL，即只检测外轮廓</span></span>
<span><span class="co">#轮廓查找方法为CHAIN_APPROX_NONE，即要保存物体边界上所有连续的轮廓点</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">edges</span>,<span class="va">contours</span>,<span class="va">hierarchy</span>,</span>
<span>                  <span class="va">RETR_EXTERNAL</span>,<span class="va">CHAIN_APPROX_NONE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看contours</span></span>
<span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb1212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">outToConsole</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [25, 24]</code></pre>
<div class="sourceCode" id="cb1214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#查看轮廓</span></span>
<span><span class="va">hierarchy</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb1216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchy</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">outToConsole</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [-1, -1, -1, -1]</code></pre>
<p>结果表明，contours中只包含一个轮廓（即最外层轮廓），所以hierarchy中也只有1条数据，且所有元素都是-1（即不存在前后关系、父子关系和嵌套关系）。可以将寻找到的轮廓绘制到原图上：</p>
<div class="sourceCode" id="cb1218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#在img上绘制contours中的轮廓</span></span>
<span><span class="co">#第三个参数（即contourIdx）为-1时，意味着绘制contours中的所有轮廓</span></span>
<span><span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">img</span>,<span class="va">contours</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'img'</span>,<span class="va">img</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-93-1.png" width="672"></div>
<p>从结果可以看出，contours中的轮廓数据确实是外层轮廓。</p>
<p>将上面代码中的轮廓查找方法为CHAIN_APPROX_SIMPLE，则返回的contours结果中会仅仅包含轮廓的拐点信息，数据量会大大减少（从840个点减少为7个点）：</p>
<p>可以将contours转变为数据框，便于查看7个点的坐标：</p>
<div class="sourceCode" id="cb1219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contours_daf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pt</span> <span class="op">=</span> <span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">contours_daf</span> <span class="op">=</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">contours_daf</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">pt</span><span class="op">$</span><span class="va">x</span>,y<span class="op">=</span><span class="va">pt</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">contours_daf</span></span></code></pre></div>
<pre><code>##     x   y
## 1  25  24
## 2  23  26
## 3  23 227
## 4  24 228
## 5 241 228
## 6 241  25
## 7 240  24</code></pre>
<p><strong>示例</strong></p>
<p>以下代码演示使用RETR_LIST来查找所有的轮廓，包括内围、外围轮廓。在这种查找模式下，不对查找到的轮廓建立父子关系和嵌套关系，也即轮廓层次结构中所有元素的第3、第4个分量都会被置为-1。</p>
<div class="sourceCode" id="cb1221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/contour.png"</span><span class="op">)</span></span>
<span><span class="co">#使用Canny函数提取边缘，结果保存在edges中</span></span>
<span><span class="va">edges</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img</span>,<span class="va">edges</span>,<span class="fl">100</span>,<span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在edges中查找轮廓，轮廓点保存在contours中，轮廓的层次结构保存在hierarchy中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#轮廓查找模式为RETR_LIST，即检测所有的轮廓，包括内围、外围轮廓</span></span>
<span><span class="co">#轮廓查找方法为CHAIN_APPROX_SIMPLE，即仅保存轮廓的拐点信息</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">edges</span>,<span class="va">contours</span>,<span class="va">hierarchy</span>,</span>
<span>                  <span class="va">RETR_LIST</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看contours</span></span>
<span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 12</code></pre>
<div class="sourceCode" id="cb1223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,<span class="kw">function</span><span class="op">(</span><span class="va">ind</span><span class="op">)</span> <span class="va">contours</span><span class="op">[[</span><span class="va">ind</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] 48 64 72 86 32 48  8  7  8  7  8  7</code></pre>
<div class="sourceCode" id="cb1225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#查看轮廓</span></span>
<span><span class="va">hierarchy</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 12</code></pre>
<div class="sourceCode" id="cb1227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchy</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">outToConsole</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1, -1, -1, -1]</code></pre>
<div class="sourceCode" id="cb1229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchy</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">outToConsole</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [2, 0, -1, -1]</code></pre>
<div class="sourceCode" id="cb1231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchy</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">outToConsole</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [3, 1, -1, -1]</code></pre>
<p>结果表明，contours中包含12个轮廓（6条边缘都有内外两个轮廓），这些轮廓的前后顺序体现在hierarchy中——从hierarchy的第2个元素可以看出，contours的第2个轮廓的next值为2，所以其后一个轮廓是第3个，而previous的值为0，所以其前一个轮廓是第1个。</p>
<p>进一步，可以通过如下代码标注一下这12个轮廓在原图的位置：</p>
<div class="sourceCode" id="cb1233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#获取图像的基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#获取每个轮廓上的点</span></span>
<span><span class="va">contours_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">contours_daf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pt</span> <span class="op">=</span> <span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">contours_daf</span> <span class="op">=</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">contours_daf</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">pt</span><span class="op">$</span><span class="va">x</span>,y<span class="op">=</span><span class="va">pt</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">contours_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">contours_list</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">contours_daf</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#绘制每条轮廓线，标注其编号</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"n"</span>,</span>
<span>     xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">contours_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#将每个轮廓点数据转变为数据框</span></span>
<span>  <span class="va">contours_daf</span> <span class="op">=</span> <span class="va">contours_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co">#绘制轮廓</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">contours_daf</span><span class="op">)</span></span>
<span>  <span class="co">#按i的奇偶性控制标注文本的横向偏移（以便看出同一条边缘的两个轮廓编号）</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#i为偶数，标注文本向右偏移</span></span>
<span>    <span class="va">hadj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="co">#i为奇数，标注文本不偏移</span></span>
<span>    <span class="va">hadj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#标注轮廓的编号</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">contours_daf</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">contours_daf</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span>,adj<span class="op">=</span><span class="va">hadj</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-99-1.png" width="672"></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-100-1.png" width="672"></div>
<p>由于绘制的结果是在笛卡尔坐标系中，需要将绘制结果上下颠倒之后再与原图形对照观察。如果希望直接采用图像的像素坐标系，可以使用如下代码：</p>
<div class="sourceCode" id="cb1234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#获取图像的基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#绘制每条轮廓线，标注其编号</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"n"</span>,</span>
<span>     xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">""</span>,ylab<span class="op">=</span><span class="st">""</span>,xaxt<span class="op">=</span><span class="st">"n"</span>,yaxt<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span>side<span class="op">=</span><span class="fl">2</span>,at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span>,by<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,labels<span class="op">=</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span>,by<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span>side<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">contours_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#将每个轮廓点数据转变为数据框</span></span>
<span>  <span class="va">contours_daf</span> <span class="op">=</span> <span class="va">contours_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co">#调整点的纵坐标值（像素坐标系，纵轴正向指向下方）</span></span>
<span>  <span class="va">contours_daf</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="va">img_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span> <span class="va">contours_daf</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="co">#绘制轮廓</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">contours_daf</span><span class="op">)</span></span>
<span>  <span class="co">#按i的奇偶性控制标注文本的横向偏移（以便看出同一条边缘的两个轮廓编号）</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#i为偶数，标注文本向右偏移</span></span>
<span>    <span class="va">hadj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="co">#i为奇数，标注文本不偏移</span></span>
<span>    <span class="va">hadj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#标注轮廓的编号</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">contours_daf</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">contours_daf</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span>,adj<span class="op">=</span><span class="va">hadj</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-101-1.png" width="672"></div>
<p><strong>示例</strong></p>
<p>以下代码演示了动态调整Canny函数的上下阈值时，轮廓查找结果也会跟着变化：</p>
<div class="sourceCode" id="cb1235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#定义滑动条滑动事件的响应函数</span></span>
<span><span class="va">thresh_callback</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">val</span>, <span class="va">param</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#获取控制下阈值的滑动条的当前取值，存入thresh中，上阈值设定为下阈值的2倍</span></span>
<span>  <span class="va">thresh</span> <span class="op">=</span> <span class="fu">cv_getTrackbarPos</span><span class="op">(</span><span class="st">"Canny thresh:"</span>, <span class="va">source_window</span><span class="op">)</span></span>
<span>  <span class="co">#对src_gray进行边缘检测，结果保存在canny_output中</span></span>
<span>  <span class="va">canny_output</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_Canny</span><span class="op">(</span><span class="va">src_gray</span>, <span class="va">canny_output</span>, <span class="va">thresh</span>, <span class="va">thresh</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co">#获取canny_output的基本信息</span></span>
<span>  <span class="va">canny_output_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">canny_output</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#在canny_output中查找轮廓，轮廓点保存在contours，轮廓层次保存在hierarchy中</span></span>
<span>  <span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_findContours</span><span class="op">(</span><span class="va">canny_output</span>,</span>
<span>                    <span class="va">contours</span>,</span>
<span>                    <span class="va">hierarchy</span>,</span>
<span>                    <span class="va">RETR_TREE</span>,</span>
<span>                    <span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#按canny_ouput的尺寸生成8位无符号3通道图像矩阵drawing，</span></span>
<span>  <span class="co">#所有像素的值都为黑色c(0,0,0)</span></span>
<span>  <span class="va">drawing</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">canny_output_info</span><span class="op">$</span><span class="va">height</span>,</span>
<span>                           <span class="va">canny_output_info</span><span class="op">$</span><span class="va">width</span>,</span>
<span>                           <span class="va">CV_8UC3</span><span class="op">)</span></span>
<span>  <span class="co">#在drawing中绘制每个轮廓</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="co">#随机设定轮廓绘制颜色</span></span>
<span>    <span class="va">ccolor</span> <span class="op">=</span> <span class="fu">Scalar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co">#绘制第i个轮廓</span></span>
<span>    <span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">drawing</span>, <span class="va">contours</span>, <span class="va">i</span>, <span class="va">ccolor</span>, <span class="fl">2</span>, <span class="va">LINE_8</span>, <span class="va">hierarchy</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#将drawing显示在标题为contours的图形窗口中</span></span>
<span>  <span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Contours"</span>, <span class="va">drawing</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/HappyFish.jpg"</span><span class="op">)</span></span>
<span><span class="co">#将src转变为灰度图，结果保存在src_gray中</span></span>
<span><span class="va">src_gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">src</span>, <span class="va">src_gray</span>, <span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span><span class="co">#对src_gray进行归一化盒子滤波，结果保存在src_gray中</span></span>
<span><span class="fu">cv_blur</span><span class="op">(</span><span class="va">src_gray</span>, <span class="va">src_gray</span>, <span class="fu">Size</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成标题为Source的图形窗口，并显示src</span></span>
<span><span class="va">source_window</span> <span class="op">=</span> <span class="st">"Source"</span></span>
<span><span class="fu">cv_namedWindow</span><span class="op">(</span><span class="va">source_window</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="va">source_window</span>, <span class="va">src</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在标题为Source的图形窗口中创建控制下阈值的滑动条</span></span>
<span><span class="fu">cv_createTrackbar</span><span class="op">(</span><span class="st">"Canny thresh:"</span>,</span>
<span>                  <span class="va">source_window</span>,</span>
<span>                  <span class="fl">30</span>,</span>
<span>                  <span class="fl">255</span>,</span>
<span>                  <span class="va">thresh_callback</span><span class="op">)</span></span>
<span><span class="co">#调用thresh_callback函数</span></span>
<span><span class="fu">thresh_callback</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="计算最小包含凸集凸包" class="section level2" number="7.10">
<h2>
<span class="header-section-number">7.10</span> 计算最小包含凸集（凸包）<a class="anchor" aria-label="anchor" href="#%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%8C%85%E5%90%AB%E5%87%B8%E9%9B%86%E5%87%B8%E5%8C%85"><i class="fas fa-link"></i></a>
</h2>
<p>在图像处理过程中，常常需要寻找图像中能包含一个物体的最小凸集——是所有能包含这个物体的凸集的交集。</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-103-1.png" width="672"></div>
<p>在上图中，红色线条所包围的区域即为黄色海星的凸包。</p>
<p>OpenCV在<strong>convexHull</strong>函数中封装了凸包计算操作。主要步骤：</p>
<ul>
<li>对图像进行边缘检测，形成边缘数据<br>
</li>
<li>对边缘数据进行轮廓检测，形成轮廓数据（是点的集合）</li>
<li>对轮廓（点集）进行凸包计算</li>
</ul>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算一个点集的凸包：</p>
<div class="sourceCode" id="cb1236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">60</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成一个300行300列的8位无符号三通道图像矩阵img，所有像素值都为(0,0,0)</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">300</span>,<span class="fl">300</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在img上，分别以70个点为圆心，3为半径的黄色填充小圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="fl">3</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pnts.list，</span></span>
<span><span class="co">#以便作为convexHull函数的points参数</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#针对pntsVec的点集，计算其凸包（点集）</span></span>
<span><span class="va">hull</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_convexHull</span><span class="op">(</span><span class="va">pntsVec</span>,<span class="va">hull</span><span class="op">)</span></span>
<span><span class="co">#使用多边形绘制函数在img上绘制凸包</span></span>
<span><span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">hull</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-105-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm.png"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用Canny函数对img提取边缘，结果保存在img.canny中</span></span>
<span><span class="va">img_canny</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_canny</span>,<span class="fl">300</span>,<span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在img.canny中查找轮廓，轮廓点保存在contours中，轮廓的层次结构保存在hierarchy中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">img_canny</span>,<span class="va">contours</span>,<span class="va">hierarchy</span>,</span>
<span>                  <span class="va">RETR_TREE</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对contours的每个轮廓（点集）计算凸包，并绘制在img上</span></span>
<span><span class="va">hull</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,<span class="kw">function</span><span class="op">(</span><span class="va">ind</span><span class="op">)</span> <span class="va">contours</span><span class="op">[[</span><span class="va">ind</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="va">pos</span><span class="op">-</span><span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">cv_convexHull</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="va">hull</span><span class="op">)</span>  </span>
<span>  <span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">hull</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'img'</span>,<span class="va">img</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-107-1.png" width="672"></div>
<p>进一步，可以只针对contours中包含点数最多的轮廓计算凸包：</p>
<div class="sourceCode" id="cb1238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm.png"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用Canny函数对img提取边缘，结果保存在img_canny中</span></span>
<span><span class="va">img_canny</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_canny</span>,<span class="fl">300</span>,<span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在img.canny中查找轮廓，轮廓点保存在contours中，轮廓的层次结构保存在hierarchy中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">img_canny</span>,<span class="va">contours</span>,<span class="va">hierarchy</span>,</span>
<span>                  <span class="va">RETR_TREE</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对contours中包含点数最多的轮廓计算凸包，并绘制在img上</span></span>
<span><span class="va">hull</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,<span class="kw">function</span><span class="op">(</span><span class="va">ind</span><span class="op">)</span> <span class="va">contours</span><span class="op">[[</span><span class="va">ind</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="va">pos</span><span class="op">-</span><span class="fl">1</span></span>
<span><span class="fu">cv_convexHull</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">pos</span><span class="op">]</span><span class="op">]</span>,<span class="va">hull</span><span class="op">)</span>  </span>
<span><span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">hull</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'img'</span>,<span class="va">img</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-109-1.png" width="672"></div>
</div>
<div id="计算最小包含矩形圆形或者三角形" class="section level2" number="7.11">
<h2>
<span class="header-section-number">7.11</span> 计算最小包含矩形、圆形或者三角形<a class="anchor" aria-label="anchor" href="#%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%8C%85%E5%90%AB%E7%9F%A9%E5%BD%A2%E5%9C%86%E5%BD%A2%E6%88%96%E8%80%85%E4%B8%89%E8%A7%92%E5%BD%A2"><i class="fas fa-link"></i></a>
</h2>
<p>OpenCV在<strong>boundingRect</strong>函数、<strong>minEnclosingCircle</strong>函数和<strong>minEnclosingTriangle</strong>函数中分别封装了计算能够包含一个物体的最小矩形、最小圆形和最小三角形。</p>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算包含一个点集的最小矩形：</p>
<div class="sourceCode" id="cb1239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成一个300行300列的8位无符号三通道图像矩阵img，所有像素值都为(0,0,0)</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">300</span>,<span class="fl">300</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在img上，分别以70个点为圆心，3为半径的黄色填充小圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pntsVec</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#针对pntsVec的点集，计算其最小包含矩形</span></span>
<span><span class="va">brect</span> <span class="op">=</span> <span class="fu">cv_boundingRect</span><span class="op">(</span><span class="va">pntsVec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在img上绘制包含点集的最小矩形</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span><span class="va">img</span>,<span class="va">brect</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-111-1.png" width="672"></div>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算包含一个点集的最小圆形：</p>
<div class="sourceCode" id="cb1240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成一个300行300列的8位无符号三通道图像矩阵img，所有像素值都为(0,0,0)</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">300</span>,<span class="fl">300</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在img上，分别以70个点为圆心，3为半径的黄色填充小圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pntsVec</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#针对pnts.list的点集，计算其最小包含圆形</span></span>
<span><span class="va">center</span> <span class="op">=</span> <span class="fu">Point2f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">radius</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="fu">cv_minEnclosingCircle</span><span class="op">(</span><span class="va">pntsVec</span>,<span class="va">center</span>,<span class="va">radius</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在img上绘制包含点集的最小圆形</span></span>
<span><span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">center</span><span class="op">$</span><span class="va">x</span>,<span class="va">center</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">radius</span><span class="op">)</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-113-1.png" width="672"></div>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算包含一个点集的最小三角形：</p>
<div class="sourceCode" id="cb1241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成一个300行300列的8位无符号三通道图像矩阵img，所有像素值都为(0,0,0)</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">300</span>,<span class="fl">300</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在img上，分别以70个点为圆心，3为半径的黄色填充小圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pntsVec</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#针对pnts.list的点集，计算其最小包含三角形</span></span>
<span><span class="va">tri</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_minEnclosingTriangle</span><span class="op">(</span><span class="va">pntsVec</span>,<span class="va">tri</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 12363.89</code></pre>
<div class="sourceCode" id="cb1243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#在img上绘制包含点集的最小三角形</span></span>
<span><span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">tri</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-115-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/balloon.png"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#检测img的边缘，结果保存在canny_output中</span></span>
<span><span class="va">canny_output</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img</span>, <span class="va">canny_output</span>, <span class="fl">200</span>, <span class="fl">200</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查找canny_output中的轮廓，结果保存在controus中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">canny_output</span>,</span>
<span>                    <span class="va">contours</span>,</span>
<span>                    <span class="va">RETR_EXTERNAL</span>,</span>
<span>                    <span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算每个轮廓（点集）的最小包含矩形、最小包含圆形和最小包含三角形，且绘制在img上</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#计算第i个轮廓（点集）的最小包含矩形</span></span>
<span>  <span class="va">brect</span> <span class="op">=</span> <span class="fu">cv_boundingRect</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#在img上绘制最小包含矩形</span></span>
<span>  <span class="fu">cv_rectangle</span><span class="op">(</span><span class="va">img</span>,<span class="va">brect</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#计算第i个轮廓（点集）的最小包含圆形</span></span>
<span>  <span class="va">center</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">radius</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="fu">cv_minEnclosingCircle</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="va">center</span>,<span class="va">radius</span><span class="op">)</span></span>
<span>  <span class="co">#在img上绘制最小圆形</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="va">center</span>,<span class="va">radius</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#计算第i个轮廓（点集）的最小包含三角形</span></span>
<span>  <span class="va">tri</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_minEnclosingTriangle</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="va">tri</span><span class="op">)</span></span>
<span>  <span class="co">#在img上绘制最小三角形</span></span>
<span>  <span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">tri</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-117-1.png" width="672"></div>
</div>
<div id="计算最小包含旋转矩形或者椭圆" class="section level2" number="7.12">
<h2>
<span class="header-section-number">7.12</span> 计算最小包含旋转矩形或者椭圆<a class="anchor" aria-label="anchor" href="#%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%8C%85%E5%90%AB%E6%97%8B%E8%BD%AC%E7%9F%A9%E5%BD%A2%E6%88%96%E8%80%85%E6%A4%AD%E5%9C%86"><i class="fas fa-link"></i></a>
</h2>
<p>OpenCV在<strong>minAreaRect</strong>函数和<strong>fitEllipse</strong>函数中分别封装了计算能够包含一个物体的最小旋转矩形和最小椭圆形。</p>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算包含一个点集的最小矩形和最小旋转矩形：</p>
<div class="sourceCode" id="cb1245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成一个300行300列的8位无符号三通道图像矩阵img，所有像素值都为(0,0,0)</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">300</span>,<span class="fl">300</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在img上，分别以70个点为圆心，3为半径的黄色填充小圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pntsVec</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#针对pntsVec的点集，计算其最小包含矩形，结果保存在brect中</span></span>
<span><span class="va">brect</span> <span class="op">=</span> <span class="fu">cv_boundingRect</span><span class="op">(</span><span class="va">pntsVec</span><span class="op">)</span></span>
<span><span class="co">#在img上绘制包含点集的最小矩形</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span><span class="va">img</span>,<span class="va">brect</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#针对pnts.list的点集，计算其最小包含旋转矩形，结果保存在bminAreaRect中</span></span>
<span><span class="va">bminAreaRect</span> <span class="op">=</span> <span class="fu">cv_minAreaRect</span><span class="op">(</span><span class="va">pntsVec</span><span class="op">)</span></span>
<span><span class="co">#获取bminAreaRect的端点集，保存在vtx中</span></span>
<span><span class="va">vtx</span> <span class="op">=</span> <span class="fu">stdVecOfPoint2f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bminAreaRect</span><span class="op">$</span><span class="fu">points</span><span class="op">(</span><span class="va">vtx</span><span class="op">)</span></span>
<span><span class="co">#在img上绘制最小旋转矩形</span></span>
<span><span class="va">vtx1</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">vtx</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">vtx1</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">vtx</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">vtx</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">vtx1</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-119-1.png" width="672"></div>
<p><strong>示例</strong></p>
<p>以下代码演示了如何计算包含一个点集的最小圆形和最小椭圆形：</p>
<div class="sourceCode" id="cb1246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">30</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">70</span>,mean<span class="op">=</span><span class="fl">150</span>,sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成一个300行300列的8位无符号三通道图像矩阵img，所有像素值都为(0,0,0)</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">300</span>,<span class="fl">300</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在img上，分别以70个点为圆心，3为半径的黄色填充小圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pnts.list</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#针对pntsVec的点集，计算其最小包含圆形</span></span>
<span><span class="va">center</span> <span class="op">=</span> <span class="fu">Point2f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">radius</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="fu">cv_minEnclosingCircle</span><span class="op">(</span><span class="va">pntsVec</span>,<span class="va">center</span>,<span class="va">radius</span><span class="op">)</span></span>
<span><span class="co">#在img上绘制包含点集的最小圆形</span></span>
<span><span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="va">center</span><span class="op">$</span><span class="va">x</span>,<span class="va">center</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,<span class="va">radius</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#针对pntsVec的点集，计算其最小椭圆</span></span>
<span><span class="va">bellipse</span> <span class="op">=</span> <span class="fu">cv_fitEllipse</span><span class="op">(</span><span class="va">pntsVec</span><span class="op">)</span></span>
<span><span class="co">#在img上绘制包含点集的最小椭圆</span></span>
<span><span class="fu">cv_ellipse</span><span class="op">(</span><span class="va">img</span>,<span class="va">bellipse</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-121-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/palm.png"</span><span class="op">)</span></span>
<span><span class="co">#检测img的边缘，结果保存在canny_output中</span></span>
<span><span class="va">canny_output</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img</span>, <span class="va">canny_output</span>, <span class="fl">100</span>, <span class="fl">200</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查找canny_output中的轮廓，结果保存在controus中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">canny_output</span>,</span>
<span>                    <span class="va">contours</span>,</span>
<span>                    <span class="va">RETR_EXTERNAL</span>,</span>
<span>                    <span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算每个轮廓（点集）的最小包含旋转矩形和最小包含椭圆，且绘制在img上</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#计算第i个轮廓（点集）的最小包含旋转，结果保存在bminAreaRect中</span></span>
<span>  <span class="va">bminAreaRect</span> <span class="op">=</span> <span class="fu">cv_minAreaRect</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#获取bminAreaRect的端点集，保存在vtx中</span></span>
<span>  <span class="va">vtx</span> <span class="op">=</span> <span class="fu">stdVecOfPoint2f</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">bminAreaRect</span><span class="op">$</span><span class="fu">points</span><span class="op">(</span><span class="va">vtx</span><span class="op">)</span></span>
<span>  <span class="co">#在img上绘制最小旋转矩形</span></span>
<span>  <span class="va">vtx1</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">vtx</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">vtx1</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">vtx</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">vtx</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">cv_polylines</span><span class="op">(</span><span class="va">img</span>,<span class="va">vtx1</span>,<span class="cn">TRUE</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#计算第i个轮廓（点集）的最小包含椭圆形</span></span>
<span>  <span class="va">bellipse</span> <span class="op">=</span> <span class="fu">cv_fitEllipse</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#在img上绘制包含点集的最小椭圆</span></span>
<span>  <span class="fu">cv_ellipse</span><span class="op">(</span><span class="va">img</span>,<span class="va">bellipse</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-123-1.png" width="672"></div>
</div>
<div id="图像的矩" class="section level2" number="7.13">
<h2>
<span class="header-section-number">7.13</span> 图像的矩<a class="anchor" aria-label="anchor" href="#%E5%9B%BE%E5%83%8F%E7%9A%84%E7%9F%A9"><i class="fas fa-link"></i></a>
</h2>
<p>一幅<span class="math inline">\(M \times N\)</span>的数字图像<span class="math inline">\(f(i,j)\)</span>，其<span class="math inline">\(p+q\)</span>阶几何矩<span class="math inline">\(m_{pq}\)</span>和中心矩<span class="math inline">\(μ_{pq}\)</span>为：</p>
<p><span class="math display">\[
m_{pq}=\sum_{i=0}^{M-1} \sum_{j=0}^{N-1} i^q j^p f(i,j)
\]</span></p>
<p><span class="math display">\[
\mu_{pq}=\sum_{i=0}^{M-1} \sum_{j=0}^{N-1} (i− \bar i)^q (j− \bar j)^p f(i,j)
\]</span>
其中<span class="math inline">\(f(i,j)\)</span>为图像在坐标点<span class="math inline">\((i,j)\)</span>处的灰度值。<span class="math inline">\(\bar i=m_{01}/m_{00}\)</span>, <span class="math inline">\(\bar j=m_{10}/m_{00}\)</span></p>
<div class="sourceCode" id="cb1248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu">cv_moments</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $spatial_moments
##          m00          m10          m01          m20          m11          m02 
## 3.255844e+07 8.677603e+09 8.056772e+09 3.015184e+12 2.190566e+12 2.700340e+12 
##          m30          m21          m12          m03 
## 1.163589e+15 7.720377e+14 7.384593e+14 1.025977e+15 
## 
## $central_moments
##          mu20          mu11          mu02          mu30          mu21 
##  7.023951e+11  4.324367e+10  7.066459e+11 -1.443973e+13  2.862336e+12 
##          mu12          mu03 
## -2.647695e+12  8.035339e+12 
## 
## $central_normalized_moments
##          nu20          nu11          nu02          nu30          nu21 
##  6.626043e-04  4.079391e-05  6.666143e-04 -2.387262e-06  4.732184e-07 
##          nu12          nu03 
## -4.377327e-07  1.328450e-06</code></pre>
<div class="sourceCode" id="cb1250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成一个包含70个点坐标的数据框，第1列为点的横坐标，第2列为点纵坐标</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">1</span><span class="op">)</span>,y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依据数据框中的点数据，生成一个点列表pntsVec</span></span>
<span><span class="va">pntsVec</span> <span class="op">=</span> <span class="fu">stdVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pntsVec</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Point</span><span class="op">(</span><span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pnts</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu">cv_moments</span><span class="op">(</span><span class="va">pntsVec</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $spatial_moments
## m00 m10 m01 m20 m11 m02 m30 m21 m12 m03 
##   0   0   0   0   0   0   0   0   0   0 
## 
## $central_moments
## mu20 mu11 mu02 mu30 mu21 mu12 mu03 
##    0    0    0    0    0    0    0 
## 
## $central_normalized_moments
## nu20 nu11 nu02 nu30 nu21 nu12 nu03 
##    0    0    0    0    0    0    0</code></pre>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读入图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/arrow.png"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行灰度化，结果保存在img_gray中</span></span>
<span><span class="va">img_gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_gray</span>,<span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在img_gray中查找轮廓，结果保存在contours和hierarchy中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">contours</span>,<span class="va">hierarchy</span>,<span class="va">RETR_EXTERNAL</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">img</span>,<span class="va">contours</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#计算第i条轮廓（点集）的矩</span></span>
<span>  <span class="va">m</span> <span class="op">=</span> <span class="fu">cv_moments</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#计算第i条轮廓（点集）的质心坐标</span></span>
<span>  <span class="va">mass_center</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">m10</span><span class="op">/</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">m00</span><span class="op">+</span><span class="fl">1e-10</span><span class="op">)</span>,<span class="va">m</span><span class="op">$</span><span class="va">m01</span><span class="op">/</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">m00</span><span class="op">+</span><span class="fl">1e-10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#在img上以质心为圆心，4为半径，绘制一个红色填充圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="va">mass_center</span>,<span class="fl">4</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#计算第i个轮廓（点集）的最小包含椭圆形</span></span>
<span>  <span class="va">bellipse</span> <span class="op">=</span> <span class="fu">cv_fitEllipse</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#在img上绘制包含点集的最小椭圆</span></span>
<span>  <span class="fu">cv_ellipse</span><span class="op">(</span><span class="va">img</span>,<span class="va">bellipse</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'img'</span>,<span class="va">img</span><span class="op">)</span></span></code></pre></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thresh</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="co">#定义滑动条控制响应函数</span></span>
<span><span class="va">thresh_callback</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">val</span>, <span class="va">param</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#获取控制Canny算子阈值的滑动条的当前值</span></span>
<span>  <span class="va">thresh</span> <span class="op">=</span> <span class="fu">cv_getTrackbarPos</span><span class="op">(</span><span class="st">"Canny thresh:"</span>, <span class="st">"Source"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#对src_gray进行边缘检查，结果保存在canny_output中</span></span>
<span>  <span class="va">canny_output</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_Canny</span><span class="op">(</span><span class="va">src_gray</span>, <span class="va">canny_output</span>, <span class="va">thresh</span>, <span class="va">thresh</span> <span class="op">*</span> <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#获取canny_output的纪斌信息</span></span>
<span>  <span class="va">canny_output_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">canny_output</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#检查canny_output的轮廓，结果保存在contours中</span></span>
<span>  <span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_findContours</span><span class="op">(</span><span class="va">canny_output</span>,</span>
<span>                    <span class="va">contours</span>,</span>
<span>                    <span class="va">RETR_TREE</span>,</span>
<span>                    <span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#计算图像的矩</span></span>
<span>  <span class="va">mu_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">mu_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">cv_moments</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#计算质心坐标</span></span>
<span>  <span class="va">mc_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="co"># mtmp = mu_list[[i+1]]$spatial_moments</span></span>
<span>    <span class="va">mtmp</span> <span class="op">=</span> <span class="va">mu_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="co">#add 1e-5 to avoid division by zero</span></span>
<span>    <span class="co"># mc_list[[i+1]] = c(mtmp["m10"] / (mtmp["m00"] + 1e-5),</span></span>
<span>    <span class="co">#             mtmp["m01"] / (mtmp["m00"] + 1e-5))</span></span>
<span>    <span class="va">mc_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="va">mtmp</span><span class="op">$</span><span class="va">m10</span> <span class="op">/</span> <span class="op">(</span><span class="va">mtmp</span><span class="op">$</span><span class="va">m00</span> <span class="op">+</span> <span class="fl">1e-5</span><span class="op">)</span>,</span>
<span>                <span class="va">mtmp</span><span class="op">$</span><span class="va">m01</span> <span class="op">/</span> <span class="op">(</span><span class="va">mtmp</span><span class="op">$</span><span class="va">m00</span> <span class="op">+</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># cat("mc[" , i , "]=" , mc_list[[i+1]] , "\n")</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"mc["</span> , <span class="va">i</span> , <span class="st">"]="</span> , <span class="va">mc_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span>,<span class="st">","</span>,<span class="va">mc_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">y</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">#绘制轮廓并标注质心点</span></span>
<span>  <span class="va">drawing</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">canny_output_info</span><span class="op">$</span><span class="va">height</span>,</span>
<span>                           <span class="va">canny_output_info</span><span class="op">$</span><span class="va">width</span>,</span>
<span>                           <span class="va">CV_8UC3</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">ccolor</span> <span class="op">=</span> <span class="fu">Scalar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">drawing</span>, <span class="va">contours</span>, <span class="va">i</span>, <span class="va">ccolor</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="fu">cv_circle</span><span class="op">(</span><span class="va">drawing</span>, <span class="va">mc_list</span><span class="op">[[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fl">4</span>, <span class="va">ccolor</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#现实绘制结果</span></span>
<span>  <span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Contours"</span>, <span class="va">drawing</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#在控制台中输出轮廓面积和轮廓长度</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\t Info: Area and Contour Length \n"</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="co"># mtmp = cv.moments.cv2r(mu[[i]])$spatial_moments</span></span>
<span>    <span class="va">mtmp</span> <span class="op">=</span> <span class="va">mu_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span></span>
<span>      <span class="st">" * Contour["</span> ,</span>
<span>      <span class="va">i</span> ,</span>
<span>      <span class="st">"] - Area (M_00) = "</span> ,</span>
<span>      <span class="va">mtmp</span><span class="op">$</span><span class="va">m00</span>,</span>
<span>      <span class="st">" - Area OpenCV: "</span> ,</span>
<span>      <span class="fu">cv_contourArea</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> ,</span>
<span>      <span class="st">" - Length: "</span> ,</span>
<span>      <span class="fu">cv_arcLength</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="cn">TRUE</span><span class="op">)</span> ,</span>
<span>      <span class="st">"\n"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/ghosts.png"</span><span class="op">)</span></span>
<span><span class="co">#将图像灰度化，结果保存在src_gray中</span></span>
<span><span class="va">src_gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">src</span>, <span class="va">src_gray</span>, <span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span><span class="co">#进行归一化盒子滤波，结果仍然保存在src_gray中</span></span>
<span><span class="fu">cv_blur</span><span class="op">(</span><span class="va">src</span>, <span class="va">src_gray</span>, <span class="fu">Size</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#创建图形窗口并显示src</span></span>
<span><span class="fu">cv_namedWindow</span><span class="op">(</span><span class="st">"Source"</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Source"</span>, <span class="va">src</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在图形窗口上创建控制Canny算子阈值的滑动条</span></span>
<span><span class="fu">cv_createTrackbar</span><span class="op">(</span><span class="st">"Canny thresh:"</span>,</span>
<span>                  <span class="st">"Source"</span>,</span>
<span>                  <span class="fl">100</span>,</span>
<span>                  <span class="fl">255</span>,</span>
<span>                  <span class="va">thresh_callback</span><span class="op">)</span></span>
<span><span class="fu">cv_setTrackbarPos</span><span class="op">(</span><span class="st">"Canny thresh:"</span>,</span>
<span>                  <span class="st">"Source"</span>,</span>
<span>                  <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code>## mc[ 0 ]= 0 , 0 
## mc[ 1 ]= 485 , 204 
## mc[ 2 ]= 622 , 144 
## mc[ 3 ]= 624 , 140 
## mc[ 4 ]= 360 , 126 
## mc[ 5 ]= 360 , 126 
## mc[ 6 ]= 577 , 187 
## mc[ 7 ]= 595 , 121 
## mc[ 8 ]= 595 , 121 
## mc[ 9 ]= 97 , 120 
## mc[ 10 ]= 639 , 121 
## mc[ 11 ]= 639 , 121 
## mc[ 12 ]= 508 , 109 
## mc[ 13 ]= 508 , 109 
## mc[ 14 ]= 466 , 109 
## mc[ 15 ]= 466 , 109 
## mc[ 16 ]= 358 , 106 
## mc[ 17 ]= 358 , 106 
## mc[ 18 ]= 625 , 152 
## mc[ 19 ]= 482 , 133 
## mc[ 20 ]= 365 , 147 
## mc[ 21 ]= 74 , 141 
## mc[ 22 ]= 227 , 123 
## mc[ 23 ]= 227 , 123 
## mc[ 24 ]= 227 , 81 
## mc[ 25 ]= 227 , 81 
## mc[ 26 ]= 226 , 68 
## mc[ 27 ]= 226 , 68 
## mc[ 28 ]= 259 , 62 
## mc[ 29 ]= 259 , 62 
## mc[ 30 ]= 197 , 61 
## mc[ 31 ]= 197 , 61 
##   Info: Area and Contour Length 
##  * Contour[ 0 ] - Area (M_00) =  0  - Area OpenCV:  0  - Length:  0 
##  * Contour[ 1 ] - Area (M_00) =  76  - Area OpenCV:  76  - Length:  673.328 
##  * Contour[ 2 ] - Area (M_00) =  8  - Area OpenCV:  8  - Length:  48.28427 
##  * Contour[ 3 ] - Area (M_00) =  7.5  - Area OpenCV:  7.5  - Length:  251.0122 
##  * Contour[ 4 ] - Area (M_00) =  259.5  - Area OpenCV:  259.5  - Length:  135.3553 
##  * Contour[ 5 ] - Area (M_00) =  238  - Area OpenCV:  238  - Length:  121.4558 
##  * Contour[ 6 ] - Area (M_00) =  22  - Area OpenCV:  22  - Length:  300.3087 
##  * Contour[ 7 ] - Area (M_00) =  281.5  - Area OpenCV:  281.5  - Length:  62.87006 
##  * Contour[ 8 ] - Area (M_00) =  263.5  - Area OpenCV:  263.5  - Length:  60.52691 
##  * Contour[ 9 ] - Area (M_00) =  11.5  - Area OpenCV:  11.5  - Length:  96.66905 
##  * Contour[ 10 ] - Area (M_00) =  290  - Area OpenCV:  290  - Length:  64.28427 
##  * Contour[ 11 ] - Area (M_00) =  275  - Area OpenCV:  275  - Length:  61.94113 
##  * Contour[ 12 ] - Area (M_00) =  192  - Area OpenCV:  192  - Length:  51.79899 
##  * Contour[ 13 ] - Area (M_00) =  179  - Area OpenCV:  179  - Length:  49.45584 
##  * Contour[ 14 ] - Area (M_00) =  195.5  - Area OpenCV:  195.5  - Length:  53.2132 
##  * Contour[ 15 ] - Area (M_00) =  182.5  - Area OpenCV:  182.5  - Length:  50.87006 
##  * Contour[ 16 ] - Area (M_00) =  331  - Area OpenCV:  331  - Length:  68.28427 
##  * Contour[ 17 ] - Area (M_00) =  314  - Area OpenCV:  314  - Length:  65.94112 
##  * Contour[ 18 ] - Area (M_00) =  84  - Area OpenCV:  84  - Length:  1174.264 
##  * Contour[ 19 ] - Area (M_00) =  107.5  - Area OpenCV:  107.5  - Length:  867.3351 
##  * Contour[ 20 ] - Area (M_00) =  155.5  - Area OpenCV:  155.5  - Length:  1291.869 
##  * Contour[ 21 ] - Area (M_00) =  130.5  - Area OpenCV:  130.5  - Length:  1428.698 
##  * Contour[ 22 ] - Area (M_00) =  23029  - Area OpenCV:  23029  - Length:  899.8377 
##  * Contour[ 23 ] - Area (M_00) =  22852  - Area OpenCV:  22852  - Length:  899.1514 
##  * Contour[ 24 ] - Area (M_00) =  404.5  - Area OpenCV:  404.5  - Length:  203.6985 
##  * Contour[ 25 ] - Area (M_00) =  385  - Area OpenCV:  385  - Length:  193.4558 
##  * Contour[ 26 ] - Area (M_00) =  321.5  - Area OpenCV:  321.5  - Length:  72.04163 
##  * Contour[ 27 ] - Area (M_00) =  307.5  - Area OpenCV:  307.5  - Length:  69.69848 
##  * Contour[ 28 ] - Area (M_00) =  511  - Area OpenCV:  511  - Length:  85.59798 
##  * Contour[ 29 ] - Area (M_00) =  486  - Area OpenCV:  486  - Length:  83.25483 
##  * Contour[ 30 ] - Area (M_00) =  523  - Area OpenCV:  523  - Length:  85.59798 
##  * Contour[ 31 ] - Area (M_00) =  500  - Area OpenCV:  500  - Length:  83.25483</code></pre>
<div class="sourceCode" id="cb1255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#调用thresh_callback函数</span></span>
<span><span class="fu">thresh_callback</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code>## mc[ 0 ]= 0 , 0 
## mc[ 1 ]= 485 , 204 
## mc[ 2 ]= 622 , 144 
## mc[ 3 ]= 624 , 140 
## mc[ 4 ]= 360 , 126 
## mc[ 5 ]= 360 , 126 
## mc[ 6 ]= 577 , 187 
## mc[ 7 ]= 595 , 121 
## mc[ 8 ]= 595 , 121 
## mc[ 9 ]= 97 , 120 
## mc[ 10 ]= 639 , 121 
## mc[ 11 ]= 639 , 121 
## mc[ 12 ]= 508 , 109 
## mc[ 13 ]= 508 , 109 
## mc[ 14 ]= 466 , 109 
## mc[ 15 ]= 466 , 109 
## mc[ 16 ]= 358 , 106 
## mc[ 17 ]= 358 , 106 
## mc[ 18 ]= 625 , 152 
## mc[ 19 ]= 482 , 133 
## mc[ 20 ]= 365 , 147 
## mc[ 21 ]= 74 , 141 
## mc[ 22 ]= 227 , 123 
## mc[ 23 ]= 227 , 123 
## mc[ 24 ]= 227 , 81 
## mc[ 25 ]= 227 , 81 
## mc[ 26 ]= 226 , 68 
## mc[ 27 ]= 226 , 68 
## mc[ 28 ]= 259 , 62 
## mc[ 29 ]= 259 , 62 
## mc[ 30 ]= 197 , 61 
## mc[ 31 ]= 197 , 61 
##   Info: Area and Contour Length 
##  * Contour[ 0 ] - Area (M_00) =  0  - Area OpenCV:  0  - Length:  0 
##  * Contour[ 1 ] - Area (M_00) =  76  - Area OpenCV:  76  - Length:  673.328 
##  * Contour[ 2 ] - Area (M_00) =  8  - Area OpenCV:  8  - Length:  48.28427 
##  * Contour[ 3 ] - Area (M_00) =  7.5  - Area OpenCV:  7.5  - Length:  251.0122 
##  * Contour[ 4 ] - Area (M_00) =  259.5  - Area OpenCV:  259.5  - Length:  135.3553 
##  * Contour[ 5 ] - Area (M_00) =  238  - Area OpenCV:  238  - Length:  121.4558 
##  * Contour[ 6 ] - Area (M_00) =  22  - Area OpenCV:  22  - Length:  300.3087 
##  * Contour[ 7 ] - Area (M_00) =  281.5  - Area OpenCV:  281.5  - Length:  62.87006 
##  * Contour[ 8 ] - Area (M_00) =  263.5  - Area OpenCV:  263.5  - Length:  60.52691 
##  * Contour[ 9 ] - Area (M_00) =  11.5  - Area OpenCV:  11.5  - Length:  96.66905 
##  * Contour[ 10 ] - Area (M_00) =  290  - Area OpenCV:  290  - Length:  64.28427 
##  * Contour[ 11 ] - Area (M_00) =  275  - Area OpenCV:  275  - Length:  61.94113 
##  * Contour[ 12 ] - Area (M_00) =  192  - Area OpenCV:  192  - Length:  51.79899 
##  * Contour[ 13 ] - Area (M_00) =  179  - Area OpenCV:  179  - Length:  49.45584 
##  * Contour[ 14 ] - Area (M_00) =  195.5  - Area OpenCV:  195.5  - Length:  53.2132 
##  * Contour[ 15 ] - Area (M_00) =  182.5  - Area OpenCV:  182.5  - Length:  50.87006 
##  * Contour[ 16 ] - Area (M_00) =  331  - Area OpenCV:  331  - Length:  68.28427 
##  * Contour[ 17 ] - Area (M_00) =  314  - Area OpenCV:  314  - Length:  65.94112 
##  * Contour[ 18 ] - Area (M_00) =  84  - Area OpenCV:  84  - Length:  1174.264 
##  * Contour[ 19 ] - Area (M_00) =  107.5  - Area OpenCV:  107.5  - Length:  867.3351 
##  * Contour[ 20 ] - Area (M_00) =  155.5  - Area OpenCV:  155.5  - Length:  1291.869 
##  * Contour[ 21 ] - Area (M_00) =  130.5  - Area OpenCV:  130.5  - Length:  1428.698 
##  * Contour[ 22 ] - Area (M_00) =  23029  - Area OpenCV:  23029  - Length:  899.8377 
##  * Contour[ 23 ] - Area (M_00) =  22852  - Area OpenCV:  22852  - Length:  899.1514 
##  * Contour[ 24 ] - Area (M_00) =  404.5  - Area OpenCV:  404.5  - Length:  203.6985 
##  * Contour[ 25 ] - Area (M_00) =  385  - Area OpenCV:  385  - Length:  193.4558 
##  * Contour[ 26 ] - Area (M_00) =  321.5  - Area OpenCV:  321.5  - Length:  72.04163 
##  * Contour[ 27 ] - Area (M_00) =  307.5  - Area OpenCV:  307.5  - Length:  69.69848 
##  * Contour[ 28 ] - Area (M_00) =  511  - Area OpenCV:  511  - Length:  85.59798 
##  * Contour[ 29 ] - Area (M_00) =  486  - Area OpenCV:  486  - Length:  83.25483 
##  * Contour[ 30 ] - Area (M_00) =  523  - Area OpenCV:  523  - Length:  85.59798 
##  * Contour[ 31 ] - Area (M_00) =  500  - Area OpenCV:  500  - Length:  83.25483</code></pre>
<pre><code>## mc[ 0 ]= 0 0 
## mc[ 1 ]= 485 204 
## mc[ 2 ]= 622 144 
## mc[ 3 ]= 624 140 
## mc[ 4 ]= 360 126 
## mc[ 5 ]= 360 126 
## mc[ 6 ]= 577 187 
## mc[ 7 ]= 595 121 
## mc[ 8 ]= 595 121 
## mc[ 9 ]= 97 120 
## mc[ 10 ]= 639 121 
## mc[ 11 ]= 639 121 
## mc[ 12 ]= 508 109 
## mc[ 13 ]= 508 109 
## mc[ 14 ]= 466 109 
## mc[ 15 ]= 466 109 
## mc[ 16 ]= 358 106 
## mc[ 17 ]= 358 106 
## mc[ 18 ]= 625 152 
## mc[ 19 ]= 482 133 
## mc[ 20 ]= 365 147 
## mc[ 21 ]= 74 141 
## mc[ 22 ]= 227 123 
## mc[ 23 ]= 227 123 
## mc[ 24 ]= 227 81 
## mc[ 25 ]= 227 81 
## mc[ 26 ]= 226 68 
## mc[ 27 ]= 226 68 
## mc[ 28 ]= 259 62 
## mc[ 29 ]= 259 62 
## mc[ 30 ]= 197 61 
## mc[ 31 ]= 197 61 
##   Info: Area and Contour Length 
##  * Contour[ 1 ] - Area (M_00) =  0  - Area OpenCV:  76  - Length:  673.328</code></pre>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-129-1.png" width="672"></div>
</div>
<div id="point-polygon测试" class="section level2" number="7.14">
<h2>
<span class="header-section-number">7.14</span> Point Polygon测试<a class="anchor" aria-label="anchor" href="#point-polygon%E6%B5%8B%E8%AF%95"><i class="fas fa-link"></i></a>
</h2>
<p>Point Polygon测试指的是测试图像上一个点（像素）是否在给定的多边形内部，边缘或者外部：返回负数时，表明点在多边形外，返回0时，表明点在多边形上，返回正数时，表明点在多边形内。OpenCV在<strong>cv.pointPolygonTest</strong>函数中封装了此操作，该函数的measureDist参数为TRUE时，可以计算并返回点到多边形的最短距离（这里的距离指的是符号距离，即依据点与多边形的位置关系取正取负）。</p>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成黑色图像</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="fl">11</span>,<span class="fl">11</span>,<span class="st">"CV_8UC1"</span><span class="op">)</span></span>
<span><span class="co">#在img上绘制一个白色矩形（该矩形将被识别为一个轮廓）</span></span>
<span><span class="fu">cv_rectangle</span><span class="op">(</span><span class="va">img</span>,<span class="fu">Point</span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fu">Point</span><span class="op">(</span><span class="fl">8</span>,<span class="fl">8</span><span class="op">)</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在img上检测轮廓，结果保存在contours中（只有一个轮廓（点集）：对应于上面绘制的矩形）</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">img</span>,<span class="va">contours</span>,<span class="va">RETR_EXTERNAL</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#测试像素(0,0)与矩形的位置关系</span></span>
<span><span class="fu">cv_pointPolygonTest</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span>,<span class="fu">Point2f</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -1</code></pre>
<div class="sourceCode" id="cb1260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#测试像素(0,1)与矩形的位置关系，并返回最短距离</span></span>
<span><span class="fu">cv_pointPolygonTest</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span>,<span class="fu">Point2f</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -2.236068</code></pre>
<div class="sourceCode" id="cb1262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#计算图像中所有像素与矩形的最短距离，结果保存在distMat中</span></span>
<span><span class="va">distMat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,nr<span class="op">=</span><span class="fl">11</span>,nc<span class="op">=</span><span class="fl">11</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">distMat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu">cv_pointPolygonTest</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span>,<span class="fu">Point2f</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span>,<span class="va">j</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,<span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#查看结果</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">distMat</span>,<span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>##        [,1]  [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]
##  [1,] -2.83 -2.24   -2   -2   -2   -2   -2   -2   -2 -2.24 -2.83
##  [2,] -2.24 -1.41   -1   -1   -1   -1   -1   -1   -1 -1.41 -2.24
##  [3,] -2.00 -1.00    0    0    0    0    0    0    0 -1.00 -2.00
##  [4,] -2.00 -1.00    0    1    1    1    1    1    0 -1.00 -2.00
##  [5,] -2.00 -1.00    0    1    2    2    2    1    0 -1.00 -2.00
##  [6,] -2.00 -1.00    0    1    2    3    2    1    0 -1.00 -2.00
##  [7,] -2.00 -1.00    0    1    2    2    2    1    0 -1.00 -2.00
##  [8,] -2.00 -1.00    0    1    1    1    1    1    0 -1.00 -2.00
##  [9,] -2.00 -1.00    0    0    0    0    0    0    0 -1.00 -2.00
## [10,] -2.24 -1.41   -1   -1   -1   -1   -1   -1   -1 -1.41 -2.24
## [11,] -2.83 -2.24   -2   -2   -2   -2   -2   -2   -2 -2.24 -2.83</code></pre>
<p>可以看到，图像中位于矩形中心的点具有最大正向距离，而图像的边缘点中存在最小负向距离。</p>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">src</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/pointpolygon.png"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">src_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">src</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#使用Canny函数提取边缘，结果保存在edges中</span></span>
<span><span class="va">edges</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">src</span>,<span class="va">edges</span>,<span class="fl">100</span>,<span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># #将src转变为灰度图</span></span>
<span><span class="co"># src_gray_ref = encloseRef(cv.mat.Mat01())</span></span>
<span><span class="co"># cv.cvtColor(src,src_gray_ref,"COLOR_BGR2GRAY")</span></span>
<span><span class="co"># src_gray = uncloseRef(src_gray_ref)</span></span>
<span><span class="co">#在edges中查找轮廓，结果保存在contours中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">edges</span>, <span class="va">contours</span>, <span class="va">RETR_TREE</span>, <span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算图像中所有像素与第1个轮廓所代表的多边形的最短距离，结果保存在distMat中</span></span>
<span><span class="va">distMat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nr <span class="op">=</span> <span class="va">src_info</span><span class="op">$</span><span class="va">height</span>, nc <span class="op">=</span> <span class="va">src_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">distMat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu">cv_pointPolygonTest</span><span class="op">(</span><span class="va">contours</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span>, <span class="fu">Point2f</span><span class="op">(</span><span class="va">j</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#获取distMat中的最小值和最大值</span></span>
<span><span class="va">minVal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">)</span></span>
<span><span class="va">maxVal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">)</span></span>
<span><span class="co">#获取distMat中最大值出现的位置</span></span>
<span><span class="va">maxValLoc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">)</span>,arr.ind <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#依据distMat生成三维数组drawing.arr（数组中的三个矩阵依次表示蓝色、绿色和红色分量）</span></span>
<span><span class="co">#当点在多边形外，越远离多边形，则颜色越暗，越靠近多边形，则颜色越蓝；</span></span>
<span><span class="co">#当点在多边形内，越远离多边形，则颜色越暗，越靠近多边形，则颜色越红；</span></span>
<span><span class="co">#当点在多边形上，则颜色为白色</span></span>
<span><span class="va">drawing_arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">src_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">src_info</span><span class="op">$</span><span class="va">width</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">drawing_arr</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">drawing_arr</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">distMat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">drawing_arr</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">255</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">distMat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="fl">255</span> <span class="op">/</span> <span class="va">minVal</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">distMat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">drawing_arr</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">=</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">255</span> <span class="op">-</span> <span class="va">distMat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="fl">255</span> <span class="op">/</span> <span class="va">maxVal</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">drawing_arr</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span>,<span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">255</span>, <span class="fl">255</span>, <span class="fl">255</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#将drawing.arr转变为图像矩阵drawing</span></span>
<span><span class="va">drawing</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">drawing_arr</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">drawing_arr</span><span class="op">)</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="va">drawing</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">drawing_arr</span><span class="op">)</span></span>
<span><span class="co">#在drawing中以最大距离点为为圆心，最大距离为半径绘制一个灰色的圆</span></span>
<span><span class="fu">cv_circle</span><span class="op">(</span><span class="va">drawing</span>, <span class="fu">Point</span><span class="op">(</span><span class="va">maxValLoc</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">maxValLoc</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">maxVal</span><span class="op">)</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">128</span>, <span class="fl">128</span>, <span class="fl">128</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#显示源图像和Point Polygon测试结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Source"</span>, <span class="va">src</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Distance and inscribed circle"</span>, <span class="va">drawing</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="基于距离变换和分水岭算法的图像分割" class="section level2" number="7.15">
<h2>
<span class="header-section-number">7.15</span> 基于距离变换和分水岭算法的图像分割<a class="anchor" aria-label="anchor" href="#%E5%9F%BA%E4%BA%8E%E8%B7%9D%E7%A6%BB%E5%8F%98%E6%8D%A2%E5%92%8C%E5%88%86%E6%B0%B4%E5%B2%AD%E7%AE%97%E6%B3%95%E7%9A%84%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2"><i class="fas fa-link"></i></a>
</h2>
<p>分水岭算法是一种图像区域分割法，在分割的过程中，它会把跟临近像素间的相似性作为重要的参考依据，从而将在空间位置上相近并且灰度值相近的像素点互相连接起来构成一个封闭的轮廓，封闭性是分水岭算法的一个重要特征。</p>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/catoon.png"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span>                   </span>
<span><span class="co">#将img灰度化，结果保存在img_gray中  </span></span>
<span><span class="va">img_gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_gray</span>,<span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img_gray进行高斯平滑，结果保存在img_gray中</span></span>
<span><span class="fu">cv_GaussianBlur</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">img_gray</span>,<span class="fu">Size</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img_gray进行边缘检测，结果保存在img_canny中</span></span>
<span><span class="va">img_canny</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">img_canny</span>,<span class="fl">80</span>,<span class="fl">150</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img_canny提取轮廓，结果保存在contours和hierarchy中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hierarchy</span> <span class="op">=</span> <span class="fu">stdVecOfVec4i</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">img_canny</span>,<span class="va">contours</span>,<span class="va">hierarchy</span>,</span>
<span>                  <span class="va">RETR_TREE</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span><span class="co"># sapply(1:contours$size()-1,function(i) contours[[i]]$size())</span></span>
<span><span class="co"># sapply(1:contours$size()-1,function(i) hierarchy[[i]][[0]])</span></span>
<span><span class="co">#生成与img相同尺寸的全黑图像imgContours</span></span>
<span><span class="va">imgContours</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="co">#生成与img相同尺寸的全黑图像marks</span></span>
<span><span class="va">marks</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32S</span><span class="op">)</span></span>
<span><span class="co">#index中存放轮廓编号</span></span>
<span><span class="va">index</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="co">#compCount中存放图像分割的区域数量</span></span>
<span><span class="va">compCount</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="kw">while</span><span class="op">(</span><span class="va">index</span><span class="op">&gt;=</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#在marks中绘制编号为index的轮廓，轮廓的线条颜色依赖于compCount的值</span></span>
<span>  <span class="va">ccolor</span> <span class="op">=</span> <span class="fu">Scalar</span><span class="op">(</span><span class="va">compCount</span><span class="op">+</span><span class="fl">1</span>,<span class="va">compCount</span><span class="op">+</span><span class="fl">1</span>,<span class="va">compCount</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">marks</span>,<span class="va">contours</span>,<span class="va">index</span>,<span class="va">ccolor</span>,<span class="fl">1</span>,<span class="fl">8</span>,<span class="va">hierarchy</span><span class="op">)</span></span>
<span>  <span class="co">#在imgContours中绘制编号为index的轮廓，轮廓的线条颜色为白色</span></span>
<span>  <span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">imgContours</span>,<span class="va">contours</span>,<span class="va">index</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">8</span>,<span class="va">hierarchy</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#依据轮廓层次hierarchy，提取出下一个轮廓的编号，存放在index中。</span></span>
<span>  <span class="co">#若index为负数，则表明轮廓遍历结束，循环终止</span></span>
<span>  <span class="va">index</span> <span class="op">=</span> <span class="va">hierarchy</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co">#compCount的值累加1</span></span>
<span>  <span class="va">compCount</span> <span class="op">=</span> <span class="va">compCount</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#对img进行分水岭分割（以marks中的轮廓作为区域分割的初始点），分割结果保存在marks中</span></span>
<span><span class="fu">cv_watershed</span><span class="op">(</span><span class="va">img</span>,<span class="va">marks</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对每一个分割区域进行颜色填充：</span></span>
<span><span class="co">#先将marks转变为R语言的矩阵</span></span>
<span><span class="va">marks_mat</span> <span class="op">=</span> <span class="va">marks</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#再生成与img同尺寸的R语言三维数组perspectiveImg_arr</span></span>
<span><span class="va">perspectiveImg_arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>,dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对于marks_mat取值为-1的点，相应perspectiveImg_arr的点取白色；</span></span>
<span><span class="co">#对于取值不为-1的点，计算相应的颜色值</span></span>
<span><span class="va">pos1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">marks_mat</span><span class="op">==</span><span class="op">-</span><span class="fl">1</span>,arr.ind<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos1</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">255</span></span>
<span><span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos1</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">255</span></span>
<span><span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos1</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">255</span></span>
<span><span class="va">pos2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">marks_mat</span><span class="op">!=</span><span class="op">-</span><span class="fl">1</span>,arr.ind<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> </span>
<span>  <span class="va">marks_mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">255</span></span>
<span><span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> </span>
<span>  <span class="fl">255</span> <span class="op">-</span> <span class="op">(</span><span class="va">marks_mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">255</span><span class="op">)</span></span>
<span><span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> </span>
<span>  <span class="fl">255</span> <span class="op">-</span> <span class="op">(</span><span class="va">marks_mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pos2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">pos2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">255</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将perspectiveImg_arr转变为图像矩阵</span></span>
<span><span class="va">perspectiveImg</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">perspectiveImg_arr</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">perspectiveImg_arr</span><span class="op">)</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="va">perspectiveImg</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">perspectiveImg_arr</span><span class="op">)</span></span>
<span><span class="co">#可以显示经过颜色填充之后的结果</span></span>
<span><span class="co">#cv.imdisplay(perspectiveImg)</span></span>
<span></span>
<span><span class="co">#融合img与perspectiveImg，结果保存在wshed中</span></span>
<span><span class="va">wshed</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_addWeighted</span><span class="op">(</span><span class="va">img</span>,<span class="fl">0.4</span>,<span class="va">perspectiveImg</span>,<span class="fl">0.6</span>,<span class="fl">0</span>,<span class="va">wshed</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示最终结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'res'</span>,<span class="va">wshed</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-133-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/shape1.png"</span><span class="op">)</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span><span class="va">pt</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">img_gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_gray</span>,<span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cv_bitwise_not</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">img_gray</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cv_GaussianBlur</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">img_gray</span>,<span class="fu">Size</span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">cv_threshold</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">img_gray</span>,<span class="fl">120</span>,<span class="fl">200</span>,<span class="va">THRESH_BINARY</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 120</code></pre>
<div class="sourceCode" id="cb1268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'gray'</span>,<span class="va">img_gray</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgThin</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32FC1</span><span class="op">)</span></span>
<span><span class="fu">cv_distanceTransform</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">imgThin</span>,<span class="va">DIST_L2</span>,<span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgThin4show</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgThin</span>,<span class="va">imgThin4show</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'imthin'</span>,<span class="va">imgThin4show</span><span class="op">)</span></span>
<span></span>
<span><span class="va">minVal</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">maxVal</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">minLoc</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">maxLoc</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_minMaxLoc</span><span class="op">(</span><span class="va">imgThin</span>,<span class="va">minVal</span>,<span class="va">maxVal</span>,<span class="va">minLoc</span>,<span class="va">maxLoc</span><span class="op">)</span></span>
<span><span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="va">maxLoc</span>,<span class="va">maxVal</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">cv_circle</span><span class="op">(</span><span class="va">img</span>,<span class="va">maxLoc</span>,<span class="fl">3</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">255</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'img'</span>,<span class="va">img</span><span class="op">)</span></span></code></pre></div>
<p><strong>示例</strong></p>
<p>watershed图像自动分割的实现步骤：</p>
<ol style="list-style-type: decimal">
<li><p>图像灰度化、滤波、Canny边缘检测</p></li>
<li><p>查找轮廓，并且把轮廓信息按照不同的编号绘制到watershed的第二个入参merkers上，相当于标记注水点。</p></li>
<li><p>watershed分水岭运算</p></li>
<li><p>绘制分割出来的区域，视觉控还可以使用随机颜色填充，或者跟原始图像融合以下，以得到更好的显示效果。</p></li>
</ol>
<p>这个示例用于说明分水岭</p>
<p>对如下图像进行区域分割：</p>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-135-1.png" width="672"></div>
<div class="sourceCode" id="cb1269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/desertwater.png"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将img灰度化，结果保存在img_gray中</span></span>
<span><span class="va">img_gray</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">img</span>,<span class="va">img_gray</span>,<span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># #对img.gray进行高斯平滑，结果保存在img.gray中</span></span>
<span><span class="co"># cv.GaussianBlur(img.gray,tmp.ref,c(5,5),2)</span></span>
<span><span class="co"># img.gray = uncloseRef(tmp.ref)</span></span>
<span></span>
<span><span class="co">#对img.gray进行边缘检测，结果保存在img_canny中</span></span>
<span><span class="va">img_canny</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_Canny</span><span class="op">(</span><span class="va">img_gray</span>,<span class="va">img_canny</span>,<span class="fl">80</span>,<span class="fl">150</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#检测img_canny的轮廓，结果保存在contours中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">img_canny</span>,<span class="va">contours</span>,<span class="va">RETR_EXTERNAL</span>,<span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#生成与img相同尺寸的全黑图像marks</span></span>
<span><span class="va">marks</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">img_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32S</span><span class="op">)</span></span>
<span><span class="co">#在marks中绘制轮廓</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#绘制编号为i的轮廓区域，填充颜色为255 - 40*i</span></span>
<span>  <span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">marks</span>, <span class="va">contours</span>, <span class="va">i</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span> <span class="op">-</span> <span class="fl">20</span><span class="op">*</span><span class="va">i</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#可以显示marks结果（CV_32S不能直接显示，需要转换）</span></span>
<span><span class="va">marks4Show</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_convertScaleAbs</span><span class="op">(</span><span class="va">marks</span>,<span class="va">marks4Show</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'show'</span>,<span class="va">marks4Show</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对img进行分水岭区域分割</span></span>
<span><span class="co"># tmp.ref = encloseRef(marks)</span></span>
<span><span class="fu">cv_watershed</span><span class="op">(</span><span class="va">img</span>, <span class="va">marks</span><span class="op">)</span></span>
<span><span class="co"># marks = uncloseRef(tmp.ref)</span></span>
<span></span>
<span><span class="co">#可以显示分水岭算法执行之后的标注变化结果（CV_32S不能直接显示，需要转换）</span></span>
<span><span class="va">afterWarterShed</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_convertScaleAbs</span><span class="op">(</span><span class="va">marks</span>,<span class="va">afterWarterShed</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'shed'</span>,<span class="va">afterWarterShed</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#对每一个分割区域进行颜色填充：</span></span>
<span><span class="co">#先将marks转变为R语言的矩阵</span></span>
<span><span class="va">marks_mat</span> <span class="op">=</span> <span class="va">marks</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#再生成与img同尺寸的R语言三维数组perspectiveImg_arr</span></span>
<span><span class="va">perspectiveImg_arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>,dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">img_info</span><span class="op">$</span><span class="va">width</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#接着生成256个随机颜色</span></span>
<span><span class="va">ccolors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fl">256</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">256</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">255</span>,<span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">ccolors</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Scalar</span><span class="op">(</span><span class="va">tmp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">tmp</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="va">tmp</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#然后通过循环，遍历marks_mat的元素值：</span></span>
<span><span class="co">#对于取值为-1的点，相应perspectiveImg.arr的点取白色；</span></span>
<span><span class="co">#对于取值不为-1的点，检索ccolors中相应的值</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">marks_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">marks_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#获取marks在点[j,i]处的区域编号</span></span>
<span>    <span class="va">index</span> <span class="op">=</span> <span class="va">marks_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">index</span><span class="op">==</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#编号为-1是，取白色</span></span>
<span>      <span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="op">]</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">255</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="co">#依据index检索ccolors中的颜色</span></span>
<span>      <span class="va">value</span> <span class="op">=</span> <span class="va">index</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">255</span> <span class="op">+</span><span class="fl">1</span></span>
<span>      <span class="va">perspectiveImg_arr</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ccolors</span><span class="op">[[</span><span class="va">value</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>,<span class="va">ccolors</span><span class="op">[[</span><span class="va">value</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">ccolors</span><span class="op">[[</span><span class="va">value</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#将perspectiveImg.arr转变为图像矩阵</span></span>
<span><span class="va">perspectiveImg</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">perspectiveImg_arr</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">perspectiveImg_arr</span><span class="op">)</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="va">perspectiveImg</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">perspectiveImg_arr</span><span class="op">)</span></span>
<span><span class="co">#可以显示经过颜色填充之后的结果</span></span>
<span><span class="co">#cv.imdisplay(perspectiveImg)</span></span>
<span></span>
<span><span class="co">#融合img与perspectiveImg，结果保存在wshed中</span></span>
<span><span class="va">wshed</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_addWeighted</span><span class="op">(</span><span class="va">img</span>,<span class="fl">0.4</span>,<span class="va">perspectiveImg</span>,<span class="fl">0.6</span>,<span class="fl">0</span>,<span class="va">wshed</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示最终结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">'shed'</span>,<span class="va">wshed</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-137-1.png" width="672"></div>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/cards.png"</span><span class="op">)</span></span>
<span><span class="co">#获取图像基本信息</span></span>
<span><span class="va">img_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># #可以显示原始图像</span></span>
<span><span class="co"># cv.iminfo("Source Image", img)</span></span>
<span></span>
<span><span class="co">#Change the background from white to black, since that will help later to extract</span></span>
<span><span class="co">#better results during the use of Distance Transform</span></span>
<span><span class="co">#为了在进行距离变换时获得更好的效果，需要将图像中的白色背景变为黑色</span></span>
<span><span class="va">img_arr</span> <span class="op">=</span> <span class="va">img</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">img_arr</span><span class="op">[</span><span class="va">img_arr</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">255</span>, <span class="fl">255</span>, <span class="fl">255</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">img_arr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># #可以显示背景变为黑色之后的结果</span></span>
<span><span class="co"># cv.imshow("Black Background Image", img)</span></span>
<span></span>
<span><span class="co"># Create a kernel that we will use to sharpen our image</span></span>
<span><span class="co">#生成可以获得图像锐化效果的内核</span></span>
<span><span class="va">ker_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,  <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>                  <span class="fl">1</span>,<span class="op">-</span><span class="fl">8</span>, <span class="fl">1</span>,</span>
<span>                  <span class="fl">1</span>,  <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                nr <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                nc <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ker</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span><span class="va">ker</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">ker_mat</span><span class="op">)</span></span>
<span><span class="co"># an approximation of second derivative, a quite strong kernel</span></span>
<span><span class="co"># do the laplacian filtering as it is</span></span>
<span><span class="co"># well, we need to convert everything in something more deeper then CV_8U</span></span>
<span><span class="co"># because the kernel has some negative values,</span></span>
<span><span class="co"># and we can expect in general to have a Laplacian image with negative values</span></span>
<span><span class="co"># BUT a 8bits unsigned int (the one we are working with) can contain values from 0 to 255</span></span>
<span><span class="co"># so the possible negative number will be truncated</span></span>
<span></span>
<span><span class="co">#对img进行锐化，结果保存在imgLaplacian中</span></span>
<span><span class="va">imgLaplacian</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_filter2D</span><span class="op">(</span><span class="va">img</span>, <span class="va">imgLaplacian</span>, <span class="va">CV_32F</span>, <span class="va">ker</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将img的深度转变为CV_32F，转变之后的结果保存在sharp中</span></span>
<span><span class="va">sharp</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">img</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">sharp</span>, <span class="va">CV_32F</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#sharp-imgLaplacian，结果保存在imgResult中</span></span>
<span><span class="va">imgResult</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_subtract</span><span class="op">(</span><span class="va">sharp</span>, <span class="va">imgLaplacian</span>, <span class="va">imgResult</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert back to 8bits gray scale</span></span>
<span><span class="co">#将imgResult和imgLaplacian的深度都转变为CV_8U</span></span>
<span><span class="va">imgResult</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">imgResult</span>, <span class="va">CV_8UC3</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">imgLaplacian</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">imgLaplacian</span>, <span class="va">CV_8UC3</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示imgLaplacian和imgResult</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span> <span class="st">"Laplace Filtered Image"</span>, <span class="va">imgLaplacian</span> <span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"New Sharped Image"</span>, <span class="va">imgResult</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create binary image from source image</span></span>
<span><span class="co">#将imgResult灰度化，结果保存在bw中</span></span>
<span><span class="va">bw</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_cvtColor</span><span class="op">(</span><span class="va">imgResult</span>, <span class="va">bw</span>, <span class="va">COLOR_BGR2GRAY</span><span class="op">)</span></span>
<span><span class="co">#对bw进行二值化，结果仍保存在bw中</span></span>
<span><span class="fu">cv_threshold</span><span class="op">(</span><span class="va">bw</span>, <span class="va">bw</span>, <span class="fl">40</span>, <span class="fl">255</span>, <span class="va">THRESH_BINARY</span> <span class="op">+</span> <span class="va">THRESH_OTSU</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 123</code></pre>
<div class="sourceCode" id="cb1272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#显示bw</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Binary Image"</span>, <span class="va">bw</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Perform the distance transform algorithm</span></span>
<span><span class="co">#对bw进行举例变换，结果保存在ddist中</span></span>
<span><span class="co">#https://www.cnblogs.com/mtcnn/p/9411967.html</span></span>
<span><span class="va">ddist</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_distanceTransform</span><span class="op">(</span><span class="va">bw</span>, <span class="va">ddist</span>, <span class="va">DIST_L2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalize the distance image for range = {0.0, 1.0}</span></span>
<span><span class="co"># so we can visualize and threshold it</span></span>
<span><span class="co">#将ddist归一化（最大最小值法），结果仍保存在ddist中</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">ddist</span>, <span class="va">ddist</span>, <span class="fl">0</span>, <span class="fl">1.0</span>, <span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Distance Transform Image"</span>, <span class="va">ddist</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Threshold to obtain the peaks</span></span>
<span><span class="co"># This will be the markers for the foreground objects</span></span>
<span><span class="co">#对ddist进行二值化（以便形成亮度区域），结果仍保存在ddist中</span></span>
<span><span class="fu">cv_threshold</span><span class="op">(</span><span class="va">ddist</span>, <span class="va">ddist</span>, <span class="fl">0.7</span>, <span class="fl">1.0</span>, <span class="va">THRESH_BINARY</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.7</code></pre>
<div class="sourceCode" id="cb1274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dilate a bit the dist image</span></span>
<span><span class="co">#再对ddist进行膨胀，结果仍然保存在ddist中</span></span>
<span><span class="va">ker1</span> <span class="op">=</span> <span class="fu">Mat_ones</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="va">CV_8U</span><span class="op">)</span></span>
<span><span class="fu">cv_dilate</span><span class="op">(</span><span class="va">ddist</span>, <span class="va">ddist</span>, <span class="va">ker1</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Peaks"</span>, <span class="va">ddist</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the CV_8U version of the distance image</span></span>
<span><span class="co"># It is needed for findContours()</span></span>
<span><span class="va">dist_8u</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ddist</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">dist_8u</span>, <span class="va">CV_8U</span>, <span class="fl">255</span>,<span class="fl">0</span><span class="op">)</span> <span class="co">#留意这里的255，转换之前的图像取值范围是0和1</span></span>
<span></span>
<span><span class="co"># Find total markers</span></span>
<span><span class="co">#在dist_8u中检测轮廓，结果保存在contours中</span></span>
<span><span class="va">contours</span> <span class="op">=</span> <span class="fu">stdVecOfVecOfPoint</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_findContours</span><span class="op">(</span><span class="va">dist_8u</span>, <span class="va">contours</span>, <span class="va">RETR_EXTERNAL</span>, <span class="va">CHAIN_APPROX_SIMPLE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the marker image for the watershed algorithm</span></span>
<span><span class="co">#生成与img相同尺寸的全黑图像marks</span></span>
<span><span class="va">markers</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">img_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">img_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32S</span><span class="op">)</span></span>
<span><span class="co">#在marks中绘制轮廓（形成初始的区域分割标记图）</span></span>
<span><span class="co"># Draw the foreground markers</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">contours</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="fu">cv_drawContours</span><span class="op">(</span><span class="va">markers</span>, <span class="va">contours</span>, <span class="va">i</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#显示初始的区域分割标记图</span></span>
<span><span class="va">mmarker</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">markers</span>,<span class="va">mmarker</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Markers"</span>, <span class="va">mmarker</span><span class="op">)</span></span>
<span><span class="co"># normalized方法会改变图像尺寸么?</span></span>
<span></span>
<span><span class="co"># Perform the watershed algorithm</span></span>
<span><span class="co">#依据初始的区域分割标记对imgResult进行分水岭操作</span></span>
<span><span class="fu">cv_watershed</span><span class="op">(</span><span class="va">imgResult</span>, <span class="va">markers</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#查看分水岭算法后的区域分割标记图</span></span>
<span><span class="va">mmarkers_v2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">markers</span>,<span class="va">mmarkers_v2</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Markers_v2"</span>, <span class="va">mmarkers_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># uncomment this if you want to see how the mark</span></span>
<span><span class="co"># image looks like at that point</span></span>
<span><span class="co"># Generate random colors</span></span>
<span><span class="co"># 生成256个随机颜色</span></span>
<span><span class="va">ccolors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fl">256</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">256</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">ccolors</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Scalar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create the result image</span></span>
<span><span class="co">#为每个区域填充颜色</span></span>
<span><span class="va">markers_mat</span> <span class="op">=</span> <span class="va">markers</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">dst_arr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">markers_mat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">markers_mat</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">markers_mat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">markers_mat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">markers_mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span><span class="op">==</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">dst_arr</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">255</span>,<span class="fl">255</span>,<span class="fl">255</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">index</span> <span class="op">=</span> <span class="va">markers_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">255</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>      <span class="va">dst_arr</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ccolors</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>,<span class="va">ccolors</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">ccolors</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Visualize the final image</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dst_arr</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dst_arr</span><span class="op">)</span>,<span class="va">CV_8UC3</span><span class="op">)</span></span>
<span><span class="va">dst</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">dst_arr</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Final Result"</span>, <span class="va">dst</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="离焦去模糊滤波器" class="section level2" number="7.16">
<h2>
<span class="header-section-number">7.16</span> 离焦去模糊滤波器<a class="anchor" aria-label="anchor" href="#%E7%A6%BB%E7%84%A6%E5%8E%BB%E6%A8%A1%E7%B3%8A%E6%BB%A4%E6%B3%A2%E5%99%A8"><i class="fas fa-link"></i></a>
</h2>
<div id="模糊退化图像" class="section level3" number="7.16.1">
<h3>
<span class="header-section-number">7.16.1</span> 模糊（退化）图像<a class="anchor" aria-label="anchor" href="#%E6%A8%A1%E7%B3%8A%E9%80%80%E5%8C%96%E5%9B%BE%E5%83%8F"><i class="fas fa-link"></i></a>
</h3>
<p>以下是频域表示中图像退化的数学模型：</p>
<p><span class="math display">\[
S=H \cdot U+N
\]</span></p>
<p>其中<span class="math inline">\(S\)</span>是模糊（退化）图像的频谱，<span class="math inline">\(U\)</span>是原始真实（未退化）图像的频谱，<span class="math inline">\(H\)</span>是点扩展函数（PSF: Point Spread Functioin）的频率响应，<span class="math inline">\(N\)</span>是加性噪声的频谱。</p>
<p>圆形PSF能很好逼近离焦失真，这样的PSF只由一个参数半径<span class="math inline">\(R\)</span>指定。</p>
<div class="float">
<img src="images/tutorial/psf.png" alt="Circular point spread function"><div class="figcaption">Circular point spread function</div>
</div>
</div>
<div id="图像去模糊" class="section level3" number="7.16.2">
<h3>
<span class="header-section-number">7.16.2</span> 图像去模糊<a class="anchor" aria-label="anchor" href="#%E5%9B%BE%E5%83%8F%E5%8E%BB%E6%A8%A1%E7%B3%8A"><i class="fas fa-link"></i></a>
</h3>
<p>恢复（去模糊）的目的是获得原始图像的近似结果。频域恢复公式为：</p>
<p><span class="math display">\[
U'=H_w \cdot S
\]</span></p>
<p>其中<span class="math inline">\(U′\)</span>是原始图像<span class="math inline">\(U\)</span>的估计谱，<span class="math inline">\(H_w\)</span>是恢复滤波器（或者去模糊滤波器），例如维纳(Wiener)滤波器。</p>
</div>
<div id="维纳滤波器" class="section level3" number="7.16.3">
<h3>
<span class="header-section-number">7.16.3</span> 维纳滤波器<a class="anchor" aria-label="anchor" href="#%E7%BB%B4%E7%BA%B3%E6%BB%A4%E6%B3%A2%E5%99%A8"><i class="fas fa-link"></i></a>
</h3>
<p>维纳滤波器是一种恢复模糊图像的方法。当PSF是实对称信号，而原始图像和噪声的功率谱未知时，简化的Wiener公式为：</p>
<p><span class="math display">\[
H_w= \frac{H} {|H|^2+\frac{1}{SNR}}
\]</span></p>
<p>其中SNR是信噪比。</p>
<p><strong><em>因此，为了利用维纳滤波恢复离焦图像，需要知道圆PSF的SNR和R。</em></strong></p>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#计算PSF的函数</span></span>
<span><span class="va">calcPSF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">filterSize</span>, <span class="va">R</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#生成全黑图像h</span></span>
<span>  <span class="va">h</span> <span class="op">=</span> <span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">filterSize</span>, <span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="co">#获取h的中心点</span></span>
<span>  <span class="va">p</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="va">filterSize</span><span class="op">$</span><span class="va">width</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">filterSize</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co">#以中心点为圆心，半径为R在h上绘制白色填充圆</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">h</span>, <span class="va">p</span>, <span class="va">R</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="co">#h中各像素值均一化（转化为R语言的矩阵操作）</span></span>
<span>  <span class="va">h_mat</span> <span class="op">=</span> <span class="va">h</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#h.mat = h.mat / summa[1]</span></span>
<span>  <span class="va">h_mat</span> <span class="op">=</span> <span class="va">h_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">h_mat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#将PSF计算结果保存在outputImg.ref输出参数中</span></span>
<span>  <span class="co"># outputImg.ref$name[[1]] = cv.mat.r2cv(h.mat, "CV_32F")</span></span>
<span>  <span class="va">h</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">h_mat</span><span class="op">)</span></span>
<span>  <span class="va">h</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#fftshift函数对离散傅里叶变换的模矩阵进行频谱中心化</span></span>
<span><span class="va">fftshift</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#生成inputImg的克隆体outputImg</span></span>
<span>  <span class="va">outputImg</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#cv.imshow('ori',outputImg)</span></span>
<span>  <span class="co">#获取outputImg的基本信息</span></span>
<span>  <span class="va">outputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">outputImg</span><span class="op">)</span></span>
<span>  <span class="co">#获取outputImg的中心点坐标(cx,cy)</span></span>
<span>  <span class="va">cx</span> <span class="op">=</span> <span class="va">outputImg_info</span><span class="op">$</span><span class="va">width</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>  <span class="va">cy</span> <span class="op">=</span> <span class="va">outputImg_info</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">2</span></span>
<span> </span>
<span>  <span class="co">#将outputImg转化为R语言的矩阵</span></span>
<span>  <span class="va">outputImg_mat</span> <span class="op">=</span> <span class="va">outputImg</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#依据中心点行、列位置为水平轴和竖直轴，将outputImg_mat划分为四个区域</span></span>
<span>  <span class="co">#q1为左上区域</span></span>
<span>  <span class="va">q1</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span></span>
<span>  <span class="co">#q2为左下区域</span></span>
<span>  <span class="va">q2</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span></span>
<span>  <span class="co">#q3为右下区域</span></span>
<span>  <span class="va">q3</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co">#q4为右上区域</span></span>
<span>  <span class="va">q4</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#频谱中心化</span></span>
<span>  <span class="co">#先交换q1与q3</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span> <span class="op">=</span> <span class="va">q3</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">q1</span></span>
<span>  <span class="co">#再交换q2与q4</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">q2</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span> <span class="op">=</span> <span class="va">q4</span></span>
<span></span>
<span>  </span>
<span>  <span class="va">outputImg</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">outputImg_mat</span><span class="op">)</span></span>
<span>  <span class="va">outputImg</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#进行维纳滤波</span></span>
<span><span class="va">filter2DFreq</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span>, <span class="va">H</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#获取inputImg的基本信息</span></span>
<span>  <span class="va">inputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#生成列表planes：</span></span>
<span>  <span class="co">#第1个元素为inputImg的浮点数类型克隆体，</span></span>
<span>  <span class="co">#第2个元素为32位浮点数单通道全0矩阵，尺寸与inputImg相同</span></span>
<span>  <span class="va">planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">inputImg_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">inputImg_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#合并planes包含的两个矩阵，结果保存在complexI中</span></span>
<span>  <span class="va">complexI</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planes</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  <span class="co">#对complexI进行离散傅里叶变换，结果仍保存在complexI中</span></span>
<span>  <span class="fu">cv_dft</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexI</span>, <span class="va">DFT_SCALE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#获取H的基本信息</span></span>
<span>  <span class="va">H_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">H</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#生成列表planesH：</span></span>
<span>  <span class="co">#第1个元素为H的浮点数类型克隆体，</span></span>
<span>  <span class="co">#第2个元素为32位浮点数单通道全0矩阵，尺寸与H相同</span></span>
<span>  <span class="va">planesH</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">H</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">H_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">H_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#合并planesH包含的两个矩阵，结果保存在complexH中</span></span>
<span>  <span class="va">complexH</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planesH</span>, <span class="va">complexH</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#complexI和complexH保留的傅里叶频谱相乘，结果保存在complexIH中</span></span>
<span>  <span class="va">complexIH</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_mulSpectrums</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexH</span>, <span class="va">complexIH</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#对complexIH进行逆离散傅里叶变换，结果仍保存在complexIH中</span></span>
<span>  <span class="fu">cv_idft</span><span class="op">(</span><span class="va">complexIH</span>, <span class="va">complexIH</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#拆分complexIH的通道，结果保存在planes中（planes会包含两个矩阵）</span></span>
<span>  <span class="fu">cv_split</span><span class="op">(</span><span class="va">complexIH</span>, <span class="va">planes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#计算维纳滤波器</span></span>
<span><span class="va">calcWnrFilter</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_h_PSF</span>, <span class="va">nsr</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#离散傅里叶变换频谱标准化，结果保存在h_PSF_shifted中</span></span>
<span>  <span class="va">h_PSF_shifted</span> <span class="op">=</span> <span class="fu">fftshift</span><span class="op">(</span><span class="va">input_h_PSF</span><span class="op">)</span></span>
<span>  <span class="va">h_PSF_shifted_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">h_PSF_shifted</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#生成planes列表：</span></span>
<span>  <span class="co">#第1个元素为h_PSF_shifted的浮点数克隆体，</span></span>
<span>  <span class="co">#第2个元素为浮点数全0矩阵，尺寸与h_PSF_shifted相同</span></span>
<span>  <span class="va">planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">h_PSF_shifted</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">h_PSF_shifted_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">h_PSF_shifted_info</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#合并planes列表中的两个图像矩阵，结果保存在complexI中</span></span>
<span>  <span class="va">complexI</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planes</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#对complexI进行离散傅里叶变换，结果保存在complexI</span></span>
<span>  <span class="fu">cv_dft</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#拆分planes的通道，结果保存在planes中</span></span>
<span>  <span class="fu">cv_split</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">planes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#依据公式计算维纳滤波器hw，结果保存在output_G中</span></span>
<span>  <span class="va">plane1_mat</span> <span class="op">=</span> <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">denorm_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">plane1_mat</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span></span>
<span>  <span class="va">denorm_mat</span> <span class="op">=</span> <span class="va">denorm_mat</span> <span class="op">+</span> <span class="va">nsr</span></span>
<span>  <span class="va">output_G_mat</span> <span class="op">=</span> <span class="va">plane1_mat</span> <span class="op">/</span> <span class="va">denorm_mat</span></span>
<span>  <span class="va">output_G</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">output_G_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">output_G_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">plane1_mat</span>, <span class="st">"type"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output_G</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">output_G_mat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output_G</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#确定计算PSF的圆形光斑半径</span></span>
<span><span class="va">R</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="co">#确定信噪比</span></span>
<span><span class="va">SNR</span> <span class="op">=</span> <span class="fl">150</span></span>
<span><span class="co">#以灰度图模式读取图像文件</span></span>
<span><span class="va">imgIn</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lostfocustext.png"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#缩放图像尺寸，结果保存在imgIn中</span></span>
<span><span class="fu">cv_resize</span><span class="op">(</span><span class="va">imgIn</span>, <span class="va">imgIn</span>, <span class="fu">Size</span><span class="op">(</span><span class="fl">600</span>, <span class="fl">400</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示imgIn</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"ori.jpg"</span>, <span class="va">imgIn</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#获取imgIn的基本信息</span></span>
<span><span class="va">imgIn_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">imgIn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># it needs to process even image only</span></span>
<span><span class="co">#设置img的roi区域（起始是整个图像区域），结果保存在img_roi中</span></span>
<span><span class="va">roi</span> <span class="op">=</span> <span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="va">imgIn_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">imgIn_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="va">img_roi</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">imgIn</span>, <span class="va">roi</span><span class="op">)</span></span>
<span><span class="co"># Hw calculation (start)</span></span>
<span></span>
<span></span>
<span><span class="co">#计算PSF，结果保存在h中</span></span>
<span><span class="va">h</span> <span class="op">=</span> <span class="fu">calcPSF</span><span class="op">(</span><span class="fu">Size</span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">width</span>,<span class="va">roi</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>, <span class="va">R</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算维纳滤波器，结果保存在Hw中</span></span>
<span><span class="va">Hw</span> <span class="op">=</span> <span class="fu">calcWnrFilter</span><span class="op">(</span><span class="va">h</span>, <span class="fl">1.0</span> <span class="op">/</span> <span class="va">SNR</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#应用维纳滤波器，处理结果保存在imgOut中</span></span>
<span><span class="va">imgOut</span> <span class="op">=</span> <span class="fu">filter2DFreq</span><span class="op">(</span><span class="va">img_roi</span>,<span class="va">Hw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将imgOut转变为8位无浮点数类型</span></span>
<span><span class="va">imgOut</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">imgOut</span>,<span class="va">CV_8U</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">imgOut</span>,<span class="st">"cpptype"</span><span class="op">)</span> <span class="op">=</span> <span class="st">"cvMat"</span></span>
<span></span>
<span><span class="co">#将imgOut的像素值映射到[0,255]区间</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgOut</span>, <span class="va">imgOut</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"result.jpg"</span>, <span class="va">imgOut</span><span class="op">)</span></span></code></pre></div>
<p><img src="07-imgproc1_files/figure-html/unnamed-chunk-140-1.png" width="672"><img src="07-imgproc1_files/figure-html/unnamed-chunk-140-2.png" width="672"></p>
</div>
</div>
<div id="运动去模糊滤波器" class="section level2" number="7.17">
<h2>
<span class="header-section-number">7.17</span> 运动去模糊滤波器<a class="anchor" aria-label="anchor" href="#%E8%BF%90%E5%8A%A8%E5%8E%BB%E6%A8%A1%E7%B3%8A%E6%BB%A4%E6%B3%A2%E5%99%A8"><i class="fas fa-link"></i></a>
</h2>
<p>运动模糊是我们在日常生活中很常见的一种模糊。当按下快门拍照时，如果照片里的事物（或者相机本身）正在运动的话，那么拍出的照片就会产生运动模糊。</p>
<div id="生成运动模糊" class="section level3" number="7.17.1">
<h3>
<span class="header-section-number">7.17.1</span> 生成运动模糊<a class="anchor" aria-label="anchor" href="#%E7%94%9F%E6%88%90%E8%BF%90%E5%8A%A8%E6%A8%A1%E7%B3%8A"><i class="fas fa-link"></i></a>
</h3>
<p>通过<strong>filter2D</strong>函数在时域上生成运动模糊：</p>
<p>横向右移模糊：</p>
<div class="sourceCode" id="cb1276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按灰度模式读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co">#生成内核矩阵（1行24列）</span></span>
<span><span class="va">kernel</span> <span class="op">=</span> <span class="fu">Mat_ones</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">24</span>,<span class="va">CV_32F</span><span class="op">)</span><span class="op">/</span><span class="fl">24</span></span>
<span><span class="co">#利用kernel对img进行滤波，结果保留在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_filter2D</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="op">-</span><span class="fl">1</span>,<span class="va">kernel</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-144-1.png" width="672"></div>
<p>纵向下移模糊：</p>
<div class="sourceCode" id="cb1277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按灰度模式读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co">#生成内核矩阵（24行1列）</span></span>
<span><span class="va">kernel</span> <span class="op">=</span> <span class="fu">Mat_ones</span><span class="op">(</span><span class="fl">24</span>,<span class="fl">1</span>,<span class="va">CV_32F</span><span class="op">)</span><span class="op">/</span><span class="fl">24</span></span>
<span><span class="co">#利用kernel对img进行滤波，结果保留在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_filter2D</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="op">-</span><span class="fl">1</span>,<span class="va">kernel</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-147-1.png" width="672"></div>
<p>右下角45度移动模糊：</p>
<div class="sourceCode" id="cb1278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#按灰度模式读取图像文件</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lena.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co">#生成内核矩阵（24行24列对角阵）</span></span>
<span><span class="va">M</span> <span class="op">=</span> <span class="fu">Mat_ones</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">24</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span><span class="va">kernel</span> <span class="op">=</span> <span class="fu">Mat_diag</span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">/</span><span class="fl">24</span></span>
<span><span class="co">#利用kernel对img进行滤波，结果保留在dst中</span></span>
<span><span class="va">dst</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_filter2D</span><span class="op">(</span><span class="va">img</span>,<span class="va">dst</span>,<span class="op">-</span><span class="fl">1</span>,<span class="va">kernel</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="07-imgproc1_files/figure-html/unnamed-chunk-150-1.png" width="672"></div>
</div>
<div id="运动模糊图像的psf" class="section level3" number="7.17.2">
<h3>
<span class="header-section-number">7.17.2</span> 运动模糊图像的PSF<a class="anchor" aria-label="anchor" href="#%E8%BF%90%E5%8A%A8%E6%A8%A1%E7%B3%8A%E5%9B%BE%E5%83%8F%E7%9A%84psf"><i class="fas fa-link"></i></a>
</h3>
<p>线性运动模糊失真的点扩展函数（PSF）是一个线段。这种PSF由两个参数指定：LEN是模糊的长度，THETA是运动的角度。</p>
<div class="float">
<img src="images/tutorial/motion_psf.png" alt="Point spread function of a linear motion blur distortion"><div class="figcaption">Point spread function of a linear motion blur distortion</div>
</div>
<p><strong>示例</strong></p>
<p><a href="https://zhuanlan.zhihu.com/p/55051514" class="uri">https://zhuanlan.zhihu.com/p/55051514</a></p>
<div class="sourceCode" id="cb1279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#计算PSF的函数</span></span>
<span><span class="va">calcPSF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">filterSize</span>, <span class="va">len</span>, <span class="va">theta</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#生成全黑图像h</span></span>
<span>  <span class="va">h</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">filterSize</span>, <span class="va">CV_32F</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#获取h的中心点</span></span>
<span>  <span class="va">p</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="va">filterSize</span><span class="op">$</span><span class="va">width</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">filterSize</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co">#在h上绘制椭圆，体现出运动模糊的方向和速度（线条长度）</span></span>
<span>  <span class="fu">cv_ellipse</span><span class="op">(</span><span class="va">h</span>, <span class="va">p</span>, <span class="fu">Size</span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">len</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">90</span><span class="op">-</span><span class="va">theta</span>,<span class="fl">0</span>,<span class="fl">360</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="co">#h中各像素值均一化（转化为R语言的矩阵操作）</span></span>
<span>  <span class="va">h_mat</span> <span class="op">=</span> <span class="va">h</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">h_mat</span> <span class="op">=</span> <span class="va">h_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">h_mat</span><span class="op">)</span></span>
<span>  <span class="co"># cv.imdisplay(h)</span></span>
<span>  <span class="co">#将PSF计算结果保存在outputImg输出参数中</span></span>
<span>  <span class="va">outputImg</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">h_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">h_mat</span><span class="op">)</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">outputImg</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">h_mat</span><span class="op">)</span></span>
<span>  <span class="va">outputImg</span></span>
<span><span class="op">}</span></span>
<span><span class="va">fftshift</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#生成inputImg的克隆体outputImg</span></span>
<span>  <span class="va">outputImg</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#cv.imshow('ori',outputImg)</span></span>
<span>  <span class="co">#获取outputImg的基本信息</span></span>
<span>  <span class="va">outputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">outputImg</span><span class="op">)</span></span>
<span>  <span class="co">#获取outputImg的中心点坐标(cx,cy)</span></span>
<span>  <span class="va">cx</span> <span class="op">=</span> <span class="va">outputImg_info</span><span class="op">$</span><span class="va">width</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>  <span class="va">cy</span> <span class="op">=</span> <span class="va">outputImg_info</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">2</span></span>
<span> </span>
<span>  <span class="co">#将outputImg转化为R语言的矩阵</span></span>
<span>  <span class="va">outputImg_mat</span> <span class="op">=</span> <span class="va">outputImg</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#依据中心点行、列位置为水平轴和竖直轴，将outputImg.mat划分为四个区域</span></span>
<span>  <span class="co">#q1为左上区域</span></span>
<span>  <span class="va">q1</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span></span>
<span>  <span class="co">#q2为左下区域</span></span>
<span>  <span class="va">q2</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span></span>
<span>  <span class="co">#q3为右下区域</span></span>
<span>  <span class="va">q3</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co">#q4为右上区域</span></span>
<span>  <span class="va">q4</span> <span class="op">=</span> <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#频谱中心化</span></span>
<span>  <span class="co">#先交换q1与q3</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span> <span class="op">=</span> <span class="va">q3</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">q1</span></span>
<span>  <span class="co">#再交换q2与q4</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">cy</span>,<span class="op">(</span><span class="va">cx</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cx</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">q2</span></span>
<span>  <span class="va">outputImg_mat</span><span class="op">[</span><span class="op">(</span><span class="va">cy</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">cy</span><span class="op">)</span>,<span class="fl">1</span><span class="op">:</span><span class="va">cx</span><span class="op">]</span> <span class="op">=</span> <span class="va">q4</span></span>
<span></span>
<span>  <span class="co"># outputImg = Mat(nrow(outputImg_mat),ncol(outputImg_mat),as.numeric(attr(outputImg_mat,"type")))</span></span>
<span>  <span class="va">outputImg</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">outputImg_mat</span><span class="op">)</span></span>
<span>  <span class="va">outputImg</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#进行维纳滤波</span></span>
<span><span class="va">filter2DFreq</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span>, <span class="va">H</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#获取inputImg的基本信息</span></span>
<span>  <span class="va">inputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#生成列表planes：</span></span>
<span>  <span class="co">#第1个元素为inputImg的浮点数类型克隆体，</span></span>
<span>  <span class="co">#第2个元素为32位浮点数单通道全0矩阵，尺寸与inputImg相同</span></span>
<span>  <span class="va">planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">inputImg_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">inputImg_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#合并planes包含的两个矩阵，结果保存在complexI中</span></span>
<span>  <span class="va">complexI</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planes</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  <span class="co">#对complexI进行离散傅里叶变换，结果仍保存在complexI中</span></span>
<span>  <span class="fu">cv_dft</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexI</span>, <span class="va">DFT_SCALE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#获取H的基本信息</span></span>
<span>  <span class="va">H_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">H</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#生成列表planesH：</span></span>
<span>  <span class="co">#第1个元素为H的浮点数类型克隆体，</span></span>
<span>  <span class="co">#第2个元素为32位浮点数单通道全0矩阵，尺寸与H相同</span></span>
<span>  <span class="va">planesH</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">H</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">H_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">H_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#合并planesH包含的两个矩阵，结果保存在complexH中</span></span>
<span>  <span class="va">complexH</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planesH</span>, <span class="va">complexH</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#complexI和complexH保留的傅里叶频谱相乘，结果保存在complexIH中</span></span>
<span>  <span class="va">complexIH</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_mulSpectrums</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexH</span>, <span class="va">complexIH</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#对complexIH进行逆离散傅里叶变换，结果仍保存在complexIH中</span></span>
<span>  <span class="fu">cv_idft</span><span class="op">(</span><span class="va">complexIH</span>, <span class="va">complexIH</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#拆分complexIH的通道，结果保存在planes中（planes会包含两个矩阵）</span></span>
<span>  <span class="fu">cv_split</span><span class="op">(</span><span class="va">complexIH</span>, <span class="va">planes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#将planes的第一个矩阵保存在输出参数outputImg.ref中</span></span>
<span>  <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#计算维纳滤波器</span></span>
<span><span class="va">calcWnrFilter</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_h_PSF</span>, <span class="va">nsr</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#离散傅里叶变换频谱标准化，结果保存在h_PSF_shifted中</span></span>
<span>  <span class="va">h_PSF_shifted</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">h_PSF_shifted</span> <span class="op">=</span> <span class="fu">fftshift</span><span class="op">(</span><span class="va">input_h_PSF</span><span class="op">)</span></span>
<span>  <span class="va">h_PSF_shifted_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">h_PSF_shifted</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#生成planes列表：</span></span>
<span>  <span class="co">#第1个元素为h_PSF_shifted的浮点数克隆体，</span></span>
<span>  <span class="co">#第2个元素为浮点数全0矩阵，尺寸与h_PSF_shifted相同</span></span>
<span>  <span class="va">planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">h_PSF_shifted</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">h_PSF_shifted_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">h_PSF_shifted_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#合并planes列表中的两个图像矩阵，结果保存在complexI中</span></span>
<span>  <span class="va">complexI</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planes</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#对complexI进行离散傅里叶变换，结果保存在complexI</span></span>
<span>  <span class="fu">cv_dft</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#拆分planes的通道，结果保存在planes中</span></span>
<span>  <span class="fu">cv_split</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">planes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#依据公式计算维纳滤波器hw，结果保存在output_G中</span></span>
<span>  <span class="va">plane1_mat</span> <span class="op">=</span> <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">denorm_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">plane1_mat</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span></span>
<span>  <span class="va">denorm_mat</span> <span class="op">=</span> <span class="va">denorm_mat</span> <span class="op">+</span> <span class="va">nsr</span></span>
<span>  <span class="va">output_G_mat</span> <span class="op">=</span> <span class="va">plane1_mat</span> <span class="op">/</span> <span class="va">denorm_mat</span></span>
<span>  <span class="va">output_G</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">output_G_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">output_G_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">plane1_mat</span>, <span class="st">"type"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output_G</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">output_G_mat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output_G</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ocv_getEvenNum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/strtoi.html">strtoi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">intToBits</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">intToBits</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span>,base<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#设定PSF的长度（即速度）</span></span>
<span><span class="va">LEN</span> <span class="op">=</span> <span class="fl">24</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#设定PSF的方向，水平取0，垂直取90，右下方45度取-45</span></span>
<span><span class="va">THETA</span> <span class="op">=</span> <span class="op">-</span><span class="fl">45</span></span>
<span><span class="co">#设定信噪比</span></span>
<span><span class="va">snr</span> <span class="op">=</span> <span class="fl">45</span></span>
<span></span>
<span><span class="co">#读取图像文件</span></span>
<span><span class="va">imgIn</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/lenamotionblur_45.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co">#显示原图片</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"ori"</span>,<span class="va">imgIn</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#获取图片基本信息</span></span>
<span><span class="va">imgIn_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">imgIn</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#在imgIn设定感兴趣区域，保存在imgIn_roi中</span></span>
<span><span class="va">roi</span> <span class="op">=</span> <span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fu">ocv_getEvenNum</span><span class="op">(</span><span class="va">imgIn_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>,<span class="fu">ocv_getEvenNum</span><span class="op">(</span><span class="va">imgIn_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">imgIn_roi</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">imgIn</span>,<span class="va">roi</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算PSF，结果保存在h中</span></span>
<span><span class="va">h</span> <span class="op">=</span> <span class="fu">calcPSF</span><span class="op">(</span><span class="fu">Size</span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">width</span>,<span class="va">roi</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>,<span class="va">LEN</span>,<span class="va">THETA</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#计算维纳滤波器，结果保存在Hw中</span></span>
<span><span class="va">Hw</span> <span class="op">=</span> <span class="fu">calcWnrFilter</span><span class="op">(</span><span class="va">h</span>,<span class="fl">1</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#应用维纳滤波器，结果保存在imgOut中</span></span>
<span><span class="va">imgOut</span> <span class="op">=</span> <span class="fu">filter2DFreq</span><span class="op">(</span><span class="va">imgIn_roi</span>,<span class="va">Hw</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#将imgOut转变为8位无浮点数类型</span></span>
<span><span class="va">imgOut</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">imgOut</span>,<span class="va">CV_8U</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">imgOut</span>,<span class="st">"cpptype"</span><span class="op">)</span> <span class="op">=</span> <span class="st">"cvMat"</span></span>
<span></span>
<span><span class="co">#将imgOut的像素值映射到[0,255]区间</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgOut</span>,<span class="va">imgOut</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#显示结果</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"result"</span>,<span class="va">imgOut</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="基于梯度结构张量的各向异性图像分割" class="section level2" number="7.18">
<h2>
<span class="header-section-number">7.18</span> 基于梯度结构张量的各向异性图像分割<a class="anchor" aria-label="anchor" href="#%E5%9F%BA%E4%BA%8E%E6%A2%AF%E5%BA%A6%E7%BB%93%E6%9E%84%E5%BC%A0%E9%87%8F%E7%9A%84%E5%90%84%E5%90%91%E5%BC%82%E6%80%A7%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2"><i class="fas fa-link"></i></a>
</h2>
<p>在数学中，梯度结构张量（也称为二阶矩矩阵、二阶矩张量、惯性张量等）是由函数的梯度导出的矩阵。它体现了在一个点的指定邻域中梯度的主要方向，以及这些方向的相干程度（相干性）。梯度结构张量广泛应用于图像处理和计算机视觉中，用于二维/三维图像分割、运动检测、自适应滤波、局部图像特征检测等。</p>
<p>各向异性图像的重要特征包括局部各向异性的方向性和相干性。本文将介绍如何估计方向和相干度，以及如何用梯度结构张量分割具有单个局部方向的各向异性图像。</p>
<p>图像的梯度结构张量是一个2x2对称矩阵。梯度结构张量的特征向量表示局部方向，而特征值则表示相干（一种各向异性的度量）。</p>
<p>图像Z的梯度结构张量J可以写成：</p>
<p><span class="math display">\[
J = \left[ \begin{matrix} J_{11}&amp;J_{12} \\ J_{12}&amp;J_{22} \end{matrix} \right]
\]</span></p>
<p>其中：<span class="math inline">\(J_{11}=M[Z_x^2]\)</span>，<span class="math inline">\(J_{22}=M[Z_y^2]\)</span>，<span class="math inline">\(J_{12}=M[Z_xZ_y]\)</span></p>
<p>M[]是数学期望的符号（我们可以将此操作视为窗口w中的平均值），Zx和Zy是图像Z相对于x和y的偏导数。M[]是数学期望的符号（我们可以将此操作视为窗口w中的平均值），Zx和Zy是图像Z相对于x和y的偏导数。</p>
<p>张量的特征值可以在下面的公式中找到：</p>
<p><span class="math display">\[
\lambda_{1,2}=J_{11}+J_{22} \pm \sqrt {(J_{11}-J_{22})^2+4J_{12}^2}
\]</span></p>
<p>其中，<span class="math inline">\(λ_1\)</span>-最大特征值，<span class="math inline">\(λ_2\)</span>-最小特征值。</p>
<p>如何利用梯度结构张量估计各向异性图像的方向性和相干性？</p>
<p>各向异性图像的方向：</p>
<p><span class="math display">\[
\alpha = 0.5 arctg \frac{2J_{12}}{J_{22}-J_{11}}
\]</span></p>
<p>相干性：</p>
<p><span class="math display">\[
C = \frac{\lambda_1-\lambda_2}{\lambda_1+\lambda_2}
\]</span></p>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#计算梯度结构张量函数</span></span>
<span><span class="va">calcGST</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span>,<span class="va">w</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">#将inputImg转变为32位浮点数类型，结果保存在img中</span></span>
<span>  <span class="va">img</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">inputImg</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">img</span>, <span class="va">CV_32F</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#GST components calculation (start)</span></span>
<span>  <span class="co">#J =  (J11 J12; J12 J22) - GST</span></span>
<span>  <span class="va">imgDiffX</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_Sobel</span><span class="op">(</span><span class="va">img</span>, <span class="va">imgDiffX</span>, <span class="va">CV_32F</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">imgDiffY</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_Sobel</span><span class="op">(</span><span class="va">img</span>, <span class="va">imgDiffY</span>, <span class="va">CV_32F</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">imgDiffXY</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_multiply</span><span class="op">(</span><span class="va">imgDiffX</span>, <span class="va">imgDiffY</span>, <span class="va">imgDiffXY</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">imgDiffXX</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_multiply</span><span class="op">(</span><span class="va">imgDiffX</span>, <span class="va">imgDiffX</span>, <span class="va">imgDiffXX</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">imgDiffYY</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_multiply</span><span class="op">(</span><span class="va">imgDiffY</span>, <span class="va">imgDiffY</span>, <span class="va">imgDiffYY</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#GST components: J11</span></span>
<span>  <span class="va">J11</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_boxFilter</span><span class="op">(</span><span class="va">imgDiffXX</span>, <span class="va">J11</span>, <span class="va">CV_32F</span>, <span class="fu">Size</span><span class="op">(</span><span class="va">w</span>, <span class="va">w</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#GST components: J22</span></span>
<span>  <span class="va">J22</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_boxFilter</span><span class="op">(</span><span class="va">imgDiffYY</span>, <span class="va">J22</span>, <span class="va">CV_32F</span>, <span class="fu">Size</span><span class="op">(</span><span class="va">w</span>, <span class="va">w</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#GST components: J12</span></span>
<span>  <span class="va">J12</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_boxFilter</span><span class="op">(</span><span class="va">imgDiffXY</span>, <span class="va">J12</span>, <span class="va">CV_32F</span>, <span class="fu">Size</span><span class="op">(</span><span class="va">w</span>, <span class="va">w</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># GST components calculation (stop)</span></span>
<span>  </span>
<span>  <span class="co"># eigenvalue calculation (start)</span></span>
<span>  <span class="co"># lambda1 = J11 + J22 + sqrt((J11-J22)^2 + 4*J12^2)</span></span>
<span>  <span class="co"># lambda2 = J11 + J22 - sqrt((J11-J22)^2 + 4*J12^2)</span></span>
<span>  <span class="va">tmp1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_add</span><span class="op">(</span><span class="va">J11</span>, <span class="va">J22</span>, <span class="va">tmp1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">tmp2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_subtract</span><span class="op">(</span><span class="va">J11</span>, <span class="va">J22</span>, <span class="va">tmp2</span><span class="op">)</span></span>
<span>  <span class="fu">cv_multiply</span><span class="op">(</span><span class="va">tmp2</span>, <span class="va">tmp2</span>, <span class="va">tmp2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">tmp3</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_multiply</span><span class="op">(</span><span class="va">J12</span>, <span class="va">J12</span>, <span class="va">tmp3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">tmp4</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_scaleAdd</span><span class="op">(</span><span class="va">tmp3</span>, <span class="fl">4.0</span>, <span class="va">tmp2</span>, <span class="va">tmp4</span><span class="op">)</span></span>
<span>  <span class="fu">cv_sqrt</span><span class="op">(</span><span class="va">tmp4</span>, <span class="va">tmp4</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">lambda1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span> <span class="co"># biggest eigenvalue</span></span>
<span>  <span class="fu">cv_addWeighted</span><span class="op">(</span><span class="va">tmp1</span>, <span class="fl">0.5</span>, <span class="va">tmp4</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="va">lambda1</span><span class="op">)</span></span>
<span>  <span class="va">lambda2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span>  <span class="co"># smallest eigenvalue</span></span>
<span>  <span class="fu">cv_addWeighted</span><span class="op">(</span><span class="va">tmp1</span>,<span class="fl">0.5</span>, <span class="va">tmp4</span>,<span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0</span>, <span class="va">lambda2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># eigenvalue calculation (stop)</span></span>
<span>  <span class="co"># Coherency calculation (start)</span></span>
<span>  <span class="co"># Coherency = (lambda1 - lambda2)/(lambda1 + lambda2)) - measure of anisotropism</span></span>
<span>  <span class="co"># Coherency is anisotropy degree (consistency of local orientation)</span></span>
<span>  <span class="va">lambda1Minus2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">lambda1Plus2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_subtract</span><span class="op">(</span><span class="va">lambda1</span>, <span class="va">lambda2</span>, <span class="va">lambda1Minus2</span><span class="op">)</span></span>
<span>  <span class="fu">cv_add</span><span class="op">(</span><span class="va">lambda1</span>, <span class="va">lambda2</span>, <span class="va">lambda1Plus2</span><span class="op">)</span></span>
<span>  <span class="va">imgCoherencyOut</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_divide</span><span class="op">(</span><span class="va">lambda1Minus2</span>, <span class="va">lambda1Plus2</span>, <span class="va">imgCoherencyOut</span><span class="op">)</span></span>
<span>  <span class="co"># Coherency calculation (stop)</span></span>
<span>  <span class="co"># orientation angle calculation (start)</span></span>
<span>  <span class="co"># tan(2*Alpha) = 2*J12/(J22 - J11)</span></span>
<span>  <span class="co"># Alpha = 0.5 atan2(2*J12/(J22 - J11))</span></span>
<span>  <span class="va">J22Minus11</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">J12Scale2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_subtract</span><span class="op">(</span><span class="va">J22</span>, <span class="va">J11</span>, <span class="va">J22Minus11</span><span class="op">)</span></span>
<span>  <span class="va">J12</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">J12Scale2</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">imgOrientationOut</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_phase</span><span class="op">(</span><span class="va">J22Minus11</span>, <span class="va">J12Scale2</span>, <span class="va">imgOrientationOut</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">cv_addWeighted</span><span class="op">(</span><span class="va">imgOrientationOut</span>,<span class="fl">0.5</span>,<span class="va">imgOrientationOut</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="va">imgOrientationOut</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">imgCoherencyOut</span>,<span class="va">imgOrientationOut</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">W</span> <span class="op">=</span> <span class="fl">52</span>            <span class="co"># window size is WxW</span></span>
<span><span class="va">C_Thr</span> <span class="op">=</span> <span class="fl">0.43</span>    <span class="co"># threshold for coherency</span></span>
<span><span class="va">LowThr</span> <span class="op">=</span> <span class="fl">35</span>        <span class="co"># threshold1 for orientation, it ranges from 0 to 180</span></span>
<span><span class="va">HighThr</span> <span class="op">=</span> <span class="fl">57</span>       <span class="co"># threshold2 for orientation, it ranges from 0 to 180</span></span>
<span><span class="co"># imgCoherency.ref = encloseRef(cv.mat.Mat01())</span></span>
<span><span class="co"># imgOrientation.ref = encloseRef(cv.mat.Mat01())</span></span>
<span><span class="va">imgIn</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/gst_input.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="co"># res = calcGST(imgIn, imgCoherency.ref, imgOrientation.ref, W)</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu">calcGST</span><span class="op">(</span><span class="va">imgIn</span>, <span class="va">W</span><span class="op">)</span></span>
<span><span class="va">imgCoherency</span> <span class="op">=</span> <span class="va">res</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">imgOrientation</span> <span class="op">=</span> <span class="va">res</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">imgCoherency_mat</span> <span class="op">=</span> <span class="va">imgCoherency</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgCoherencyBin_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">imgCoherency_mat</span> <span class="op">&gt;</span> <span class="va">C_Thr</span><span class="op">)</span> <span class="op">*</span> <span class="fl">255</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">imgCoherencyBin_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">imgCoherency_mat</span><span class="op">)</span></span>
<span><span class="va">imgCoherencyBin</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">imgCoherencyBin_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">imgCoherencyBin_mat</span><span class="op">)</span>,<span class="va">CV_8UC1</span><span class="op">)</span></span>
<span><span class="va">imgCoherencyBin</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">imgCoherencyBin_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgOrientationBin</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_inRange</span><span class="op">(</span><span class="va">imgOrientation</span>,</span>
<span>           <span class="fu">Scalar</span><span class="op">(</span><span class="va">LowThr</span><span class="op">)</span>,</span>
<span>           <span class="fu">Scalar</span><span class="op">(</span><span class="va">HighThr</span><span class="op">)</span>,</span>
<span>           <span class="va">imgOrientationBin</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgBin</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_bitwise_and</span><span class="op">(</span><span class="va">imgCoherencyBin</span>,<span class="va">imgOrientationBin</span>,<span class="va">imgBin</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgCoherency</span>, <span class="va">imgCoherency</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgOrientation</span>, <span class="va">imgOrientation</span>, <span class="fl">0</span>, <span class="fl">255</span>, <span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cv_addWeighted</span><span class="op">(</span><span class="va">imgIn</span>, <span class="fl">0.5</span>, <span class="va">imgBin</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="va">result</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"result"</span>, <span class="va">result</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Coherency"</span>, <span class="va">imgCoherency</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"Orientation"</span>, <span class="va">imgOrientation</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="周期去噪滤波器" class="section level2" number="7.19">
<h2>
<span class="header-section-number">7.19</span> 周期去噪滤波器<a class="anchor" aria-label="anchor" href="#%E5%91%A8%E6%9C%9F%E5%8E%BB%E5%99%AA%E6%BB%A4%E6%B3%A2%E5%99%A8"><i class="fas fa-link"></i></a>
</h2>
<p><strong>示例</strong></p>
<div class="sourceCode" id="cb1281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fftshift</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>    <span class="va">outputImg</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">outputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">outputImg</span><span class="op">)</span></span>
<span>    <span class="va">cx</span> <span class="op">=</span> <span class="va">outputImg_info</span><span class="op">$</span><span class="va">width</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>    <span class="va">cy</span> <span class="op">=</span> <span class="va">outputImg_info</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>    <span class="va">q0</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">outputImg</span>, <span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="va">cx</span>, <span class="va">cy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">q1</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">outputImg</span>, <span class="fu">Rect</span><span class="op">(</span><span class="va">cx</span>, <span class="fl">0</span>, <span class="va">cx</span>, <span class="va">cy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">q2</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">outputImg</span>, <span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>, <span class="va">cy</span>, <span class="va">cx</span>, <span class="va">cy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">q3</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">outputImg</span>, <span class="fu">Rect</span><span class="op">(</span><span class="va">cx</span>, <span class="va">cy</span>, <span class="va">cx</span>, <span class="va">cy</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">tmp</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">q0</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span>    <span class="va">q3</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">q0</span><span class="op">)</span></span>
<span>    <span class="va">tmp</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">q3</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">q1</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span>    <span class="va">q2</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">q1</span><span class="op">)</span></span>
<span>    <span class="va">tmp</span><span class="op">$</span><span class="fu">copyTo</span><span class="op">(</span><span class="va">q2</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">outputImg</span></span>
<span><span class="op">}</span></span>
<span><span class="va">filter2DFreq</span> <span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span>, <span class="va">H</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">inputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">inputImg_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">inputImg_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">complexI</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planes</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  <span class="fu">cv_dft</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexI</span>, <span class="va">DFT_SCALE</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">H_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">H</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">H</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planesH</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">H_info</span><span class="op">$</span><span class="va">height</span>, <span class="va">H_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">complexH</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planesH</span>, <span class="va">complexH</span><span class="op">)</span></span>
<span>  <span class="va">complexIH</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_mulSpectrums</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexH</span>, <span class="va">complexIH</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">cv_idft</span><span class="op">(</span><span class="va">complexIH</span>, <span class="va">complexIH</span><span class="op">)</span></span>
<span>  <span class="fu">cv_split</span><span class="op">(</span><span class="va">complexIH</span>, <span class="va">planes</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">synthesizeFilterH</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputOutput_H</span>, <span class="va">center</span>, <span class="va">radius</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co"># inputOutput_H = inputOutput_H.ref$name[[1]]</span></span>
<span>  <span class="va">inputOutput_H_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">inputOutput_H</span><span class="op">)</span></span>
<span>  <span class="va">c2</span> <span class="op">=</span> <span class="va">center</span></span>
<span>  <span class="va">c3</span> <span class="op">=</span> <span class="va">center</span></span>
<span>  <span class="va">c4</span> <span class="op">=</span> <span class="va">center</span></span>
<span>  <span class="va">c2</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="va">inputOutput_H_info</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span> <span class="va">center</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">c3</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="va">inputOutput_H_info</span><span class="op">$</span><span class="va">width</span> <span class="op">-</span> <span class="va">center</span><span class="op">$</span><span class="va">x</span></span>
<span>  <span class="va">c4</span> <span class="op">=</span> <span class="fu">Point</span><span class="op">(</span><span class="va">c3</span><span class="op">$</span><span class="va">x</span>,<span class="va">c2</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">inputOutput_H</span>, <span class="va">center</span>, <span class="va">radius</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">inputOutput_H</span>, <span class="va">c2</span>, <span class="va">radius</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">inputOutput_H</span>, <span class="va">c3</span>, <span class="va">radius</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="fu">cv_circle</span><span class="op">(</span><span class="va">inputOutput_H</span>, <span class="va">c4</span>, <span class="va">radius</span>, <span class="fu">Scalar</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># inputOutput_H.ref$name[[1]] = inputOutput_H</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Function calculates PSD(Power spectrum density) by fft with two flags</span></span>
<span><span class="co"># flag = 0 means to return PSD</span></span>
<span><span class="co"># flag = 1 means to return log(PSD)</span></span>
<span><span class="va">calcPSD</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputImg</span>, <span class="va">outputImg.ref</span>, <span class="va">flag</span><span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">inputImg_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">inputImg</span><span class="op">)</span></span>
<span>  <span class="va">planes</span> <span class="op">=</span> <span class="fu">stdVecOfMat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span> <span class="op">=</span> <span class="va">inputImg</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">m1</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">m1</span>,<span class="va">CV_32F</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">$</span><span class="fu">push_back</span><span class="op">(</span><span class="fu">Mat_zeros</span><span class="op">(</span><span class="va">inputImg_info</span><span class="op">$</span><span class="va">height</span>,<span class="va">inputImg_info</span><span class="op">$</span><span class="va">width</span>, <span class="va">CV_32F</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">complexI</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_merge</span><span class="op">(</span><span class="va">planes</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  <span class="fu">cv_dft</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">complexI</span><span class="op">)</span></span>
<span>  <span class="va">planes.ref</span> <span class="op">=</span> <span class="fu">encloseRef</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">cv_split</span><span class="op">(</span><span class="va">complexI</span>, <span class="va">planes</span><span class="op">)</span>            </span>
<span>  <span class="va">planes1_mat</span> <span class="op">=</span> <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">planes2_mat</span> <span class="op">=</span> <span class="va">planes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">planes1_mat</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="va">planes2_mat</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">planes1_mat</span><span class="op">)</span></span>
<span>  <span class="va">planes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">planes2_mat</span><span class="op">)</span></span>
<span>  <span class="co"># compute the PSD = sqrt(Re(DFT(I))^2 + Im(DFT(I))^2)^2</span></span>
<span>  <span class="va">imgPSD</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">cv_magnitude</span><span class="op">(</span><span class="va">planes</span><span class="op">[[</span><span class="fl">0</span><span class="op">]</span><span class="op">]</span>, <span class="va">planes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">imgPSD</span><span class="op">)</span>        <span class="co">#imgPSD = sqrt(Power spectrum density)</span></span>
<span>  <span class="fu">cv_pow</span><span class="op">(</span><span class="va">imgPSD</span>, <span class="fl">2</span>, <span class="va">imgPSD</span><span class="op">)</span>                         <span class="co">#it needs ^2 in order to get PSD</span></span>
<span>  <span class="va">imgPSD_mat</span> <span class="op">=</span> <span class="va">imgPSD</span><span class="op">$</span><span class="fu">cv2r</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">imgPSD_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">imgPSD_mat</span>,<span class="st">"type"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">flag</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">imgPSD_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">imgPSD_mat</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">outputImg</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">imgPSD_mat</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">imgPSD_mat</span><span class="op">)</span>,<span class="va">imgPSD_type</span><span class="op">)</span></span>
<span>  <span class="va">outputImg</span><span class="op">$</span><span class="fu">r2cv</span><span class="op">(</span><span class="va">imgPSD_mat</span><span class="op">)</span></span>
<span>  <span class="va">outputImg</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">imgIn</span> <span class="op">=</span> <span class="fu">cv_imread</span><span class="op">(</span><span class="st">"images/period_input1.jpg"</span>,<span class="va">IMREAD_GRAYSCALE</span><span class="op">)</span></span>
<span><span class="va">imgIn</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">imgIn</span>,<span class="va">CV_32F</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgIn_info</span> <span class="op">=</span> <span class="fu">rcv_matInfo</span><span class="op">(</span><span class="va">imgIn</span><span class="op">)</span></span>
<span><span class="va">newRows</span> <span class="op">=</span> <span class="fu">ocv_getEvenNum</span><span class="op">(</span><span class="va">imgIn_info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="va">newCols</span> <span class="op">=</span> <span class="fu">ocv_getEvenNum</span><span class="op">(</span><span class="va">imgIn_info</span><span class="op">$</span><span class="va">width</span><span class="op">)</span></span>
<span><span class="va">roi</span> <span class="op">=</span> <span class="fu">Rect</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="va">newCols</span>,<span class="va">newRows</span><span class="op">)</span></span>
<span><span class="va">imgIn</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">imgIn</span>,<span class="va">roi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgPSD</span> <span class="op">=</span> <span class="fu">calcPSD</span><span class="op">(</span><span class="va">imgIn</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">imgPSD</span> <span class="op">=</span> <span class="fu">fftshift</span><span class="op">(</span><span class="va">imgPSD</span><span class="op">)</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgPSD</span>,<span class="va">imgPSD</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span>,<span class="va">CV_8U</span><span class="op">)</span></span>
<span></span>
<span><span class="va">H</span> <span class="op">=</span> <span class="fu">Mat</span><span class="op">(</span><span class="va">roi</span><span class="op">$</span><span class="va">height</span>,<span class="va">roi</span><span class="op">$</span><span class="va">width</span>,<span class="va">CV_32F</span>,<span class="fu">Scalar</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fl">21</span></span>
<span><span class="fu">synthesizeFilterH</span><span class="op">(</span><span class="va">H</span>,<span class="fu">Point</span><span class="op">(</span><span class="fl">143</span>,<span class="fl">67</span><span class="op">)</span>,<span class="va">r</span><span class="op">)</span></span>
<span><span class="fu">synthesizeFilterH</span><span class="op">(</span><span class="va">H</span>,<span class="fu">Point</span><span class="op">(</span><span class="fl">286</span>,<span class="fl">0</span><span class="op">)</span>,<span class="va">r</span><span class="op">)</span></span>
<span><span class="fu">synthesizeFilterH</span><span class="op">(</span><span class="va">H</span>,<span class="fu">Point</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">135</span><span class="op">)</span>,<span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgOut</span> <span class="op">=</span> <span class="fu">filter2DFreq</span><span class="op">(</span><span class="va">imgIn</span>,<span class="va">H</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imgOut</span><span class="op">$</span><span class="fu">convertTo</span><span class="op">(</span><span class="va">imgOut</span>,<span class="va">CV_8U</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">imgOut</span>,<span class="st">"cpptype"</span><span class="op">)</span> <span class="op">=</span> <span class="st">"cvMat"</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">imgOut</span>,<span class="va">imgOut</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"result"</span>,<span class="va">imgOut</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"PSD"</span>,<span class="va">imgPSD</span><span class="op">)</span></span>
<span><span class="fu">cv_normalize</span><span class="op">(</span><span class="va">H</span>,<span class="va">H</span>,<span class="fl">0</span>,<span class="fl">255</span>,<span class="va">NORM_MINMAX</span><span class="op">)</span></span>
<span><span class="fu">cv_imshow</span><span class="op">(</span><span class="st">"filter"</span>,<span class="va">H</span><span class="op">)</span></span></code></pre></div>
<p><img src="07-imgproc1_files/figure-html/unnamed-chunk-154-1.png" width="672"><img src="07-imgproc1_files/figure-html/unnamed-chunk-154-2.png" width="672"></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86imgproc%E6%A8%A1%E5%9D%97-part1.html"><span class="header-section-number">6</span> 图像处理（imgproc模块-PART1）</a></div>
<div class="next"><a href="%E6%91%84%E5%83%8F%E6%9C%BA%E6%A0%87%E5%AE%9A%E5%92%8C%E4%B8%89%E7%BB%B4%E9%87%8D%E5%BB%BAcalib3d%E6%A8%A1%E5%9D%97.html"><span class="header-section-number">8</span> 摄像机标定和三维重建（calib3d模块）</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86imgproc%E6%A8%A1%E5%9D%97-part2"><span class="header-section-number">7</span> 图像处理（imgproc模块-PART2）</a></li>
<li><a class="nav-link" href="#%E9%9C%8D%E5%A4%AB%E7%9B%B4%E7%BA%BF%E5%8F%98%E6%8D%A2"><span class="header-section-number">7.1</span> 霍夫直线变换</a></li>
<li><a class="nav-link" href="#%E9%9C%8D%E5%A4%AB%E5%9C%86%E5%8F%98%E6%8D%A2"><span class="header-section-number">7.2</span> 霍夫圆变换</a></li>
<li><a class="nav-link" href="#%E9%87%8D%E6%98%A0%E5%B0%84"><span class="header-section-number">7.3</span> 重映射</a></li>
<li><a class="nav-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E8%AE%A1%E7%AE%97"><span class="header-section-number">7.4</span> 直方图计算</a></li>
<li><a class="nav-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E5%9D%87%E8%A1%A1%E5%8C%96"><span class="header-section-number">7.5</span> 直方图均衡化</a></li>
<li><a class="nav-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E6%AF%94%E8%BE%83"><span class="header-section-number">7.6</span> 直方图比较</a></li>
<li>
<a class="nav-link" href="#%E5%8F%8D%E5%90%91%E6%8A%95%E5%BD%B1"><span class="header-section-number">7.7</span> 反向投影</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%8D%95%E9%80%9A%E9%81%93%E5%9B%BE%E5%83%8F%E5%9F%BA%E4%BA%8E%E5%8D%95%E9%80%9A%E9%81%93%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%8F%8D%E5%90%91%E6%8A%95%E5%BD%B1"><span class="header-section-number">7.7.1</span> 单通道图像基于单通道直方图的反向投影</a></li>
<li><a class="nav-link" href="#%E4%B8%89%E9%80%9A%E9%81%93%E5%9B%BE%E5%83%8F%E5%9F%BA%E4%BA%8E%E5%8F%8C%E9%80%9A%E9%81%93%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%8F%8D%E5%90%91%E6%8A%95%E5%BD%B1"><span class="header-section-number">7.7.2</span> 三通道图像基于双通道直方图的反向投影</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%8C%B9%E9%85%8D"><span class="header-section-number">7.8</span> 模板匹配</a></li>
<li><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E8%BD%AE%E5%BB%93"><span class="header-section-number">7.9</span> 查找轮廓</a></li>
<li><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%8C%85%E5%90%AB%E5%87%B8%E9%9B%86%E5%87%B8%E5%8C%85"><span class="header-section-number">7.10</span> 计算最小包含凸集（凸包）</a></li>
<li><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%8C%85%E5%90%AB%E7%9F%A9%E5%BD%A2%E5%9C%86%E5%BD%A2%E6%88%96%E8%80%85%E4%B8%89%E8%A7%92%E5%BD%A2"><span class="header-section-number">7.11</span> 计算最小包含矩形、圆形或者三角形</a></li>
<li><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%8C%85%E5%90%AB%E6%97%8B%E8%BD%AC%E7%9F%A9%E5%BD%A2%E6%88%96%E8%80%85%E6%A4%AD%E5%9C%86"><span class="header-section-number">7.12</span> 计算最小包含旋转矩形或者椭圆</a></li>
<li><a class="nav-link" href="#%E5%9B%BE%E5%83%8F%E7%9A%84%E7%9F%A9"><span class="header-section-number">7.13</span> 图像的矩</a></li>
<li><a class="nav-link" href="#point-polygon%E6%B5%8B%E8%AF%95"><span class="header-section-number">7.14</span> Point Polygon测试</a></li>
<li><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%B7%9D%E7%A6%BB%E5%8F%98%E6%8D%A2%E5%92%8C%E5%88%86%E6%B0%B4%E5%B2%AD%E7%AE%97%E6%B3%95%E7%9A%84%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2"><span class="header-section-number">7.15</span> 基于距离变换和分水岭算法的图像分割</a></li>
<li>
<a class="nav-link" href="#%E7%A6%BB%E7%84%A6%E5%8E%BB%E6%A8%A1%E7%B3%8A%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="header-section-number">7.16</span> 离焦去模糊滤波器</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E6%A8%A1%E7%B3%8A%E9%80%80%E5%8C%96%E5%9B%BE%E5%83%8F"><span class="header-section-number">7.16.1</span> 模糊（退化）图像</a></li>
<li><a class="nav-link" href="#%E5%9B%BE%E5%83%8F%E5%8E%BB%E6%A8%A1%E7%B3%8A"><span class="header-section-number">7.16.2</span> 图像去模糊</a></li>
<li><a class="nav-link" href="#%E7%BB%B4%E7%BA%B3%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="header-section-number">7.16.3</span> 维纳滤波器</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E8%BF%90%E5%8A%A8%E5%8E%BB%E6%A8%A1%E7%B3%8A%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="header-section-number">7.17</span> 运动去模糊滤波器</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E7%94%9F%E6%88%90%E8%BF%90%E5%8A%A8%E6%A8%A1%E7%B3%8A"><span class="header-section-number">7.17.1</span> 生成运动模糊</a></li>
<li><a class="nav-link" href="#%E8%BF%90%E5%8A%A8%E6%A8%A1%E7%B3%8A%E5%9B%BE%E5%83%8F%E7%9A%84psf"><span class="header-section-number">7.17.2</span> 运动模糊图像的PSF</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%A2%AF%E5%BA%A6%E7%BB%93%E6%9E%84%E5%BC%A0%E9%87%8F%E7%9A%84%E5%90%84%E5%90%91%E5%BC%82%E6%80%A7%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2"><span class="header-section-number">7.18</span> 基于梯度结构张量的各向异性图像分割</a></li>
<li><a class="nav-link" href="#%E5%91%A8%E6%9C%9F%E5%8E%BB%E5%99%AA%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="header-section-number">7.19</span> 周期去噪滤波器</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/Judy-ZQ/ROpenCV-Tutorial/blob/master/07-imgproc1.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/Judy-ZQ/ROpenCV-Tutorial/edit/master/07-imgproc1.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>ROpenCV — R与OpenCV之间的桥梁</strong>" was written by zpy. It was last built on 2024-11-02.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
